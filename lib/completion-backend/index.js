"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const FZ = require("fuzzaldrin");
const atom_1 = require("atom");
const buffer_info_1 = require("./buffer-info");
const module_info_1 = require("./module-info");
const Util = require("../util");
const { handleException } = Util;
class CompletionBackend {
    constructor(process, upi) {
        this.process = process;
        this.upi = upi;
        this.bufferMap = new WeakMap();
        this.dirMap = new WeakMap();
        this.modListMap = new WeakMap();
        this.languagePragmas = new WeakMap();
        this.compilerOptions = new WeakMap();
        this.name = this.name.bind(this);
        this.onDidDestroy = this.onDidDestroy.bind(this);
        this.registerCompletionBuffer = this.registerCompletionBuffer.bind(this);
        this.unregisterCompletionBuffer = this.unregisterCompletionBuffer.bind(this);
        this.getCompletionsForSymbol = this.getCompletionsForSymbol.bind(this);
        this.getCompletionsForType = this.getCompletionsForType.bind(this);
        this.getCompletionsForClass = this.getCompletionsForClass.bind(this);
        this.getCompletionsForModule = this.getCompletionsForModule.bind(this);
        this.getCompletionsForSymbolInModule = this.getCompletionsForSymbolInModule.bind(this);
        this.getCompletionsForLanguagePragmas = this.getCompletionsForLanguagePragmas.bind(this);
        this.getCompletionsForCompilerOptions = this.getCompletionsForCompilerOptions.bind(this);
        this.getCompletionsForHole = this.getCompletionsForHole.bind(this);
        this.process = process;
        this.isActive = true;
        this.process.onDidDestroy(() => {
            this.isActive = false;
        });
    }
    name() {
        return 'haskell-ghc-mod';
    }
    onDidDestroy(callback) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        return this.process.onDidDestroy(callback);
    }
    registerCompletionBuffer(buffer) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        if (this.bufferMap.has(buffer)) {
            return new atom_1.Disposable(() => {
            });
        }
        const { bufferInfo } = this.getBufferInfo({ buffer });
        setImmediate(async () => {
            const { rootDir, moduleMap } = await this.getModuleMap({ bufferInfo });
            this.getModuleInfo({ bufferInfo, rootDir, moduleMap });
            const imports = await bufferInfo.getImports();
            for (const imprt of imports) {
                this.getModuleInfo({
                    moduleName: imprt.name,
                    bufferInfo,
                    rootDir,
                    moduleMap,
                });
            }
        });
        return new atom_1.Disposable(() => this.unregisterCompletionBuffer(buffer));
    }
    unregisterCompletionBuffer(buffer) {
        const x = this.bufferMap.get(buffer);
        if (x) {
            x.destroy();
        }
    }
    async getCompletionsForSymbol(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getSymbolsForBuffer(buffer);
        return this.filter(symbols, prefix, ['qname', 'qparent']);
    }
    async getCompletionsForType(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getSymbolsForBuffer(buffer, ['type', 'class']);
        return FZ.filter(symbols, prefix, { key: 'qname' });
    }
    async getCompletionsForClass(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getSymbolsForBuffer(buffer, ['class']);
        return FZ.filter(symbols, prefix, { key: 'qname' });
    }
    async getCompletionsForModule(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const rootDir = await this.process.getRootDir(buffer);
        let modules = this.modListMap.get(rootDir);
        if (!modules) {
            modules = await this.process.runList(buffer);
            this.modListMap.set(rootDir, modules);
            setTimeout(() => this.modListMap.delete(rootDir), 60 * 1000);
        }
        return FZ.filter(modules, prefix);
    }
    async getCompletionsForSymbolInModule(buffer, prefix, position, opts) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        let moduleName = opts ? opts.module : undefined;
        if (!moduleName) {
            const lineRange = new atom_1.Range([0, position.row], position);
            buffer.backwardsScanInRange(/^import\s+([\w.]+)/, lineRange, ({ match }) => (moduleName = match[1]));
        }
        const { bufferInfo } = this.getBufferInfo({ buffer });
        const mis = await this.getModuleInfo({ bufferInfo, moduleName });
        const symbols = await mis.moduleInfo.select({
            qualified: false,
            hiding: false,
            name: moduleName || mis.moduleName,
            importList: null,
            alias: null,
        }, undefined, true);
        return FZ.filter(symbols, prefix, { key: 'name' });
    }
    async getCompletionsForLanguagePragmas(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const dir = await this.process.getRootDir(buffer);
        let ps = this.languagePragmas.get(dir);
        if (!ps) {
            ps = await this.process.runLang(dir);
            ps && this.languagePragmas.set(dir, ps);
        }
        return FZ.filter(ps, prefix);
    }
    async getCompletionsForCompilerOptions(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const dir = await this.process.getRootDir(buffer);
        let co = this.compilerOptions.get(dir);
        if (!co) {
            co = await this.process.runFlag(dir);
            this.compilerOptions.set(dir, co);
        }
        return FZ.filter(co, prefix);
    }
    async getCompletionsForHole(buffer, prefix, position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const range = new atom_1.Range(position, position);
        if (prefix.startsWith('_')) {
            prefix = prefix.slice(1);
        }
        const { type } = await this.process.getTypeInBuffer(buffer, range);
        const symbols = await this.getSymbolsForBuffer(buffer);
        const ts = symbols.filter((s) => {
            if (!s.typeSignature) {
                return false;
            }
            const tl = s.typeSignature.split(' -> ').slice(-1)[0];
            if (tl.match(/^[a-z]$/)) {
                return false;
            }
            const ts2 = tl.replace(/[.?*+^$[\]\\(){}|-]/g, '\\$&');
            const rx = RegExp(ts2.replace(/\b[a-z]\b/g, '.+'), '');
            return rx.test(type);
        });
        if (prefix.length === 0) {
            return ts.sort((a, b) => FZ.score(b.typeSignature, type) - FZ.score(a.typeSignature, type));
        }
        else {
            return FZ.filter(ts, prefix, { key: 'qname' });
        }
    }
    async getSymbolsForBuffer(buffer, symbolTypes) {
        const { bufferInfo } = this.getBufferInfo({ buffer });
        const { rootDir, moduleMap } = await this.getModuleMap({ bufferInfo });
        if (bufferInfo && moduleMap) {
            const imports = await bufferInfo.getImports();
            const promises = await Promise.all(imports.map(async (imp) => {
                const res = await this.getModuleInfo({
                    bufferInfo,
                    moduleName: imp.name,
                    rootDir,
                    moduleMap,
                });
                if (!res) {
                    return [];
                }
                return res.moduleInfo.select(imp, symbolTypes);
            }));
            return [].concat(...promises);
        }
        else {
            return [];
        }
    }
    getBufferInfo({ buffer, }) {
        let bi = this.bufferMap.get(buffer);
        if (!bi) {
            bi = new buffer_info_1.BufferInfo(buffer);
            this.bufferMap.set(buffer, bi);
        }
        return { bufferInfo: bi };
    }
    async getModuleMap({ bufferInfo, rootDir, }) {
        if (!rootDir) {
            rootDir = await this.process.getRootDir(bufferInfo.buffer);
        }
        let mm = this.dirMap.get(rootDir);
        if (!mm) {
            mm = new Map();
            this.dirMap.set(rootDir, mm);
        }
        return {
            rootDir,
            moduleMap: mm,
        };
    }
    async getModuleInfo(arg) {
        const { bufferInfo } = arg;
        let dat;
        if (arg.rootDir && arg.moduleMap) {
            dat = { rootDir: arg.rootDir, moduleMap: arg.moduleMap };
        }
        else {
            dat = await this.getModuleMap({ bufferInfo });
        }
        const { moduleMap, rootDir } = dat;
        let moduleName = arg.moduleName;
        if (!moduleName) {
            moduleName = await bufferInfo.getModuleName();
        }
        if (!moduleName) {
            throw new Error(`Nameless module in ${bufferInfo.buffer.getUri()}`);
        }
        let moduleInfo = moduleMap.get(moduleName);
        if (!moduleInfo) {
            moduleInfo = new module_info_1.ModuleInfo(moduleName, this.process, rootDir);
            moduleMap.set(moduleName, moduleInfo);
            const mn = moduleName;
            moduleInfo.onDidDestroy(() => {
                moduleMap.delete(mn);
                Util.debug(`${moduleName} removed from map`);
            });
        }
        await moduleInfo.setBuffer(bufferInfo);
        return { bufferInfo, rootDir, moduleMap, moduleInfo, moduleName };
    }
    filter(candidates, prefix, keys) {
        if (!prefix) {
            return candidates;
        }
        const list = [];
        for (const candidate of candidates) {
            const scores = keys.map((key) => {
                const ck = candidate[key];
                if (ck) {
                    return FZ.score(ck.toString(), prefix);
                }
                else {
                    return 0;
                }
            });
            const score = Math.max(...scores);
            if (score > 0) {
                list.push({
                    score,
                    scoreN: scores.indexOf(score),
                    data: candidate,
                });
            }
        }
        return list
            .sort((a, b) => {
            const s = b.score - a.score;
            if (s === 0) {
                return a.scoreN - b.scoreN;
            }
            return s;
        })
            .map(({ data }) => data);
    }
}
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [atom_1.TextBuffer, String, atom_1.Point]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForSymbol", null);
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [atom_1.TextBuffer, String, atom_1.Point]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForType", null);
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [atom_1.TextBuffer, String, atom_1.Point]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForHole", null);
exports.CompletionBackend = CompletionBackend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tcGxldGlvbi1iYWNrZW5kL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUFnQztBQUNoQywrQkFBc0U7QUFDdEUsK0NBQTBDO0FBQzFDLCtDQUEwQztBQUUxQyxnQ0FBK0I7QUFJL0IsTUFBTSxFQUFFLGVBQWUsRUFBRSxHQUFHLElBQUksQ0FBQTtBQUVoQyxNQUFhLGlCQUFpQjtJQVE1QixZQUNVLE9BQXVCLEVBQ3hCLEdBQThCO1FBRDdCLFlBQU8sR0FBUCxPQUFPLENBQWdCO1FBQ3hCLFFBQUcsR0FBSCxHQUFHLENBQTJCO1FBRXJDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUM5QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFDM0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBQy9CLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUNwQyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFHcEMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNoQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2hELElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3hFLElBQUksQ0FBQywwQkFBMEIsR0FBRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzVFLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3RFLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2xFLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3BFLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3RFLElBQUksQ0FBQywrQkFBK0IsR0FBRyxJQUFJLENBQUMsK0JBQStCLENBQUMsSUFBSSxDQUM5RSxJQUFJLENBQ0wsQ0FBQTtRQUNELElBQUksQ0FBQyxnQ0FBZ0MsR0FBRyxJQUFJLENBQUMsZ0NBQWdDLENBQUMsSUFBSSxDQUNoRixJQUFJLENBQ0wsQ0FBQTtRQUNELElBQUksQ0FBQyxnQ0FBZ0MsR0FBRyxJQUFJLENBQUMsZ0NBQWdDLENBQUMsSUFBSSxDQUNoRixJQUFJLENBQ0wsQ0FBQTtRQUNELElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRWxFLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO1FBQ3RCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFBO1FBQ3BCLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRTtZQUM3QixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQTtRQUN2QixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFVTSxJQUFJO1FBQ1QsT0FBTyxpQkFBaUIsQ0FBQTtJQUMxQixDQUFDO0lBUU0sWUFBWSxDQUFDLFFBQW9CO1FBQ3RDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtTQUNwQztRQUNELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDNUMsQ0FBQztJQVdNLHdCQUF3QixDQUFDLE1BQWtCO1FBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtTQUNwQztRQUVELElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDOUIsT0FBTyxJQUFJLGlCQUFVLENBQUMsR0FBRyxFQUFFO1lBRTNCLENBQUMsQ0FBQyxDQUFBO1NBQ0g7UUFFRCxNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUE7UUFFckQsWUFBWSxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ3RCLE1BQU0sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQTtZQUd0RSxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFBO1lBRXRELE1BQU0sT0FBTyxHQUFHLE1BQU0sVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFBO1lBQzdDLEtBQUssTUFBTSxLQUFLLElBQUksT0FBTyxFQUFFO2dCQUUzQixJQUFJLENBQUMsYUFBYSxDQUFDO29CQUNqQixVQUFVLEVBQUUsS0FBSyxDQUFDLElBQUk7b0JBQ3RCLFVBQVU7b0JBQ1YsT0FBTztvQkFDUCxTQUFTO2lCQUNWLENBQUMsQ0FBQTthQUNIO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFFRixPQUFPLElBQUksaUJBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtJQUN0RSxDQUFDO0lBTU0sMEJBQTBCLENBQUMsTUFBa0I7UUFDbEQsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDcEMsSUFBSSxDQUFDLEVBQUU7WUFDTCxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUE7U0FDWjtJQUNILENBQUM7SUF1Qk0sS0FBSyxDQUFDLHVCQUF1QixDQUNsQyxNQUFrQixFQUNsQixNQUFjLEVBQ2QsU0FBZ0I7UUFFaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1NBQ3BDO1FBRUQsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDdEQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQTtJQUMzRCxDQUFDO0lBYU0sS0FBSyxDQUFDLHFCQUFxQixDQUNoQyxNQUFrQixFQUNsQixNQUFjLEVBQ2QsU0FBZ0I7UUFFaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1NBQ3BDO1FBRUQsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUE7UUFDekUsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQTtJQUNyRCxDQUFDO0lBWU0sS0FBSyxDQUFDLHNCQUFzQixDQUNqQyxNQUFrQixFQUNsQixNQUFjLEVBQ2QsU0FBZ0I7UUFFaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1NBQ3BDO1FBRUQsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTtRQUNqRSxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFBO0lBQ3JELENBQUM7SUFXTSxLQUFLLENBQUMsdUJBQXVCLENBQ2xDLE1BQWtCLEVBQ2xCLE1BQWMsRUFDZCxTQUFnQjtRQUVoQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUE7U0FDcEM7UUFDRCxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3JELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQzFDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUM1QyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUE7WUFFckMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQTtTQUM3RDtRQUNELE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDbkMsQ0FBQztJQWtCTSxLQUFLLENBQUMsK0JBQStCLENBQzFDLE1BQWtCLEVBQ2xCLE1BQWMsRUFDZCxRQUFlLEVBQ2YsSUFBeUI7UUFFekIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1NBQ3BDO1FBQ0QsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUE7UUFDL0MsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNmLE1BQU0sU0FBUyxHQUFHLElBQUksWUFBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQTtZQUN4RCxNQUFNLENBQUMsb0JBQW9CLENBQ3pCLG9CQUFvQixFQUNwQixTQUFTLEVBQ1QsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDdkMsQ0FBQTtTQUNGO1FBRUQsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFBO1FBQ3JELE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFBO1FBR2hFLE1BQU0sT0FBTyxHQUFHLE1BQU0sR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQ3pDO1lBQ0UsU0FBUyxFQUFFLEtBQUs7WUFDaEIsTUFBTSxFQUFFLEtBQUs7WUFDYixJQUFJLEVBQUUsVUFBVSxJQUFJLEdBQUcsQ0FBQyxVQUFVO1lBQ2xDLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLEtBQUssRUFBRSxJQUFJO1NBQ1osRUFDRCxTQUFTLEVBQ1QsSUFBSSxDQUNMLENBQUE7UUFFRCxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFBO0lBQ3BELENBQUM7SUFXTSxLQUFLLENBQUMsZ0NBQWdDLENBQzNDLE1BQWtCLEVBQ2xCLE1BQWMsRUFDZCxTQUFnQjtRQUVoQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUE7U0FDcEM7UUFFRCxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRWpELElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ3RDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUCxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUNwQyxFQUFFLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1NBQ3hDO1FBQ0QsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUM5QixDQUFDO0lBV00sS0FBSyxDQUFDLGdDQUFnQyxDQUMzQyxNQUFrQixFQUNsQixNQUFjLEVBQ2QsU0FBZ0I7UUFFaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1NBQ3BDO1FBRUQsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUVqRCxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUN0QyxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ1AsRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDcEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1NBQ2xDO1FBQ0QsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUM5QixDQUFDO0lBZU0sS0FBSyxDQUFDLHFCQUFxQixDQUNoQyxNQUFrQixFQUNsQixNQUFjLEVBQ2QsUUFBZTtRQUVmLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtTQUNwQztRQUNELE1BQU0sS0FBSyxHQUFHLElBQUksWUFBSyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUMzQyxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDMUIsTUFBTSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7U0FDekI7UUFDRCxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDbEUsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDdEQsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQzlCLElBQUksQ0FBQyxDQUFDLENBQUMsYUFBYSxFQUFFO2dCQUNwQixPQUFPLEtBQUssQ0FBQTthQUNiO1lBQ0QsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDckQsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUN2QixPQUFPLEtBQUssQ0FBQTthQUNiO1lBQ0QsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxNQUFNLENBQUMsQ0FBQTtZQUN0RCxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDdEQsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3RCLENBQUMsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUN2QixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQ1osQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FFUCxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxhQUFjLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsYUFBYyxFQUFFLElBQUksQ0FBQyxDQUN0RSxDQUFBO1NBQ0Y7YUFBTTtZQUNMLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUE7U0FDL0M7SUFDSCxDQUFDO0lBRU8sS0FBSyxDQUFDLG1CQUFtQixDQUMvQixNQUFrQixFQUNsQixXQUE2QjtRQUU3QixNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUE7UUFDckQsTUFBTSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFBO1FBQ3RFLElBQUksVUFBVSxJQUFJLFNBQVMsRUFBRTtZQUMzQixNQUFNLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQyxVQUFVLEVBQUUsQ0FBQTtZQUM3QyxNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQ2hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFO2dCQUN4QixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUM7b0JBQ25DLFVBQVU7b0JBQ1YsVUFBVSxFQUFFLEdBQUcsQ0FBQyxJQUFJO29CQUNwQixPQUFPO29CQUNQLFNBQVM7aUJBQ1YsQ0FBQyxDQUFBO2dCQUNGLElBQUksQ0FBQyxHQUFHLEVBQUU7b0JBQ1IsT0FBTyxFQUFFLENBQUE7aUJBQ1Y7Z0JBQ0QsT0FBTyxHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUE7WUFDaEQsQ0FBQyxDQUFDLENBQ0gsQ0FBQTtZQUNELE9BQVEsRUFBeUIsQ0FBQyxNQUFNLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQTtTQUN0RDthQUFNO1lBQ0wsT0FBTyxFQUFFLENBQUE7U0FDVjtJQUNILENBQUM7SUFFTyxhQUFhLENBQUMsRUFDcEIsTUFBTSxHQUdQO1FBQ0MsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDbkMsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNQLEVBQUUsR0FBRyxJQUFJLHdCQUFVLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDM0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1NBQy9CO1FBQ0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsQ0FBQTtJQUMzQixDQUFDO0lBRU8sS0FBSyxDQUFDLFlBQVksQ0FBQyxFQUN6QixVQUFVLEVBQ1YsT0FBTyxHQUlSO1FBQ0MsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtTQUMzRDtRQUNELElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2pDLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUCxFQUFFLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtZQUNkLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQTtTQUM3QjtRQUVELE9BQU87WUFDTCxPQUFPO1lBQ1AsU0FBUyxFQUFFLEVBQUU7U0FDZCxDQUFBO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxhQUFhLENBQUMsR0FLM0I7UUFDQyxNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsR0FBRyxDQUFBO1FBQzFCLElBQUksR0FBRyxDQUFBO1FBQ1AsSUFBSSxHQUFHLENBQUMsT0FBTyxJQUFJLEdBQUcsQ0FBQyxTQUFTLEVBQUU7WUFDaEMsR0FBRyxHQUFHLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQTtTQUN6RDthQUFNO1lBQ0wsR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUE7U0FDOUM7UUFDRCxNQUFNLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxHQUFHLEdBQUcsQ0FBQTtRQUNsQyxJQUFJLFVBQVUsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFBO1FBQy9CLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixVQUFVLEdBQUcsTUFBTSxVQUFVLENBQUMsYUFBYSxFQUFFLENBQUE7U0FDOUM7UUFDRCxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUE7U0FDcEU7UUFFRCxJQUFJLFVBQVUsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQzFDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixVQUFVLEdBQUcsSUFBSSx3QkFBVSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFBO1lBQzlELFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1lBRXJDLE1BQU0sRUFBRSxHQUFHLFVBQVUsQ0FBQTtZQUNyQixVQUFVLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRTtnQkFDM0IsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtnQkFDcEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLFVBQVUsbUJBQW1CLENBQUMsQ0FBQTtZQUM5QyxDQUFDLENBQUMsQ0FBQTtTQUNIO1FBQ0QsTUFBTSxVQUFVLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLENBQUE7SUFDbkUsQ0FBQztJQUVPLE1BQU0sQ0FDWixVQUFlLEVBQ2YsTUFBYyxFQUNkLElBQVM7UUFFVCxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsT0FBTyxVQUFVLENBQUE7U0FDbEI7UUFDRCxNQUFNLElBQUksR0FBRyxFQUFFLENBQUE7UUFDZixLQUFLLE1BQU0sU0FBUyxJQUFJLFVBQVUsRUFBRTtZQUNsQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQzlCLE1BQU0sRUFBRSxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDekIsSUFBSSxFQUFFLEVBQUU7b0JBQ04sT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQTtpQkFDdkM7cUJBQU07b0JBQ0wsT0FBTyxDQUFDLENBQUE7aUJBQ1Q7WUFDSCxDQUFDLENBQUMsQ0FBQTtZQUNGLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQTtZQUNqQyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUU7Z0JBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQztvQkFDUixLQUFLO29CQUNMLE1BQU0sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztvQkFDN0IsSUFBSSxFQUFFLFNBQVM7aUJBQ2hCLENBQUMsQ0FBQTthQUNIO1NBQ0Y7UUFDRCxPQUFPLElBQUk7YUFDUixJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDYixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUE7WUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNYLE9BQU8sQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFBO2FBQzNCO1lBQ0QsT0FBTyxDQUFDLENBQUE7UUFDVixDQUFDLENBQUM7YUFDRCxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUM1QixDQUFDO0NBQ0Y7QUFqWUM7SUFEQyxlQUFlOzs2Q0FFTixpQkFBVSxVQUVQLFlBQUs7O2dFQVFqQjtBQWFEO0lBREMsZUFBZTs7NkNBRU4saUJBQVUsVUFFUCxZQUFLOzs4REFRakI7QUFnTEQ7SUFEQyxlQUFlOzs2Q0FFTixpQkFBVSxVQUVSLFlBQUs7OzhEQWdDaEI7QUF2WUgsOENBa2hCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEZaIGZyb20gJ2Z1enphbGRyaW4nXG5pbXBvcnQgeyBUZXh0QnVmZmVyLCBQb2ludCwgRGlzcG9zYWJsZSwgUmFuZ2UsIERpcmVjdG9yeSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBCdWZmZXJJbmZvIH0gZnJvbSAnLi9idWZmZXItaW5mbydcbmltcG9ydCB7IE1vZHVsZUluZm8gfSBmcm9tICcuL21vZHVsZS1pbmZvJ1xuaW1wb3J0IHsgR2hjTW9kaVByb2Nlc3MgfSBmcm9tICcuLi9naGMtbW9kJ1xuaW1wb3J0ICogYXMgVXRpbCBmcm9tICcuLi91dGlsJ1xuaW1wb3J0ICogYXMgVVBJIGZyb20gJ2F0b20taGFza2VsbC11cGknXG5pbXBvcnQgKiBhcyBDQiBmcm9tICdhdG9tLWhhc2tlbGwtdXBpL2NvbXBsZXRpb24tYmFja2VuZCdcblxuY29uc3QgeyBoYW5kbGVFeGNlcHRpb24gfSA9IFV0aWxcblxuZXhwb3J0IGNsYXNzIENvbXBsZXRpb25CYWNrZW5kIGltcGxlbWVudHMgQ0IuSUNvbXBsZXRpb25CYWNrZW5kIHtcbiAgcHJpdmF0ZSBidWZmZXJNYXA6IFdlYWtNYXA8VGV4dEJ1ZmZlciwgQnVmZmVySW5mbz5cbiAgcHJpdmF0ZSBkaXJNYXA6IFdlYWtNYXA8RGlyZWN0b3J5LCBNYXA8c3RyaW5nLCBNb2R1bGVJbmZvPj5cbiAgcHJpdmF0ZSBtb2RMaXN0TWFwOiBXZWFrTWFwPERpcmVjdG9yeSwgc3RyaW5nW10+XG4gIHByaXZhdGUgbGFuZ3VhZ2VQcmFnbWFzOiBXZWFrTWFwPERpcmVjdG9yeSwgc3RyaW5nW10+XG4gIHByaXZhdGUgY29tcGlsZXJPcHRpb25zOiBXZWFrTWFwPERpcmVjdG9yeSwgc3RyaW5nW10+XG4gIHByaXZhdGUgaXNBY3RpdmU6IGJvb2xlYW5cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHByb2Nlc3M6IEdoY01vZGlQcm9jZXNzLFxuICAgIHB1YmxpYyB1cGk6IFByb21pc2U8VVBJLklVUElJbnN0YW5jZT4sXG4gICkge1xuICAgIHRoaXMuYnVmZmVyTWFwID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMuZGlyTWFwID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMubW9kTGlzdE1hcCA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmxhbmd1YWdlUHJhZ21hcyA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmNvbXBpbGVyT3B0aW9ucyA9IG5ldyBXZWFrTWFwKClcblxuICAgIC8vIGNvbXBhdGliaWxpdHkgd2l0aCBvbGQgY2xpZW50c1xuICAgIHRoaXMubmFtZSA9IHRoaXMubmFtZS5iaW5kKHRoaXMpXG4gICAgdGhpcy5vbkRpZERlc3Ryb3kgPSB0aGlzLm9uRGlkRGVzdHJveS5iaW5kKHRoaXMpXG4gICAgdGhpcy5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIgPSB0aGlzLnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlci5iaW5kKHRoaXMpXG4gICAgdGhpcy51bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlciA9IHRoaXMudW5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2wgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yU3ltYm9sLmJpbmQodGhpcylcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9yVHlwZSA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JUeXBlLmJpbmQodGhpcylcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9yQ2xhc3MgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yQ2xhc3MuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yTW9kdWxlLmJpbmQodGhpcylcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUuYmluZChcbiAgICAgIHRoaXMsXG4gICAgKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JMYW5ndWFnZVByYWdtYXMgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yTGFuZ3VhZ2VQcmFnbWFzLmJpbmQoXG4gICAgICB0aGlzLFxuICAgIClcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zID0gdGhpcy5nZXRDb21wbGV0aW9uc0ZvckNvbXBpbGVyT3B0aW9ucy5iaW5kKFxuICAgICAgdGhpcyxcbiAgICApXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0ZvckhvbGUgPSB0aGlzLmdldENvbXBsZXRpb25zRm9ySG9sZS5iaW5kKHRoaXMpXG5cbiAgICB0aGlzLnByb2Nlc3MgPSBwcm9jZXNzXG4gICAgdGhpcy5pc0FjdGl2ZSA9IHRydWVcbiAgICB0aGlzLnByb2Nlc3Mub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgIHRoaXMuaXNBY3RpdmUgPSBmYWxzZVxuICAgIH0pXG4gIH1cblxuICAvKiBQdWJsaWMgaW50ZXJmYWNlIGJlbG93ICovXG5cbiAgLypcbiAgbmFtZSgpXG4gIEdldCBiYWNrZW5kIG5hbWVcblxuICBSZXR1cm5zIFN0cmluZywgdW5pcXVlIHN0cmluZyBkZXNjcmliaW5nIGEgZ2l2ZW4gYmFja2VuZFxuICAqL1xuICBwdWJsaWMgbmFtZSgpIHtcbiAgICByZXR1cm4gJ2hhc2tlbGwtZ2hjLW1vZCdcbiAgfVxuXG4gIC8qXG4gIG9uRGlkRGVzdHJveShjYWxsYmFjaylcbiAgRGVzdHJ1Y3Rpb24gZXZlbnQgc3Vic2NyaXB0aW9uLiBVc3VhbGx5IHNob3VsZCBiZSBjYWxsZWQgb25seSBvblxuICBwYWNrYWdlIGRlYWN0aXZhdGlvbi5cbiAgY2FsbGJhY2s6ICgpIC0+XG4gICovXG4gIHB1YmxpYyBvbkRpZERlc3Ryb3koY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb2Nlc3Mub25EaWREZXN0cm95KGNhbGxiYWNrKVxuICB9XG5cbiAgLypcbiAgcmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyKGJ1ZmZlcilcbiAgRXZlcnkgYnVmZmVyIHRoYXQgd291bGQgYmUgdXNlZCB3aXRoIGF1dG9jb21wbGV0aW9uIGZ1bmN0aW9ucyBoYXMgdG9cbiAgYmUgcmVnaXN0ZXJlZCB3aXRoIHRoaXMgZnVuY3Rpb24uXG5cbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBidWZmZXIgdG8gYmUgdXNlZCBpbiBhdXRvY29tcGxldGlvblxuXG4gIFJldHVybnM6IERpc3Bvc2FibGUsIHdoaWNoIHdpbGwgcmVtb3ZlIGJ1ZmZlciBmcm9tIGF1dG9jb21wbGV0aW9uXG4gICovXG4gIHB1YmxpYyByZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKVxuICAgIH1cblxuICAgIGlmICh0aGlzLmJ1ZmZlck1hcC5oYXMoYnVmZmVyKSkge1xuICAgICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgICAgLyogdm9pZCAqL1xuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCB7IGJ1ZmZlckluZm8gfSA9IHRoaXMuZ2V0QnVmZmVySW5mbyh7IGJ1ZmZlciB9KVxuXG4gICAgc2V0SW1tZWRpYXRlKGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHsgcm9vdERpciwgbW9kdWxlTWFwIH0gPSBhd2FpdCB0aGlzLmdldE1vZHVsZU1hcCh7IGJ1ZmZlckluZm8gfSlcblxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICB0aGlzLmdldE1vZHVsZUluZm8oeyBidWZmZXJJbmZvLCByb290RGlyLCBtb2R1bGVNYXAgfSlcblxuICAgICAgY29uc3QgaW1wb3J0cyA9IGF3YWl0IGJ1ZmZlckluZm8uZ2V0SW1wb3J0cygpXG4gICAgICBmb3IgKGNvbnN0IGltcHJ0IG9mIGltcG9ydHMpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZsb2F0aW5nLXByb21pc2VzXG4gICAgICAgIHRoaXMuZ2V0TW9kdWxlSW5mbyh7XG4gICAgICAgICAgbW9kdWxlTmFtZTogaW1wcnQubmFtZSxcbiAgICAgICAgICBidWZmZXJJbmZvLFxuICAgICAgICAgIHJvb3REaXIsXG4gICAgICAgICAgbW9kdWxlTWFwLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4gdGhpcy51bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlcihidWZmZXIpKVxuICB9XG5cbiAgLypcbiAgdW5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyKVxuICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0byBiZSByZW1vdmVkIGZyb20gYXV0b2NvbXBsZXRpb25cbiAgKi9cbiAgcHVibGljIHVucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xuICAgIGNvbnN0IHggPSB0aGlzLmJ1ZmZlck1hcC5nZXQoYnVmZmVyKVxuICAgIGlmICh4KSB7XG4gICAgICB4LmRlc3Ryb3koKVxuICAgIH1cbiAgfVxuXG4gIC8qXG4gIGdldENvbXBsZXRpb25zRm9yU3ltYm9sKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cblxuICBSZXR1cm5zOiBQcm9taXNlKFtzeW1ib2xdKVxuICBzeW1ib2w6IE9iamVjdCwgYSBjb21wbGV0aW9uIHN5bWJvbFxuICAgIG5hbWU6IFN0cmluZywgc3ltYm9sIG5hbWVcbiAgICBxbmFtZTogU3RyaW5nLCBxdWFsaWZpZWQgbmFtZSwgaWYgbW9kdWxlIGlzIHF1YWxpZmllZC5cbiAgICAgICAgICAgT3RoZXJ3aXNlLCBzYW1lIGFzIG5hbWVcbiAgICB0eXBlU2lnbmF0dXJlOiBTdHJpbmcsIHR5cGUgc2lnbmF0dXJlXG4gICAgc3ltYm9sVHlwZTogU3RyaW5nLCBvbmUgb2YgWyd0eXBlJywgJ2NsYXNzJywgJ2Z1bmN0aW9uJ11cbiAgICBtb2R1bGU6IE9iamVjdCwgc3ltYm9sIG1vZHVsZSBpbmZvcm1hdGlvblxuICAgICAgcXVhbGlmaWVkOiBCb29sZWFuLCB0cnVlIGlmIG1vZHVsZSBpcyBpbXBvcnRlZCBhcyBxdWFsaWZpZWRcbiAgICAgIG5hbWU6IFN0cmluZywgbW9kdWxlIG5hbWVcbiAgICAgIGFsaWFzOiBTdHJpbmcsIG1vZHVsZSBhbGlhc1xuICAgICAgaGlkaW5nOiBCb29sZWFuLCB0cnVlIGlmIG1vZHVsZSBpcyBpbXBvcnRlZCB3aXRoIGhpZGluZyBjbGF1c2VcbiAgICAgIGltcG9ydExpc3Q6IFtTdHJpbmddLCBhcnJheSBvZiBleHBsaWNpdCBpbXBvcnRzL2hpZGRlbiBpbXBvcnRzXG4gICovXG4gIEBoYW5kbGVFeGNlcHRpb25cbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yU3ltYm9sKFxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlcixcbiAgICBwcmVmaXg6IHN0cmluZyxcbiAgICBfcG9zaXRpb246IFBvaW50LFxuICApOiBQcm9taXNlPENCLklTeW1ib2xbXT4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJylcbiAgICB9XG5cbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgdGhpcy5nZXRTeW1ib2xzRm9yQnVmZmVyKGJ1ZmZlcilcbiAgICByZXR1cm4gdGhpcy5maWx0ZXIoc3ltYm9scywgcHJlZml4LCBbJ3FuYW1lJywgJ3FwYXJlbnQnXSlcbiAgfVxuXG4gIC8qXG4gIGdldENvbXBsZXRpb25zRm9yVHlwZShidWZmZXIscHJlZml4LHBvc2l0aW9uKVxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXG5cbiAgUmV0dXJuczogUHJvbWlzZShbc3ltYm9sXSlcbiAgc3ltYm9sOiBTYW1lIGFzIGdldENvbXBsZXRpb25zRm9yU3ltYm9sLCBleGNlcHRcbiAgICAgICAgICBzeW1ib2xUeXBlIGlzIG9uZSBvZiBbJ3R5cGUnLCAnY2xhc3MnXVxuICAqL1xuICBAaGFuZGxlRXhjZXB0aW9uXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0ZvclR5cGUoXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLFxuICAgIHByZWZpeDogc3RyaW5nLFxuICAgIF9wb3NpdGlvbjogUG9pbnQsXG4gICk6IFByb21pc2U8Q0IuSVN5bWJvbFtdPiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKVxuICAgIH1cblxuICAgIGNvbnN0IHN5bWJvbHMgPSBhd2FpdCB0aGlzLmdldFN5bWJvbHNGb3JCdWZmZXIoYnVmZmVyLCBbJ3R5cGUnLCAnY2xhc3MnXSlcbiAgICByZXR1cm4gRlouZmlsdGVyKHN5bWJvbHMsIHByZWZpeCwgeyBrZXk6ICdxbmFtZScgfSlcbiAgfVxuXG4gIC8qXG4gIGdldENvbXBsZXRpb25zRm9yQ2xhc3MoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXG4gIHN5bWJvbDogU2FtZSBhcyBnZXRDb21wbGV0aW9uc0ZvclN5bWJvbCwgZXhjZXB0XG4gICAgICAgICAgc3ltYm9sVHlwZSBpcyBvbmUgb2YgWydjbGFzcyddXG4gICovXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0ZvckNsYXNzKFxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlcixcbiAgICBwcmVmaXg6IHN0cmluZyxcbiAgICBfcG9zaXRpb246IFBvaW50LFxuICApOiBQcm9taXNlPENCLklTeW1ib2xbXT4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJylcbiAgICB9XG5cbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgdGhpcy5nZXRTeW1ib2xzRm9yQnVmZmVyKGJ1ZmZlciwgWydjbGFzcyddKVxuICAgIHJldHVybiBGWi5maWx0ZXIoc3ltYm9scywgcHJlZml4LCB7IGtleTogJ3FuYW1lJyB9KVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuXG4gIFJldHVybnM6IFByb21pc2UoW21vZHVsZV0pXG4gIG1vZHVsZTogU3RyaW5nLCBtb2R1bGUgbmFtZVxuICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUoXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLFxuICAgIHByZWZpeDogc3RyaW5nLFxuICAgIF9wb3NpdGlvbjogUG9pbnQsXG4gICk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpXG4gICAgfVxuICAgIGNvbnN0IHJvb3REaXIgPSBhd2FpdCB0aGlzLnByb2Nlc3MuZ2V0Um9vdERpcihidWZmZXIpXG4gICAgbGV0IG1vZHVsZXMgPSB0aGlzLm1vZExpc3RNYXAuZ2V0KHJvb3REaXIpXG4gICAgaWYgKCFtb2R1bGVzKSB7XG4gICAgICBtb2R1bGVzID0gYXdhaXQgdGhpcy5wcm9jZXNzLnJ1bkxpc3QoYnVmZmVyKVxuICAgICAgdGhpcy5tb2RMaXN0TWFwLnNldChyb290RGlyLCBtb2R1bGVzKVxuICAgICAgLy8gcmVmcmVzaCBldmVyeSBtaW51dGVcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5tb2RMaXN0TWFwLmRlbGV0ZShyb290RGlyKSwgNjAgKiAxMDAwKVxuICAgIH1cbiAgICByZXR1cm4gRlouZmlsdGVyKG1vZHVsZXMsIHByZWZpeClcbiAgfVxuXG4gIC8qXG4gIGdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUoYnVmZmVyLHByZWZpeCxwb3NpdGlvbix7bW9kdWxlfSlcbiAgVXNlZCBpbiBpbXBvcnQgaGlkaW5nL2xpc3QgY29tcGxldGlvbnNcblxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXG4gIG1vZHVsZTogU3RyaW5nLCBtb2R1bGUgbmFtZSAob3B0aW9uYWwpLiBJZiB1bmRlZmluZWQsIGZ1bmN0aW9uXG4gICAgICAgICAgd2lsbCBhdHRlbXB0IHRvIGluZmVyIG1vZHVsZSBuYW1lIGZyb20gcG9zaXRpb24gYW5kIGJ1ZmZlci5cblxuICBSZXR1cm5zOiBQcm9taXNlKFtzeW1ib2xdKVxuICBzeW1ib2w6IE9iamVjdCwgc3ltYm9sIGluIGdpdmVuIG1vZHVsZVxuICAgIG5hbWU6IFN0cmluZywgc3ltYm9sIG5hbWVcbiAgICB0eXBlU2lnbmF0dXJlOiBTdHJpbmcsIHR5cGUgc2lnbmF0dXJlXG4gICAgc3ltYm9sVHlwZTogU3RyaW5nLCBvbmUgb2YgWyd0eXBlJywgJ2NsYXNzJywgJ2Z1bmN0aW9uJ11cbiAgKi9cbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUoXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLFxuICAgIHByZWZpeDogc3RyaW5nLFxuICAgIHBvc2l0aW9uOiBQb2ludCxcbiAgICBvcHRzPzogeyBtb2R1bGU6IHN0cmluZyB9LFxuICApOiBQcm9taXNlPENCLklTeW1ib2xbXT4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJylcbiAgICB9XG4gICAgbGV0IG1vZHVsZU5hbWUgPSBvcHRzID8gb3B0cy5tb2R1bGUgOiB1bmRlZmluZWRcbiAgICBpZiAoIW1vZHVsZU5hbWUpIHtcbiAgICAgIGNvbnN0IGxpbmVSYW5nZSA9IG5ldyBSYW5nZShbMCwgcG9zaXRpb24ucm93XSwgcG9zaXRpb24pXG4gICAgICBidWZmZXIuYmFja3dhcmRzU2NhbkluUmFuZ2UoXG4gICAgICAgIC9eaW1wb3J0XFxzKyhbXFx3Ll0rKS8sXG4gICAgICAgIGxpbmVSYW5nZSxcbiAgICAgICAgKHsgbWF0Y2ggfSkgPT4gKG1vZHVsZU5hbWUgPSBtYXRjaFsxXSksXG4gICAgICApXG4gICAgfVxuXG4gICAgY29uc3QgeyBidWZmZXJJbmZvIH0gPSB0aGlzLmdldEJ1ZmZlckluZm8oeyBidWZmZXIgfSlcbiAgICBjb25zdCBtaXMgPSBhd2FpdCB0aGlzLmdldE1vZHVsZUluZm8oeyBidWZmZXJJbmZvLCBtb2R1bGVOYW1lIH0pXG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZTogbm8tbnVsbC1rZXl3b3JkXG4gICAgY29uc3Qgc3ltYm9scyA9IGF3YWl0IG1pcy5tb2R1bGVJbmZvLnNlbGVjdChcbiAgICAgIHtcbiAgICAgICAgcXVhbGlmaWVkOiBmYWxzZSxcbiAgICAgICAgaGlkaW5nOiBmYWxzZSxcbiAgICAgICAgbmFtZTogbW9kdWxlTmFtZSB8fCBtaXMubW9kdWxlTmFtZSxcbiAgICAgICAgaW1wb3J0TGlzdDogbnVsbCxcbiAgICAgICAgYWxpYXM6IG51bGwsXG4gICAgICB9LFxuICAgICAgdW5kZWZpbmVkLFxuICAgICAgdHJ1ZSxcbiAgICApXG4gICAgLy8gdHNsaW50OmVuYWJsZTogbm8tbnVsbC1rZXl3b3JkXG4gICAgcmV0dXJuIEZaLmZpbHRlcihzeW1ib2xzLCBwcmVmaXgsIHsga2V5OiAnbmFtZScgfSlcbiAgfVxuXG4gIC8qXG4gIGdldENvbXBsZXRpb25zRm9yTGFuZ3VhZ2VQcmFnbWFzKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cblxuICBSZXR1cm5zOiBQcm9taXNlKFtwcmFnbWFdKVxuICBwcmFnbWE6IFN0cmluZywgbGFuZ3VhZ2Ugb3B0aW9uXG4gICovXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0Zvckxhbmd1YWdlUHJhZ21hcyhcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsXG4gICAgcHJlZml4OiBzdHJpbmcsXG4gICAgX3Bvc2l0aW9uOiBQb2ludCxcbiAgKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJylcbiAgICB9XG5cbiAgICBjb25zdCBkaXIgPSBhd2FpdCB0aGlzLnByb2Nlc3MuZ2V0Um9vdERpcihidWZmZXIpXG5cbiAgICBsZXQgcHMgPSB0aGlzLmxhbmd1YWdlUHJhZ21hcy5nZXQoZGlyKVxuICAgIGlmICghcHMpIHtcbiAgICAgIHBzID0gYXdhaXQgdGhpcy5wcm9jZXNzLnJ1bkxhbmcoZGlyKVxuICAgICAgcHMgJiYgdGhpcy5sYW5ndWFnZVByYWdtYXMuc2V0KGRpciwgcHMpXG4gICAgfVxuICAgIHJldHVybiBGWi5maWx0ZXIocHMsIHByZWZpeClcbiAgfVxuXG4gIC8qXG4gIGdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cblxuICBSZXR1cm5zOiBQcm9taXNlKFtnaGNvcHRdKVxuICBnaGNvcHQ6IFN0cmluZywgY29tcGlsZXIgb3B0aW9uIChzdGFydHMgd2l0aCAnLWYnKVxuICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JDb21waWxlck9wdGlvbnMoXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLFxuICAgIHByZWZpeDogc3RyaW5nLFxuICAgIF9wb3NpdGlvbjogUG9pbnQsXG4gICk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpXG4gICAgfVxuXG4gICAgY29uc3QgZGlyID0gYXdhaXQgdGhpcy5wcm9jZXNzLmdldFJvb3REaXIoYnVmZmVyKVxuXG4gICAgbGV0IGNvID0gdGhpcy5jb21waWxlck9wdGlvbnMuZ2V0KGRpcilcbiAgICBpZiAoIWNvKSB7XG4gICAgICBjbyA9IGF3YWl0IHRoaXMucHJvY2Vzcy5ydW5GbGFnKGRpcilcbiAgICAgIHRoaXMuY29tcGlsZXJPcHRpb25zLnNldChkaXIsIGNvKVxuICAgIH1cbiAgICByZXR1cm4gRlouZmlsdGVyKGNvLCBwcmVmaXgpXG4gIH1cblxuICAvKlxuICBnZXRDb21wbGV0aW9uc0ZvckhvbGUoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgR2V0IGNvbXBsZXRpb25zIGJhc2VkIG9uIGV4cHJlc3Npb24gdHlwZS5cbiAgSXQgaXMgYXNzdW1lZCB0aGF0IGBwcmVmaXhgIHN0YXJ0cyB3aXRoICdfJ1xuXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cblxuICBSZXR1cm5zOiBQcm9taXNlKFtzeW1ib2xdKVxuICBzeW1ib2w6IFNhbWUgYXMgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xcbiAgKi9cbiAgQGhhbmRsZUV4Y2VwdGlvblxuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JIb2xlKFxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlcixcbiAgICBwcmVmaXg6IHN0cmluZyxcbiAgICBwb3NpdGlvbjogUG9pbnQsXG4gICk6IFByb21pc2U8Q0IuSVN5bWJvbFtdPiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKVxuICAgIH1cbiAgICBjb25zdCByYW5nZSA9IG5ldyBSYW5nZShwb3NpdGlvbiwgcG9zaXRpb24pXG4gICAgaWYgKHByZWZpeC5zdGFydHNXaXRoKCdfJykpIHtcbiAgICAgIHByZWZpeCA9IHByZWZpeC5zbGljZSgxKVxuICAgIH1cbiAgICBjb25zdCB7IHR5cGUgfSA9IGF3YWl0IHRoaXMucHJvY2Vzcy5nZXRUeXBlSW5CdWZmZXIoYnVmZmVyLCByYW5nZSlcbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgdGhpcy5nZXRTeW1ib2xzRm9yQnVmZmVyKGJ1ZmZlcilcbiAgICBjb25zdCB0cyA9IHN5bWJvbHMuZmlsdGVyKChzKSA9PiB7XG4gICAgICBpZiAoIXMudHlwZVNpZ25hdHVyZSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICAgIGNvbnN0IHRsID0gcy50eXBlU2lnbmF0dXJlLnNwbGl0KCcgLT4gJykuc2xpY2UoLTEpWzBdXG4gICAgICBpZiAodGwubWF0Y2goL15bYS16XSQvKSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICAgIGNvbnN0IHRzMiA9IHRsLnJlcGxhY2UoL1suPyorXiRbXFxdXFxcXCgpe318LV0vZywgJ1xcXFwkJicpXG4gICAgICBjb25zdCByeCA9IFJlZ0V4cCh0czIucmVwbGFjZSgvXFxiW2Etel1cXGIvZywgJy4rJyksICcnKVxuICAgICAgcmV0dXJuIHJ4LnRlc3QodHlwZSlcbiAgICB9KVxuICAgIGlmIChwcmVmaXgubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gdHMuc29ydChcbiAgICAgICAgKGEsIGIpID0+XG4gICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICBGWi5zY29yZShiLnR5cGVTaWduYXR1cmUhLCB0eXBlKSAtIEZaLnNjb3JlKGEudHlwZVNpZ25hdHVyZSEsIHR5cGUpLFxuICAgICAgKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gRlouZmlsdGVyKHRzLCBwcmVmaXgsIHsga2V5OiAncW5hbWUnIH0pXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRTeW1ib2xzRm9yQnVmZmVyKFxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlcixcbiAgICBzeW1ib2xUeXBlcz86IENCLlN5bWJvbFR5cGVbXSxcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcbiAgICBjb25zdCB7IGJ1ZmZlckluZm8gfSA9IHRoaXMuZ2V0QnVmZmVySW5mbyh7IGJ1ZmZlciB9KVxuICAgIGNvbnN0IHsgcm9vdERpciwgbW9kdWxlTWFwIH0gPSBhd2FpdCB0aGlzLmdldE1vZHVsZU1hcCh7IGJ1ZmZlckluZm8gfSlcbiAgICBpZiAoYnVmZmVySW5mbyAmJiBtb2R1bGVNYXApIHtcbiAgICAgIGNvbnN0IGltcG9ydHMgPSBhd2FpdCBidWZmZXJJbmZvLmdldEltcG9ydHMoKVxuICAgICAgY29uc3QgcHJvbWlzZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgaW1wb3J0cy5tYXAoYXN5bmMgKGltcCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZ2V0TW9kdWxlSW5mbyh7XG4gICAgICAgICAgICBidWZmZXJJbmZvLFxuICAgICAgICAgICAgbW9kdWxlTmFtZTogaW1wLm5hbWUsXG4gICAgICAgICAgICByb290RGlyLFxuICAgICAgICAgICAgbW9kdWxlTWFwLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgaWYgKCFyZXMpIHtcbiAgICAgICAgICAgIHJldHVybiBbXVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmVzLm1vZHVsZUluZm8uc2VsZWN0KGltcCwgc3ltYm9sVHlwZXMpXG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgICAgcmV0dXJuIChbXSBhcyB0eXBlb2YgcHJvbWlzZXNbMF0pLmNvbmNhdCguLi5wcm9taXNlcylcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRCdWZmZXJJbmZvKHtcbiAgICBidWZmZXIsXG4gIH06IHtcbiAgICBidWZmZXI6IFRleHRCdWZmZXJcbiAgfSk6IHsgYnVmZmVySW5mbzogQnVmZmVySW5mbyB9IHtcbiAgICBsZXQgYmkgPSB0aGlzLmJ1ZmZlck1hcC5nZXQoYnVmZmVyKVxuICAgIGlmICghYmkpIHtcbiAgICAgIGJpID0gbmV3IEJ1ZmZlckluZm8oYnVmZmVyKVxuICAgICAgdGhpcy5idWZmZXJNYXAuc2V0KGJ1ZmZlciwgYmkpXG4gICAgfVxuICAgIHJldHVybiB7IGJ1ZmZlckluZm86IGJpIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0TW9kdWxlTWFwKHtcbiAgICBidWZmZXJJbmZvLFxuICAgIHJvb3REaXIsXG4gIH06IHtcbiAgICBidWZmZXJJbmZvOiBCdWZmZXJJbmZvXG4gICAgcm9vdERpcj86IERpcmVjdG9yeVxuICB9KTogUHJvbWlzZTx7IHJvb3REaXI6IERpcmVjdG9yeTsgbW9kdWxlTWFwOiBNYXA8c3RyaW5nLCBNb2R1bGVJbmZvPiB9PiB7XG4gICAgaWYgKCFyb290RGlyKSB7XG4gICAgICByb290RGlyID0gYXdhaXQgdGhpcy5wcm9jZXNzLmdldFJvb3REaXIoYnVmZmVySW5mby5idWZmZXIpXG4gICAgfVxuICAgIGxldCBtbSA9IHRoaXMuZGlyTWFwLmdldChyb290RGlyKVxuICAgIGlmICghbW0pIHtcbiAgICAgIG1tID0gbmV3IE1hcCgpXG4gICAgICB0aGlzLmRpck1hcC5zZXQocm9vdERpciwgbW0pXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJvb3REaXIsXG4gICAgICBtb2R1bGVNYXA6IG1tLFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0TW9kdWxlSW5mbyhhcmc6IHtcbiAgICBidWZmZXJJbmZvOiBCdWZmZXJJbmZvXG4gICAgbW9kdWxlTmFtZT86IHN0cmluZ1xuICAgIHJvb3REaXI/OiBEaXJlY3RvcnlcbiAgICBtb2R1bGVNYXA/OiBNYXA8c3RyaW5nLCBNb2R1bGVJbmZvPlxuICB9KSB7XG4gICAgY29uc3QgeyBidWZmZXJJbmZvIH0gPSBhcmdcbiAgICBsZXQgZGF0XG4gICAgaWYgKGFyZy5yb290RGlyICYmIGFyZy5tb2R1bGVNYXApIHtcbiAgICAgIGRhdCA9IHsgcm9vdERpcjogYXJnLnJvb3REaXIsIG1vZHVsZU1hcDogYXJnLm1vZHVsZU1hcCB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGRhdCA9IGF3YWl0IHRoaXMuZ2V0TW9kdWxlTWFwKHsgYnVmZmVySW5mbyB9KVxuICAgIH1cbiAgICBjb25zdCB7IG1vZHVsZU1hcCwgcm9vdERpciB9ID0gZGF0XG4gICAgbGV0IG1vZHVsZU5hbWUgPSBhcmcubW9kdWxlTmFtZVxuICAgIGlmICghbW9kdWxlTmFtZSkge1xuICAgICAgbW9kdWxlTmFtZSA9IGF3YWl0IGJ1ZmZlckluZm8uZ2V0TW9kdWxlTmFtZSgpXG4gICAgfVxuICAgIGlmICghbW9kdWxlTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBOYW1lbGVzcyBtb2R1bGUgaW4gJHtidWZmZXJJbmZvLmJ1ZmZlci5nZXRVcmkoKX1gKVxuICAgIH1cblxuICAgIGxldCBtb2R1bGVJbmZvID0gbW9kdWxlTWFwLmdldChtb2R1bGVOYW1lKVxuICAgIGlmICghbW9kdWxlSW5mbykge1xuICAgICAgbW9kdWxlSW5mbyA9IG5ldyBNb2R1bGVJbmZvKG1vZHVsZU5hbWUsIHRoaXMucHJvY2Vzcywgcm9vdERpcilcbiAgICAgIG1vZHVsZU1hcC5zZXQobW9kdWxlTmFtZSwgbW9kdWxlSW5mbylcblxuICAgICAgY29uc3QgbW4gPSBtb2R1bGVOYW1lXG4gICAgICBtb2R1bGVJbmZvLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgIG1vZHVsZU1hcC5kZWxldGUobW4pXG4gICAgICAgIFV0aWwuZGVidWcoYCR7bW9kdWxlTmFtZX0gcmVtb3ZlZCBmcm9tIG1hcGApXG4gICAgICB9KVxuICAgIH1cbiAgICBhd2FpdCBtb2R1bGVJbmZvLnNldEJ1ZmZlcihidWZmZXJJbmZvKVxuICAgIHJldHVybiB7IGJ1ZmZlckluZm8sIHJvb3REaXIsIG1vZHVsZU1hcCwgbW9kdWxlSW5mbywgbW9kdWxlTmFtZSB9XG4gIH1cblxuICBwcml2YXRlIGZpbHRlcjxULCBLIGV4dGVuZHMga2V5b2YgVD4oXG4gICAgY2FuZGlkYXRlczogVFtdLFxuICAgIHByZWZpeDogc3RyaW5nLFxuICAgIGtleXM6IEtbXSxcbiAgKTogVFtdIHtcbiAgICBpZiAoIXByZWZpeCkge1xuICAgICAgcmV0dXJuIGNhbmRpZGF0ZXNcbiAgICB9XG4gICAgY29uc3QgbGlzdCA9IFtdXG4gICAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykge1xuICAgICAgY29uc3Qgc2NvcmVzID0ga2V5cy5tYXAoKGtleSkgPT4ge1xuICAgICAgICBjb25zdCBjayA9IGNhbmRpZGF0ZVtrZXldXG4gICAgICAgIGlmIChjaykge1xuICAgICAgICAgIHJldHVybiBGWi5zY29yZShjay50b1N0cmluZygpLCBwcmVmaXgpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIDBcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIGNvbnN0IHNjb3JlID0gTWF0aC5tYXgoLi4uc2NvcmVzKVxuICAgICAgaWYgKHNjb3JlID4gMCkge1xuICAgICAgICBsaXN0LnB1c2goe1xuICAgICAgICAgIHNjb3JlLFxuICAgICAgICAgIHNjb3JlTjogc2NvcmVzLmluZGV4T2Yoc2NvcmUpLFxuICAgICAgICAgIGRhdGE6IGNhbmRpZGF0ZSxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGxpc3RcbiAgICAgIC5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgIGNvbnN0IHMgPSBiLnNjb3JlIC0gYS5zY29yZVxuICAgICAgICBpZiAocyA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiBhLnNjb3JlTiAtIGIuc2NvcmVOXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNcbiAgICAgIH0pXG4gICAgICAubWFwKCh7IGRhdGEgfSkgPT4gZGF0YSlcbiAgfVxufVxuIl19