"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const interactive_process_1 = require("./interactive-process");
const Util = require("../util");
const { debug, withTempFile, EOT } = Util;
const os_1 = require("os");
const _ = require("underscore");
class GhcModiProcessReal {
    constructor(caps, rootDir, options) {
        this.caps = caps;
        this.rootDir = rootDir;
        this.options = options;
        this.runModCmd = async ({ ghcModOptions, command, text, uri, args, }) => {
            const modPath = atom.config.get('haskell-ghc-mod.ghcModPath');
            let stdin;
            const cmd = [...ghcModOptions];
            if (text && uri) {
                cmd.push('--map-file', uri);
                stdin = `${text}${EOT}`;
            }
            cmd.push(command);
            if (uri) {
                cmd.push(uri);
            }
            cmd.push(...args);
            const { stdout, stderr } = await Util.execPromise(modPath, cmd, this.options, stdin);
            return {
                stdout: stdout.split(os_1.EOL).slice(0, -1),
                stderr: stderr.split(os_1.EOL),
            };
        };
        this.runModiCmd = async (o) => {
            const { ghcModOptions, command, text, args } = o;
            let { uri } = o;
            debug(`Trying to run ghc-modi in ${this.rootDir.getPath()}`);
            const proc = await this.spawnProcess(ghcModOptions);
            if (!proc) {
                debug('Failed. Falling back to ghc-mod');
                return this.runModCmd(o);
            }
            debug('Success. Resuming...');
            if (uri && !this.caps.quoteArgs) {
                uri = this.rootDir.relativize(uri);
            }
            try {
                if (uri && text) {
                    await proc.interact('map-file', [uri], text);
                }
                const res = await proc.interact(command, uri ? [uri].concat(args) : args);
                if (uri && text) {
                    await proc.interact('unmap-file', [uri]);
                }
                return res;
            }
            finally {
                if (uri && text) {
                    await proc.interact('unmap-file', [uri]);
                }
            }
        };
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
    }
    getCaps() {
        return this.caps;
    }
    async run(runArgs) {
        let { interactive, dashArgs, args, suppressErrors, ghcOptions, ghcModOptions } = runArgs;
        const { command, text, uri, builder } = runArgs;
        if (!args) {
            args = [];
        }
        if (!dashArgs) {
            dashArgs = [];
        }
        if (!suppressErrors) {
            suppressErrors = false;
        }
        if (!ghcOptions) {
            ghcOptions = [];
        }
        if (!ghcModOptions) {
            ghcModOptions = [];
        }
        ghcModOptions = ghcModOptions.concat(...ghcOptions.map((opt) => ['--ghc-option', opt]));
        if (atom.config.get('haskell-ghc-mod.lowMemorySystem')) {
            interactive = atom.config.get('haskell-ghc-mod.enableGhcModi');
        }
        if (builder) {
            switch (builder) {
                case 'cabal':
                    ghcModOptions.push('--with-stack', '');
                    break;
                case 'stack':
                    ghcModOptions.push('--with-cabal', '');
                    break;
                case 'none':
                    ghcModOptions.push('--with-stack', '');
                    ghcModOptions.push('--with-cabal', '');
                    break;
                default:
                    atom.notifications.addWarning(`Haskell-ghc-mod: unknown builder ${builder}, falling back to autodetection`);
            }
        }
        if (this.caps.optparse) {
            args = dashArgs.concat(['--']).concat(args);
        }
        else {
            args = dashArgs.concat(args);
        }
        const fun = interactive ? this.runModiCmd : this.runModCmd;
        try {
            let res;
            if (uri && text && !this.caps.fileMap) {
                const myOpts = { ghcModOptions, command, args };
                res = withTempFile(text, uri, async (tempuri) => {
                    const { stdout, stderr } = await fun(Object.assign({}, myOpts, { uri: tempuri }));
                    return {
                        stdout: stdout.map((line) => line.split(tempuri).join(uri)),
                        stderr: stderr.map((line) => line.split(tempuri).join(uri)),
                    };
                });
            }
            else {
                res = fun({ ghcModOptions, command, text, uri, args });
            }
            const { stdout, stderr } = await res;
            if (stderr.join('').length) {
                this.emitter.emit('warning', stderr.join('\n'));
            }
            return stdout.map((line) => line.replace(/\0/g, '\n'));
        }
        catch (err) {
            debug(err);
            this.emitter.emit('error', { runArgs, err, caps: this.caps });
            return [];
        }
    }
    killProcess() {
        debug(`Killing ghc-modi process for ${this.rootDir.getPath()}`);
        this.proc && this.proc.kill();
    }
    destroy() {
        debug('GhcModiProcessBase destroying');
        this.killProcess();
        this.emitter.emit('did-destroy');
        this.disposables.dispose();
    }
    onDidDestroy(callback) {
        return this.emitter.on('did-destroy', callback);
    }
    onWarning(callback) {
        return this.emitter.on('warning', callback);
    }
    onError(callback) {
        return this.emitter.on('error', callback);
    }
    async spawnProcess(ghcModOptions) {
        if (!atom.config.get('haskell-ghc-mod.enableGhcModi')) {
            return undefined;
        }
        debug(`Checking for ghc-modi in ${this.rootDir.getPath()}`);
        if (this.proc) {
            if (!_.isEqual(this.ghcModOptions, ghcModOptions)) {
                debug(`Found running ghc-modi instance for ${this.rootDir.getPath()}, but ghcModOptions don't match. Old: `, this.ghcModOptions, ' new: ', ghcModOptions);
                await this.proc.kill();
                return this.spawnProcess(ghcModOptions);
            }
            debug(`Found running ghc-modi instance for ${this.rootDir.getPath()}`);
            return this.proc;
        }
        debug(`Spawning new ghc-modi instance for ${this.rootDir.getPath()} with`, this.options);
        const modPath = atom.config.get('haskell-ghc-mod.ghcModPath');
        this.ghcModOptions = ghcModOptions;
        this.proc = new interactive_process_1.InteractiveProcess(modPath, ghcModOptions.concat(['legacy-interactive']), this.options, this.caps);
        this.proc.onceExit((code) => {
            debug(`ghc-modi for ${this.rootDir.getPath()} ended with ${code}`);
            this.proc = undefined;
        });
        return this.proc;
    }
}
exports.GhcModiProcessReal = GhcModiProcessReal;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2hjLW1vZGktcHJvY2Vzcy1yZWFsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2doYy1tb2QvZ2hjLW1vZGktcHJvY2Vzcy1yZWFsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQThEO0FBQzlELCtEQUFzRTtBQUN0RSxnQ0FBK0I7QUFDL0IsTUFBTSxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFBO0FBQ3pDLDJCQUF3QjtBQUN4QixnQ0FBK0I7QUE4Qi9CO0lBV0UsWUFDVSxJQUFnQixFQUNoQixPQUFrQixFQUNsQixPQUFtQjtRQUZuQixTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLFlBQU8sR0FBUCxPQUFPLENBQVc7UUFDbEIsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQWtJckIsY0FBUyxHQUFHLEtBQUssRUFDdkIsRUFDRSxhQUFhLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxHQUNtRCxFQUM1RixFQUFFO1lBQ0YsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLENBQUMsQ0FBQTtZQUM3RCxJQUFJLEtBQUssQ0FBQTtZQUNULE1BQU0sR0FBRyxHQUFHLENBQUMsR0FBRyxhQUFhLENBQUMsQ0FBQTtZQUM5QixFQUFFLENBQUMsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDaEIsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsR0FBRyxDQUFDLENBQUE7Z0JBQzNCLEtBQUssR0FBRyxHQUFHLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQTtZQUN6QixDQUFDO1lBQ0QsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUNqQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNSLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFD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Q0FBQyxHQUFHLENBQUMsNEJBQTRCLENBQUMsQ0FBQTtRQUM3RCxJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQTtRQUNsQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksd0NBQWtCLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDbEgsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUMxQixLQUFLLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLGVBQWUsSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUNsRSxJQUFJLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQTtRQUN2QixDQUFDLENBQUMsQ0FBQTtRQUNGLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFBO0lBQ2xCLENBQUM7Q0FzREY7QUFwTUQsZ0RBb01DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0b3J5LCBFbWl0dGVyLCBDb21wb3NpdGVEaXNwb3NhYmxlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IEludGVyYWN0aXZlUHJvY2VzcywgR0hDTW9kQ2FwcyB9IGZyb20gJy4vaW50ZXJhY3RpdmUtcHJvY2VzcydcbmltcG9ydCAqIGFzIFV0aWwgZnJvbSAnLi4vdXRpbCdcbmNvbnN0IHsgZGVidWcsIHdpdGhUZW1wRmlsZSwgRU9UIH0gPSBVdGlsXG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcydcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSdcblxuZXhwb3J0IHsgR0hDTW9kQ2FwcyB9XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnVuQXJncyB7XG4gIGludGVyYWN0aXZlPzogYm9vbGVhblxuICBjb21tYW5kOiBzdHJpbmdcbiAgdGV4dD86IHN0cmluZ1xuICB1cmk/OiBzdHJpbmdcbiAgZGFzaEFyZ3M/OiBzdHJpbmdbXVxuICBhcmdzPzogc3RyaW5nW11cbiAgc3VwcHJlc3NFcnJvcnM/OiBib29sZWFuXG4gIGdoY09wdGlvbnM/OiBzdHJpbmdbXVxuICBnaGNNb2RPcHRpb25zPzogc3RyaW5nW11cbiAgYnVpbGRlcjogc3RyaW5nIHwgdW5kZWZpbmVkXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnVuT3B0aW9ucyB7XG4gIGN3ZDogc3RyaW5nXG4gIGVuY29kaW5nOiAndXRmOCdcbiAgZW52OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IHVuZGVmaW5lZCB9XG4gIG1heEJ1ZmZlcjogbnVtYmVyXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVycm9yQ2FsbGJhY2tBcmdzIHtcbiAgcnVuQXJncz86IFJ1bkFyZ3NcbiAgZXJyOiBFcnJvclxuICBjYXBzOiBHSENNb2RDYXBzXG59XG5cbmV4cG9ydCBjbGFzcyBHaGNNb2RpUHJvY2Vzc1JlYWwge1xuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHByaXZhdGUgZW1pdHRlcjogRW1pdHRlcjx7XG4gICAgJ2RpZC1kZXN0cm95Jzogdm9pZFxuICB9LHtcbiAgICAnd2FybmluZyc6IHN0cmluZ1xuICAgICdlcnJvcic6IElFcnJvckNhbGxiYWNrQXJnc1xuICB9PlxuICBwcml2YXRlIGdoY01vZE9wdGlvbnM6IHN0cmluZ1tdIHwgdW5kZWZpbmVkXG4gIHByaXZhdGUgcHJvYzogSW50ZXJhY3RpdmVQcm9jZXNzIHwgdW5kZWZpbmVkXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjYXBzOiBHSENNb2RDYXBzLFxuICAgIHByaXZhdGUgcm9vdERpcjogRGlyZWN0b3J5LFxuICAgIHByaXZhdGUgb3B0aW9uczogUnVuT3B0aW9ucyxcbiAgKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxuICB9XG5cbiAgcHVibGljIGdldENhcHMoKTogR0hDTW9kQ2FwcyB7XG4gICAgcmV0dXJuIHRoaXMuY2Fwc1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHJ1bihcbiAgICBydW5BcmdzOiBSdW5BcmdzLFxuICApIHtcbiAgICBsZXQgeyBpbnRlcmFjdGl2ZSwgZGFzaEFyZ3MsIGFyZ3MsIHN1cHByZXNzRXJyb3JzLCBnaGNPcHRpb25zLCBnaGNNb2RPcHRpb25zIH0gPSBydW5BcmdzXG4gICAgY29uc3QgeyBjb21tYW5kLCB0ZXh0LCB1cmksIGJ1aWxkZXIgfSA9IHJ1bkFyZ3NcbiAgICBpZiAoIWFyZ3MpIHsgYXJncyA9IFtdIH1cbiAgICBpZiAoIWRhc2hBcmdzKSB7IGRhc2hBcmdzID0gW10gfVxuICAgIGlmICghc3VwcHJlc3NFcnJvcnMpIHsgc3VwcHJlc3NFcnJvcnMgPSBmYWxzZSB9XG4gICAgaWYgKCFnaGNPcHRpb25zKSB7IGdoY09wdGlvbnMgPSBbXSB9XG4gICAgaWYgKCFnaGNNb2RPcHRpb25zKSB7IGdoY01vZE9wdGlvbnMgPSBbXSB9XG4gICAgZ2hjTW9kT3B0aW9ucyA9IGdoY01vZE9wdGlvbnMuY29uY2F0KC4uLmdoY09wdGlvbnMubWFwKChvcHQpID0+IFsnLS1naGMtb3B0aW9uJywgb3B0XSkpXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmxvd01lbW9yeVN5c3RlbScpKSB7XG4gICAgICBpbnRlcmFjdGl2ZSA9IGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmVuYWJsZUdoY01vZGknKVxuICAgIH1cbiAgICBpZiAoYnVpbGRlcikge1xuICAgICAgc3dpdGNoIChidWlsZGVyKSB7XG4gICAgICAgIGNhc2UgJ2NhYmFsJzpcbiAgICAgICAgICAvLyBpbiBjYXNlIHRoaXMgbG9va3Mgd3JvbmcsIHJlbWVtYmVyLCB3ZSB3YW50IHRvIGRpc2FibGUgc3RhY2tcbiAgICAgICAgICAvLyBhbmQgdXNlIGNhYmFsLCBzbyB3ZSdyZSBzZXR0aW5nIHN0YWNrIHBhdGggdG8gZW1wdHlzdHJpbmdcbiAgICAgICAgICBnaGNNb2RPcHRpb25zLnB1c2goJy0td2l0aC1zdGFjaycsJycpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnc3RhY2snOlxuICAgICAgICAgIC8vIHNhbWUsIGlmIHRoaXMgbG9va3Mgc3RyYW5nZSwgaXQncyBub3RcbiAgICAgICAgICBnaGNNb2RPcHRpb25zLnB1c2goJy0td2l0aC1jYWJhbCcsJycpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnbm9uZSc6XG4gICAgICAgICAgLy8gaGVyZSB3ZSB3YW50IHRvIHVzZSBuZWl0aGVyP1xuICAgICAgICAgIGdoY01vZE9wdGlvbnMucHVzaCgnLS13aXRoLXN0YWNrJywnJylcbiAgICAgICAgICBnaGNNb2RPcHRpb25zLnB1c2goJy0td2l0aC1jYWJhbCcsJycpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyhcbiAgICAgICAgICAgIGBIYXNrZWxsLWdoYy1tb2Q6IHVua25vd24gYnVpbGRlciAke2J1aWxkZXJ9LCBmYWxsaW5nIGJhY2sgdG8gYXV0b2RldGVjdGlvbmAsXG4gICAgICAgICAgKVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5jYXBzLm9wdHBhcnNlKSB7XG4gICAgICBhcmdzID0gZGFzaEFyZ3MuY29uY2F0KFsnLS0nXSkuY29uY2F0KGFyZ3MpXG4gICAgfSBlbHNlIHtcbiAgICAgIGFyZ3MgPSBkYXNoQXJncy5jb25jYXQoYXJncylcbiAgICB9XG4gICAgY29uc3QgZnVuID0gaW50ZXJhY3RpdmUgPyB0aGlzLnJ1bk1vZGlDbWQgOiB0aGlzLnJ1bk1vZENtZFxuICAgIHRyeSB7XG4gICAgICBsZXQgcmVzXG4gICAgICBpZiAodXJpICYmIHRleHQgJiYgIXRoaXMuY2Fwcy5maWxlTWFwKSB7XG4gICAgICAgIGNvbnN0IG15T3B0cyA9IHsgZ2hjTW9kT3B0aW9ucywgY29tbWFuZCwgYXJncyB9XG4gICAgICAgIHJlcyA9IHdpdGhUZW1wRmlsZSh0ZXh0LCB1cmksIGFzeW5jICh0ZW1wdXJpKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBzdGRvdXQsIHN0ZGVyciB9ID0gYXdhaXQgZnVuKHsgLi4ubXlPcHRzLCB1cmk6IHRlbXB1cmkgfSlcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3Rkb3V0OiBzdGRvdXQubWFwKChsaW5lKSA9PiBsaW5lLnNwbGl0KHRlbXB1cmkpLmpvaW4odXJpKSksXG4gICAgICAgICAgICBzdGRlcnI6IHN0ZGVyci5tYXAoKGxpbmUpID0+IGxpbmUuc3BsaXQodGVtcHVyaSkuam9pbih1cmkpKSxcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMgPSBmdW4oeyBnaGNNb2RPcHRpb25zLCBjb21tYW5kLCB0ZXh0LCB1cmksIGFyZ3MgfSlcbiAgICAgIH1cbiAgICAgIGNvbnN0IHsgc3Rkb3V0LCBzdGRlcnIgfSA9IGF3YWl0IHJlc1xuICAgICAgaWYgKHN0ZGVyci5qb2luKCcnKS5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ3dhcm5pbmcnLCBzdGRlcnIuam9pbignXFxuJykpXG4gICAgICB9XG4gICAgICByZXR1cm4gc3Rkb3V0Lm1hcCgobGluZSkgPT4gbGluZS5yZXBsYWNlKC9cXDAvZywgJ1xcbicpKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgZGVidWcoZXJyKVxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby11bnNhZmUtYW55XG4gICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZXJyb3InLCB7IHJ1bkFyZ3MsIGVyciwgY2FwczogdGhpcy5jYXBzIH0pXG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gIH1cblxuICBwdWJsaWMga2lsbFByb2Nlc3MoKSB7XG4gICAgZGVidWcoYEtpbGxpbmcgZ2hjLW1vZGkgcHJvY2VzcyBmb3IgJHt0aGlzLnJvb3REaXIuZ2V0UGF0aCgpfWApXG4gICAgdGhpcy5wcm9jICYmIHRoaXMucHJvYy5raWxsKClcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIGRlYnVnKCdHaGNNb2RpUHJvY2Vzc0Jhc2UgZGVzdHJveWluZycpXG4gICAgdGhpcy5raWxsUHJvY2VzcygpXG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1kZXN0cm95JylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG5cbiAgcHVibGljIG9uRGlkRGVzdHJveShjYWxsYmFjazogKCkgPT4gdm9pZCkge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1kZXN0cm95JywgY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgb25XYXJuaW5nKGNhbGxiYWNrOiAod2FybmluZzogc3RyaW5nKSA9PiB2b2lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignd2FybmluZycsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIG9uRXJyb3IoY2FsbGJhY2s6IChlcnJvcjogSUVycm9yQ2FsbGJhY2tBcmdzKSA9PiB2b2lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZXJyb3InLCBjYWxsYmFjaylcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc3Bhd25Qcm9jZXNzKGdoY01vZE9wdGlvbnM6IHN0cmluZ1tdKTogUHJvbWlzZTxJbnRlcmFjdGl2ZVByb2Nlc3MgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoIWF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmVuYWJsZUdoY01vZGknKSkgeyByZXR1cm4gdW5kZWZpbmVkIH1cbiAgICBkZWJ1ZyhgQ2hlY2tpbmcgZm9yIGdoYy1tb2RpIGluICR7dGhpcy5yb290RGlyLmdldFBhdGgoKX1gKVxuICAgIGlmICh0aGlzLnByb2MpIHtcbiAgICAgIGlmICghXy5pc0VxdWFsKHRoaXMuZ2hjTW9kT3B0aW9ucywgZ2hjTW9kT3B0aW9ucykpIHtcbiAgICAgICAgZGVidWcoXG4gICAgICAgICAgYEZvdW5kIHJ1bm5pbmcgZ2hjLW1vZGkgaW5zdGFuY2UgZm9yICR7dGhpcy5yb290RGlyLmdldFBhdGgoKX0sIGJ1dCBnaGNNb2RPcHRpb25zIGRvbid0IG1hdGNoLiBPbGQ6IGAsXG4gICAgICAgICAgdGhpcy5naGNNb2RPcHRpb25zLCAnIG5ldzogJywgZ2hjTW9kT3B0aW9ucyxcbiAgICAgICAgKVxuICAgICAgICBhd2FpdCB0aGlzLnByb2Mua2lsbCgpXG4gICAgICAgIHJldHVybiB0aGlzLnNwYXduUHJvY2VzcyhnaGNNb2RPcHRpb25zKVxuICAgICAgfVxuICAgICAgZGVidWcoYEZvdW5kIHJ1bm5pbmcgZ2hjLW1vZGkgaW5zdGFuY2UgZm9yICR7dGhpcy5yb290RGlyLmdldFBhdGgoKX1gKVxuICAgICAgcmV0dXJuIHRoaXMucHJvY1xuICAgIH1cbiAgICBkZWJ1ZyhgU3Bhd25pbmcgbmV3IGdoYy1tb2RpIGluc3RhbmNlIGZvciAke3RoaXMucm9vdERpci5nZXRQYXRoKCl9IHdpdGhgLCB0aGlzLm9wdGlvbnMpXG4gICAgY29uc3QgbW9kUGF0aCA9IGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmdoY01vZFBhdGgnKVxuICAgIHRoaXMuZ2hjTW9kT3B0aW9ucyA9IGdoY01vZE9wdGlvbnNcbiAgICB0aGlzLnByb2MgPSBuZXcgSW50ZXJhY3RpdmVQcm9jZXNzKG1vZFBhdGgsIGdoY01vZE9wdGlvbnMuY29uY2F0KFsnbGVnYWN5LWludGVyYWN0aXZlJ10pLCB0aGlzLm9wdGlvbnMsIHRoaXMuY2FwcylcbiAgICB0aGlzLnByb2Mub25jZUV4aXQoKGNvZGUpID0+IHtcbiAgICAgIGRlYnVnKGBnaGMtbW9kaSBmb3IgJHt0aGlzLnJvb3REaXIuZ2V0UGF0aCgpfSBlbmRlZCB3aXRoICR7Y29kZX1gKVxuICAgICAgdGhpcy5wcm9jID0gdW5kZWZpbmVkXG4gICAgfSlcbiAgICByZXR1cm4gdGhpcy5wcm9jXG4gIH1cblxuICBwcml2YXRlIHJ1bk1vZENtZCA9IGFzeW5jIChcbiAgICB7XG4gICAgICBnaGNNb2RPcHRpb25zLCBjb21tYW5kLCB0ZXh0LCB1cmksIGFyZ3MsXG4gICAgfTogeyBnaGNNb2RPcHRpb25zOiBzdHJpbmdbXSwgY29tbWFuZDogc3RyaW5nLCB0ZXh0Pzogc3RyaW5nLCB1cmk/OiBzdHJpbmcsIGFyZ3M6IHN0cmluZ1tdIH0sXG4gICkgPT4ge1xuICAgIGNvbnN0IG1vZFBhdGggPSBhdG9tLmNvbmZpZy5nZXQoJ2hhc2tlbGwtZ2hjLW1vZC5naGNNb2RQYXRoJylcbiAgICBsZXQgc3RkaW5cbiAgICBjb25zdCBjbWQgPSBbLi4uZ2hjTW9kT3B0aW9uc11cbiAgICBpZiAodGV4dCAmJiB1cmkpIHtcbiAgICAgIGNtZC5wdXNoKCctLW1hcC1maWxlJywgdXJpKVxuICAgICAgc3RkaW4gPSBgJHt0ZXh0fSR7RU9UfWBcbiAgICB9XG4gICAgY21kLnB1c2goY29tbWFuZClcbiAgICBpZiAodXJpKSB7XG4gICAgICBjbWQucHVzaCh1cmkpXG4gICAgfVxuICAgIGNtZC5wdXNoKC4uLmFyZ3MpXG4gICAgY29uc3QgeyBzdGRvdXQsIHN0ZGVyciB9ID0gYXdhaXQgVXRpbC5leGVjUHJvbWlzZShtb2RQYXRoLCBjbWQsIHRoaXMub3B0aW9ucywgc3RkaW4pXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0ZG91dDogc3Rkb3V0LnNwbGl0KEVPTCkuc2xpY2UoMCwgLTEpLFxuICAgICAgc3RkZXJyOiBzdGRlcnIuc3BsaXQoRU9MKSxcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJ1bk1vZGlDbWQgPSBhc3luYyAoXG4gICAgbzogeyBnaGNNb2RPcHRpb25zOiBzdHJpbmdbXSwgY29tbWFuZDogc3RyaW5nLCB0ZXh0Pzogc3RyaW5nLCB1cmk/OiBzdHJpbmcsIGFyZ3M6IHN0cmluZ1tdIH0sXG4gICkgPT4ge1xuICAgIGNvbnN0IHsgZ2hjTW9kT3B0aW9ucywgY29tbWFuZCwgdGV4dCwgYXJncyB9ID0gb1xuICAgIGxldCB7IHVyaSB9ID0gb1xuICAgIGRlYnVnKGBUcnlpbmcgdG8gcnVuIGdoYy1tb2RpIGluICR7dGhpcy5yb290RGlyLmdldFBhdGgoKX1gKVxuICAgIGNvbnN0IHByb2MgPSBhd2FpdCB0aGlzLnNwYXduUHJvY2VzcyhnaGNNb2RPcHRpb25zKVxuICAgIGlmICghcHJvYykge1xuICAgICAgZGVidWcoJ0ZhaWxlZC4gRmFsbGluZyBiYWNrIHRvIGdoYy1tb2QnKVxuICAgICAgcmV0dXJuIHRoaXMucnVuTW9kQ21kKG8pXG4gICAgfVxuICAgIGRlYnVnKCdTdWNjZXNzLiBSZXN1bWluZy4uLicpXG4gICAgaWYgKHVyaSAmJiAhdGhpcy5jYXBzLnF1b3RlQXJncykgeyB1cmkgPSB0aGlzLnJvb3REaXIucmVsYXRpdml6ZSh1cmkpIH1cbiAgICB0cnkge1xuICAgICAgaWYgKHVyaSAmJiB0ZXh0KSB7XG4gICAgICAgIGF3YWl0IHByb2MuaW50ZXJhY3QoJ21hcC1maWxlJywgW3VyaV0sIHRleHQpXG4gICAgICB9XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCBwcm9jLmludGVyYWN0KGNvbW1hbmQsIHVyaSA/IFt1cmldLmNvbmNhdChhcmdzKSA6IGFyZ3MpXG4gICAgICBpZiAodXJpICYmIHRleHQpIHtcbiAgICAgICAgYXdhaXQgcHJvYy5pbnRlcmFjdCgndW5tYXAtZmlsZScsIFt1cmldKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc1xuICAgIH0gZmluYWxseSB7XG4gICAgICBpZiAodXJpICYmIHRleHQpIHtcbiAgICAgICAgYXdhaXQgcHJvYy5pbnRlcmFjdCgndW5tYXAtZmlsZScsIFt1cmldKVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19