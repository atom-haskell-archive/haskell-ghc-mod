"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const FZ = require("fuzzaldrin");
const atom_1 = require("atom");
const buffer_info_1 = require("./buffer-info");
const module_info_1 = require("./module-info");
const Util = require("../util");
class CompletionBackend {
    constructor(process) {
        this.process = process;
        this.bufferMap = new WeakMap();
        this.dirMap = new WeakMap();
        this.modListMap = new WeakMap();
        this.languagePragmas = new WeakMap();
        this.compilerOptions = new WeakMap();
        this.name = this.name.bind(this);
        this.onDidDestroy = this.onDidDestroy.bind(this);
        this.registerCompletionBuffer = this.registerCompletionBuffer.bind(this);
        this.unregisterCompletionBuffer = this.unregisterCompletionBuffer.bind(this);
        this.getCompletionsForSymbol = this.getCompletionsForSymbol.bind(this);
        this.getCompletionsForType = this.getCompletionsForType.bind(this);
        this.getCompletionsForClass = this.getCompletionsForClass.bind(this);
        this.getCompletionsForModule = this.getCompletionsForModule.bind(this);
        this.getCompletionsForSymbolInModule = this.getCompletionsForSymbolInModule.bind(this);
        this.getCompletionsForLanguagePragmas = this.getCompletionsForLanguagePragmas.bind(this);
        this.getCompletionsForCompilerOptions = this.getCompletionsForCompilerOptions.bind(this);
        this.getCompletionsForHole = this.getCompletionsForHole.bind(this);
        this.process = process;
        this.isActive = true;
        this.process.onDidDestroy(() => { this.isActive = false; });
    }
    name() { return 'haskell-ghc-mod'; }
    onDidDestroy(callback) {
        if (this.isActive) {
            return this.process.onDidDestroy(callback);
        }
    }
    registerCompletionBuffer(buffer) {
        if (this.bufferMap.has(buffer)) {
            return new atom_1.Disposable(() => { });
        }
        const { bufferInfo } = this.getBufferInfo({ buffer });
        setImmediate(() => __awaiter(this, void 0, void 0, function* () {
            const { rootDir, moduleMap } = yield this.getModuleMap({ bufferInfo });
            this.getModuleInfo({ bufferInfo, rootDir, moduleMap });
            const imports = yield bufferInfo.getImports();
            for (const imprt of imports) {
                this.getModuleInfo({ moduleName: imprt.name, bufferInfo, rootDir, moduleMap });
            }
        }));
        return new atom_1.Disposable(() => this.unregisterCompletionBuffer(buffer));
    }
    unregisterCompletionBuffer(buffer) {
        const x = this.bufferMap.get(buffer);
        if (x) {
            x.destroy();
        }
    }
    getCompletionsForSymbol(buffer, prefix, position) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.isActive) {
                throw new Error('Backend inactive');
            }
            const symbols = yield this.getSymbolsForBuffer(buffer);
            return this.filter(symbols, prefix, ['qname', 'qparent']);
        });
    }
    getCompletionsForType(buffer, prefix, position) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.isActive) {
                throw new Error('Backend inactive');
            }
            const symbols = yield this.getSymbolsForBuffer(buffer, ['type', 'class']);
            return FZ.filter(symbols, prefix, { key: 'qname' });
        });
    }
    getCompletionsForClass(buffer, prefix, position) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.isActive) {
                throw new Error('Backend inactive');
            }
            const symbols = yield this.getSymbolsForBuffer(buffer, ['class']);
            return FZ.filter(symbols, prefix, { key: 'qname' });
        });
    }
    getCompletionsForModule(buffer, prefix, position) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.isActive) {
                throw new Error('Backend inactive');
            }
            const rootDir = yield this.process.getRootDir(buffer);
            let modules = this.modListMap.get(rootDir);
            if (!modules) {
                modules = yield this.process.runList(buffer);
                this.modListMap.set(rootDir, modules);
                setTimeout((() => this.modListMap.delete(rootDir)), 60 * 1000);
            }
            return FZ.filter(modules, prefix);
        });
    }
    getCompletionsForSymbolInModule(buffer, prefix, position, opts) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.isActive) {
                throw new Error('Backend inactive');
            }
            let moduleName = opts ? opts.module : undefined;
            if (!moduleName) {
                const lineRange = new atom_1.Range([0, position.row], position);
                buffer.backwardsScanInRange(/^import\s+([\w.]+)/, lineRange, ({ match }) => moduleName = match[1]);
            }
            const { bufferInfo } = this.getBufferInfo({ buffer });
            const mis = yield this.getModuleInfo({ bufferInfo, moduleName });
            const symbols = mis.moduleInfo.select({
                qualified: false,
                hiding: false,
                name: moduleName || mis.moduleName,
                importList: null,
                alias: null
            }, undefined, true);
            return FZ.filter(symbols, prefix, { key: 'name' });
        });
    }
    getCompletionsForLanguagePragmas(buffer, prefix, position) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.isActive) {
                throw new Error('Backend inactive');
            }
            const dir = yield this.process.getRootDir(buffer);
            let ps = this.languagePragmas.get(dir);
            if (!ps) {
                ps = yield this.process.runLang(dir);
                ps && this.languagePragmas.set(dir, ps);
            }
            return FZ.filter(ps, prefix);
        });
    }
    getCompletionsForCompilerOptions(buffer, prefix, position) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.isActive) {
                throw new Error('Backend inactive');
            }
            const dir = yield this.process.getRootDir(buffer);
            let co = this.compilerOptions.get(dir);
            if (!co) {
                co = yield this.process.runFlag(dir);
                this.compilerOptions.set(dir, co);
            }
            return FZ.filter(co, prefix);
        });
    }
    getCompletionsForHole(buffer, prefix, position) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.isActive) {
                throw new Error('Backend inactive');
            }
            const range = new atom_1.Range(position, position);
            if (prefix.startsWith('_')) {
                prefix = prefix.slice(1);
            }
            const { type } = yield this.process.getTypeInBuffer(buffer, range);
            const symbols = yield this.getSymbolsForBuffer(buffer);
            const ts = symbols.filter((s) => {
                if (!s.typeSignature) {
                    return false;
                }
                const tl = s.typeSignature.split(' -> ').slice(-1)[0];
                if (tl.match(/^[a-z]$/)) {
                    return false;
                }
                const ts2 = tl.replace(/[.?*+^$[\]\\(){}|-]/g, '\\$&');
                const rx = RegExp(ts2.replace(/\b[a-z]\b/g, '.+'), '');
                return rx.test(type);
            });
            if (prefix.length === 0) {
                return ts.sort((a, b) => FZ.score(b.typeSignature, type) - FZ.score(a.typeSignature, type));
            }
            else {
                return FZ.filter(ts, prefix, { key: 'qname' });
            }
        });
    }
    getSymbolsForBuffer(buffer, symbolTypes) {
        return __awaiter(this, void 0, void 0, function* () {
            const { bufferInfo } = this.getBufferInfo({ buffer });
            const { rootDir, moduleMap } = yield this.getModuleMap({ bufferInfo });
            if (bufferInfo && moduleMap) {
                const imports = yield bufferInfo.getImports();
                const promises = yield Promise.all(imports.map((imp) => __awaiter(this, void 0, void 0, function* () {
                    const res = yield this.getModuleInfo({
                        bufferInfo,
                        moduleName: imp.name,
                        rootDir,
                        moduleMap
                    });
                    if (!res) {
                        return [];
                    }
                    return res.moduleInfo.select(imp, symbolTypes);
                })));
                return [].concat(...promises);
            }
            else {
                return [];
            }
        });
    }
    getBufferInfo({ buffer }) {
        let bi = this.bufferMap.get(buffer);
        if (!bi) {
            bi = new buffer_info_1.BufferInfo(buffer);
            this.bufferMap.set(buffer, bi);
        }
        return { bufferInfo: bi };
    }
    getModuleMap({ bufferInfo, rootDir }) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!rootDir) {
                rootDir = yield this.process.getRootDir(bufferInfo.buffer);
            }
            let mm = this.dirMap.get(rootDir);
            if (!mm) {
                mm = new Map();
                this.dirMap.set(rootDir, mm);
            }
            return {
                rootDir,
                moduleMap: mm
            };
        });
    }
    getModuleInfo(arg) {
        return __awaiter(this, void 0, void 0, function* () {
            const { bufferInfo } = arg;
            let dat;
            if (arg.rootDir && arg.moduleMap) {
                dat = { rootDir: arg.rootDir, moduleMap: arg.moduleMap };
            }
            else {
                dat = yield this.getModuleMap({ bufferInfo });
            }
            const { moduleMap, rootDir } = dat;
            let moduleName = arg.moduleName;
            if (!moduleName) {
                moduleName = yield bufferInfo.getModuleName();
            }
            if (!moduleName) {
                throw new Error(`Nameless module in ${bufferInfo.buffer.getUri()}`);
            }
            let moduleInfo = moduleMap.get(moduleName);
            if (!moduleInfo) {
                moduleInfo = new module_info_1.ModuleInfo(moduleName, this.process, rootDir);
                moduleMap.set(moduleName, moduleInfo);
                const mn = moduleName;
                moduleInfo.onDidDestroy(() => {
                    moduleMap.delete(mn);
                    return Util.debug(`${moduleName} removed from map`);
                });
                yield moduleInfo.initialUpdatePromise;
            }
            moduleInfo.setBuffer(bufferInfo);
            return { bufferInfo, rootDir, moduleMap, moduleInfo, moduleName };
        });
    }
    filter(candidates, prefix, keys) {
        if (!prefix) {
            return candidates;
        }
        const list = [];
        for (const candidate of candidates) {
            const scores = keys.map((key) => {
                const ck = candidate[key];
                if (ck) {
                    return FZ.score(ck.toString(), prefix);
                }
                else {
                    return 0;
                }
            });
            const score = Math.max(...scores);
            if (score > 0) {
                list.push({
                    score,
                    scoreN: scores.indexOf(score),
                    data: candidate
                });
            }
        }
        return list.sort((a, b) => {
            const s = b.score - a.score;
            if (s === 0) {
                return a.scoreN - b.scoreN;
            }
            return s;
        }).map(({ data }) => data);
    }
}
exports.CompletionBackend = CompletionBackend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tcGxldGlvbi1iYWNrZW5kL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFXQSxpQ0FBZ0M7QUFDaEMsK0JBQXdDO0FBQ3hDLCtDQUFpRDtBQUNqRCwrQ0FBd0M7QUFFeEMsZ0NBQStCO0FBYS9CO0lBUUUsWUFBcUIsT0FBdUI7UUFBdkIsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFDMUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBQzlCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUMzQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFDL0IsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBQ3BDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUdwQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDaEQsSUFBSSxDQUFDLHdCQUF3QixHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDeEUsSUFBSSxDQUFDLDBCQUEwQixHQUFHLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUUsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDdEUsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENB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QixFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDWixNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFBO1lBQzVCLENBQUM7WUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFBO1FBQ1YsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBQyxJQUFJLEVBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQTtJQUM1QixDQUFDO0NBQ0Y7QUFyYkQsOENBcWJDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIGRlY2FmZmVpbmF0ZSBzdWdnZXN0aW9uczpcbiAqIERTMTAxOiBSZW1vdmUgdW5uZWNlc3NhcnkgdXNlIG9mIEFycmF5LmZyb21cbiAqIERTMTAyOiBSZW1vdmUgdW5uZWNlc3NhcnkgY29kZSBjcmVhdGVkIGJlY2F1c2Ugb2YgaW1wbGljaXQgcmV0dXJuc1xuICogRFMxMDM6IFJld3JpdGUgY29kZSB0byBubyBsb25nZXIgdXNlIF9fZ3VhcmRfX1xuICogRFMxMDQ6IEF2b2lkIGlubGluZSBhc3NpZ25tZW50c1xuICogRFMyMDU6IENvbnNpZGVyIHJld29ya2luZyBjb2RlIHRvIGF2b2lkIHVzZSBvZiBJSUZFc1xuICogRFMyMDY6IENvbnNpZGVyIHJld29ya2luZyBjbGFzc2VzIHRvIGF2b2lkIGluaXRDbGFzc1xuICogRFMyMDc6IENvbnNpZGVyIHNob3J0ZXIgdmFyaWF0aW9ucyBvZiBudWxsIGNoZWNrc1xuICogRnVsbCBkb2NzOiBodHRwczovL2dpdGh1Yi5jb20vZGVjYWZmZWluYXRlL2RlY2FmZmVpbmF0ZS9ibG9iL21hc3Rlci9kb2NzL3N1Z2dlc3Rpb25zLm1kXG4gKi9cbmltcG9ydCAqIGFzIEZaIGZyb20gJ2Z1enphbGRyaW4nXG5pbXBvcnQgeyBEaXNwb3NhYmxlLCBSYW5nZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQge0J1ZmZlckluZm8sIElJbXBvcnR9IGZyb20gJy4vYnVmZmVyLWluZm8nXG5pbXBvcnQge01vZHVsZUluZm99IGZyb20gJy4vbW9kdWxlLWluZm8nXG5pbXBvcnQge0doY01vZGlQcm9jZXNzLCBTeW1ib2xUeXBlfSBmcm9tICcuLi9naGMtbW9kJ1xuaW1wb3J0ICogYXMgVXRpbCBmcm9tICcuLi91dGlsJ1xuXG5leHBvcnQge0lJbXBvcnQsIFN5bWJvbFR5cGV9XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVN5bWJvbCB7XG4gICAgcXBhcmVudDogc3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgcW5hbWU6IHN0cmluZ1xuICAgIG5hbWU6IHN0cmluZ1xuICAgIHR5cGVTaWduYXR1cmU6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgIHN5bWJvbFR5cGU6IFN5bWJvbFR5cGVcbiAgICBtb2R1bGU6IElJbXBvcnRcbn1cblxuZXhwb3J0IGNsYXNzIENvbXBsZXRpb25CYWNrZW5kIHtcbiAgcHJpdmF0ZSBidWZmZXJNYXA6IFdlYWtNYXA8QXRvbVR5cGVzLlRleHRCdWZmZXIsIEJ1ZmZlckluZm8+XG4gIHByaXZhdGUgZGlyTWFwOiBXZWFrTWFwPEF0b21UeXBlcy5EaXJlY3RvcnksIE1hcDxzdHJpbmcsIE1vZHVsZUluZm8+PlxuICBwcml2YXRlIG1vZExpc3RNYXA6IFdlYWtNYXA8QXRvbVR5cGVzLkRpcmVjdG9yeSwgc3RyaW5nW10+XG4gIHByaXZhdGUgbGFuZ3VhZ2VQcmFnbWFzOiBXZWFrTWFwPEF0b21UeXBlcy5EaXJlY3RvcnksIHN0cmluZ1tdPlxuICBwcml2YXRlIGNvbXBpbGVyT3B0aW9uczogV2Vha01hcDxBdG9tVHlwZXMuRGlyZWN0b3J5LCBzdHJpbmdbXT5cbiAgcHJpdmF0ZSBpc0FjdGl2ZTogYm9vbGVhblxuXG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIHByb2Nlc3M6IEdoY01vZGlQcm9jZXNzKSB7XG4gICAgdGhpcy5idWZmZXJNYXAgPSBuZXcgV2Vha01hcCgpXG4gICAgdGhpcy5kaXJNYXAgPSBuZXcgV2Vha01hcCgpXG4gICAgdGhpcy5tb2RMaXN0TWFwID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMubGFuZ3VhZ2VQcmFnbWFzID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMuY29tcGlsZXJPcHRpb25zID0gbmV3IFdlYWtNYXAoKVxuXG4gICAgLy8gY29tcGF0aWJpbGl0eSB3aXRoIG9sZCBjbGllbnRzXG4gICAgdGhpcy5uYW1lID0gdGhpcy5uYW1lLmJpbmQodGhpcylcbiAgICB0aGlzLm9uRGlkRGVzdHJveSA9IHRoaXMub25EaWREZXN0cm95LmJpbmQodGhpcylcbiAgICB0aGlzLnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlciA9IHRoaXMucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyLmJpbmQodGhpcylcbiAgICB0aGlzLnVucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyID0gdGhpcy51bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlci5iaW5kKHRoaXMpXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbCA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2wuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JUeXBlID0gdGhpcy5nZXRDb21wbGV0aW9uc0ZvclR5cGUuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDbGFzcyA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDbGFzcy5iaW5kKHRoaXMpXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0Zvck1vZHVsZSA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZSA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZS5iaW5kKHRoaXMpXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0Zvckxhbmd1YWdlUHJhZ21hcyA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JMYW5ndWFnZVByYWdtYXMuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDb21waWxlck9wdGlvbnMgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zLmJpbmQodGhpcylcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9ySG9sZSA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JIb2xlLmJpbmQodGhpcylcblxuICAgIHRoaXMucHJvY2VzcyA9IHByb2Nlc3NcbiAgICB0aGlzLmlzQWN0aXZlID0gdHJ1ZVxuICAgIHRoaXMucHJvY2Vzcy5vbkRpZERlc3Ryb3koKCkgPT4geyB0aGlzLmlzQWN0aXZlID0gZmFsc2UgfSlcbiAgfVxuXG4gIC8qIFB1YmxpYyBpbnRlcmZhY2UgYmVsb3cgKi9cblxuICAvKlxuICBuYW1lKClcbiAgR2V0IGJhY2tlbmQgbmFtZVxuXG4gIFJldHVybnMgU3RyaW5nLCB1bmlxdWUgc3RyaW5nIGRlc2NyaWJpbmcgYSBnaXZlbiBiYWNrZW5kXG4gICovXG4gIHB1YmxpYyBuYW1lICgpIHsgcmV0dXJuICdoYXNrZWxsLWdoYy1tb2QnIH1cblxuICAvKlxuICBvbkRpZERlc3Ryb3koY2FsbGJhY2spXG4gIERlc3RydWN0aW9uIGV2ZW50IHN1YnNjcmlwdGlvbi4gVXN1YWxseSBzaG91bGQgYmUgY2FsbGVkIG9ubHkgb25cbiAgcGFja2FnZSBkZWFjdGl2YXRpb24uXG4gIGNhbGxiYWNrOiAoKSAtPlxuICAqL1xuICBwdWJsaWMgb25EaWREZXN0cm95IChjYWxsYmFjazogKCkgPT4gdm9pZCkge1xuICAgIGlmICh0aGlzLmlzQWN0aXZlKSB7IHJldHVybiB0aGlzLnByb2Nlc3Mub25EaWREZXN0cm95KGNhbGxiYWNrKSB9XG4gIH1cblxuICAvKlxuICByZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyKVxuICBFdmVyeSBidWZmZXIgdGhhdCB3b3VsZCBiZSB1c2VkIHdpdGggYXV0b2NvbXBsZXRpb24gZnVuY3Rpb25zIGhhcyB0b1xuICBiZSByZWdpc3RlcmVkIHdpdGggdGhpcyBmdW5jdGlvbi5cblxuICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0byBiZSB1c2VkIGluIGF1dG9jb21wbGV0aW9uXG5cbiAgUmV0dXJuczogRGlzcG9zYWJsZSwgd2hpY2ggd2lsbCByZW1vdmUgYnVmZmVyIGZyb20gYXV0b2NvbXBsZXRpb25cbiAgKi9cbiAgcHVibGljIHJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlciAoYnVmZmVyOiBBdG9tVHlwZXMuVGV4dEJ1ZmZlcikge1xuICAgIGlmICh0aGlzLmJ1ZmZlck1hcC5oYXMoYnVmZmVyKSkge1xuICAgICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHsgLyogdm9pZCAqLyB9KVxuICAgIH1cblxuICAgIGNvbnN0IHsgYnVmZmVySW5mbyB9ID0gdGhpcy5nZXRCdWZmZXJJbmZvKHsgYnVmZmVyIH0pXG5cbiAgICBzZXRJbW1lZGlhdGUoYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgeyByb290RGlyLCBtb2R1bGVNYXAgfSA9IGF3YWl0IHRoaXMuZ2V0TW9kdWxlTWFwKHsgYnVmZmVySW5mbyB9KVxuXG4gICAgICB0aGlzLmdldE1vZHVsZUluZm8oeyBidWZmZXJJbmZvLCByb290RGlyLCBtb2R1bGVNYXAgfSlcblxuICAgICAgY29uc3QgaW1wb3J0cyA9IGF3YWl0IGJ1ZmZlckluZm8uZ2V0SW1wb3J0cygpXG4gICAgICBmb3IgKGNvbnN0IGltcHJ0IG9mIGltcG9ydHMpIHtcbiAgICAgICAgdGhpcy5nZXRNb2R1bGVJbmZvKHsgbW9kdWxlTmFtZTogaW1wcnQubmFtZSwgYnVmZmVySW5mbywgcm9vdERpciwgbW9kdWxlTWFwIH0pXG4gICAgICB9XG4gICAgfSlcblxuICAgIHJldHVybiBuZXcgRGlzcG9zYWJsZSgoKSA9PlxuICAgICAgdGhpcy51bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlcihidWZmZXIpKVxuICB9XG5cbiAgLypcbiAgdW5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyKVxuICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0byBiZSByZW1vdmVkIGZyb20gYXV0b2NvbXBsZXRpb25cbiAgKi9cbiAgcHVibGljIHVucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyIChidWZmZXI6IEF0b21UeXBlcy5UZXh0QnVmZmVyKSB7XG4gICAgY29uc3QgeCA9IHRoaXMuYnVmZmVyTWFwLmdldChidWZmZXIpXG4gICAgaWYgKHgpIHtcbiAgICAgIHguZGVzdHJveSgpXG4gICAgfVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2woYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXG4gIHN5bWJvbDogT2JqZWN0LCBhIGNvbXBsZXRpb24gc3ltYm9sXG4gICAgbmFtZTogU3RyaW5nLCBzeW1ib2wgbmFtZVxuICAgIHFuYW1lOiBTdHJpbmcsIHF1YWxpZmllZCBuYW1lLCBpZiBtb2R1bGUgaXMgcXVhbGlmaWVkLlxuICAgICAgICAgICBPdGhlcndpc2UsIHNhbWUgYXMgbmFtZVxuICAgIHR5cGVTaWduYXR1cmU6IFN0cmluZywgdHlwZSBzaWduYXR1cmVcbiAgICBzeW1ib2xUeXBlOiBTdHJpbmcsIG9uZSBvZiBbJ3R5cGUnLCAnY2xhc3MnLCAnZnVuY3Rpb24nXVxuICAgIG1vZHVsZTogT2JqZWN0LCBzeW1ib2wgbW9kdWxlIGluZm9ybWF0aW9uXG4gICAgICBxdWFsaWZpZWQ6IEJvb2xlYW4sIHRydWUgaWYgbW9kdWxlIGlzIGltcG9ydGVkIGFzIHF1YWxpZmllZFxuICAgICAgbmFtZTogU3RyaW5nLCBtb2R1bGUgbmFtZVxuICAgICAgYWxpYXM6IFN0cmluZywgbW9kdWxlIGFsaWFzXG4gICAgICBoaWRpbmc6IEJvb2xlYW4sIHRydWUgaWYgbW9kdWxlIGlzIGltcG9ydGVkIHdpdGggaGlkaW5nIGNsYXVzZVxuICAgICAgaW1wb3J0TGlzdDogW1N0cmluZ10sIGFycmF5IG9mIGV4cGxpY2l0IGltcG9ydHMvaGlkZGVuIGltcG9ydHNcbiAgKi9cbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yU3ltYm9sIChcbiAgICBidWZmZXI6IEF0b21UeXBlcy5UZXh0QnVmZmVyLCBwcmVmaXg6IHN0cmluZywgcG9zaXRpb246IEF0b21UeXBlcy5Qb2ludFxuICApOiBQcm9taXNlPElTeW1ib2xbXT4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XG5cbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgdGhpcy5nZXRTeW1ib2xzRm9yQnVmZmVyKGJ1ZmZlcilcbiAgICByZXR1cm4gdGhpcy5maWx0ZXIoc3ltYm9scywgcHJlZml4LCBbJ3FuYW1lJywgJ3FwYXJlbnQnXSlcbiAgfVxuXG4gIC8qXG4gIGdldENvbXBsZXRpb25zRm9yVHlwZShidWZmZXIscHJlZml4LHBvc2l0aW9uKVxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXG5cbiAgUmV0dXJuczogUHJvbWlzZShbc3ltYm9sXSlcbiAgc3ltYm9sOiBTYW1lIGFzIGdldENvbXBsZXRpb25zRm9yU3ltYm9sLCBleGNlcHRcbiAgICAgICAgICBzeW1ib2xUeXBlIGlzIG9uZSBvZiBbJ3R5cGUnLCAnY2xhc3MnXVxuICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JUeXBlIChcbiAgICBidWZmZXI6IEF0b21UeXBlcy5UZXh0QnVmZmVyLCBwcmVmaXg6IHN0cmluZywgcG9zaXRpb246IEF0b21UeXBlcy5Qb2ludFxuICApOiBQcm9taXNlPElTeW1ib2xbXT4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XG5cbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgdGhpcy5nZXRTeW1ib2xzRm9yQnVmZmVyKGJ1ZmZlciwgWyd0eXBlJywgJ2NsYXNzJ10pXG4gICAgcmV0dXJuIEZaLmZpbHRlcihzeW1ib2xzLCBwcmVmaXgsIHtrZXk6ICdxbmFtZSd9KVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JDbGFzcyhidWZmZXIscHJlZml4LHBvc2l0aW9uKVxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXG5cbiAgUmV0dXJuczogUHJvbWlzZShbc3ltYm9sXSlcbiAgc3ltYm9sOiBTYW1lIGFzIGdldENvbXBsZXRpb25zRm9yU3ltYm9sLCBleGNlcHRcbiAgICAgICAgICBzeW1ib2xUeXBlIGlzIG9uZSBvZiBbJ2NsYXNzJ11cbiAgKi9cbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yQ2xhc3MgKFxuICAgIGJ1ZmZlcjogQXRvbVR5cGVzLlRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBwb3NpdGlvbjogQXRvbVR5cGVzLlBvaW50XG4gICk6IFByb21pc2U8SVN5bWJvbFtdPiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7IHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpIH1cblxuICAgIGNvbnN0IHN5bWJvbHMgPSBhd2FpdCB0aGlzLmdldFN5bWJvbHNGb3JCdWZmZXIoYnVmZmVyLCBbJ2NsYXNzJ10pXG4gICAgcmV0dXJuIEZaLmZpbHRlcihzeW1ib2xzLCBwcmVmaXgsIHtrZXk6ICdxbmFtZSd9KVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuXG4gIFJldHVybnM6IFByb21pc2UoW21vZHVsZV0pXG4gIG1vZHVsZTogU3RyaW5nLCBtb2R1bGUgbmFtZVxuICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUgKFxuICAgIGJ1ZmZlcjogQXRvbVR5cGVzLlRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBwb3NpdGlvbjogQXRvbVR5cGVzLlBvaW50XG4gICk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHsgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJykgfVxuICAgIGNvbnN0IHJvb3REaXIgPSBhd2FpdCB0aGlzLnByb2Nlc3MuZ2V0Um9vdERpcihidWZmZXIpXG4gICAgbGV0IG1vZHVsZXMgPSB0aGlzLm1vZExpc3RNYXAuZ2V0KHJvb3REaXIpXG4gICAgaWYgKCEgbW9kdWxlcykge1xuICAgICAgbW9kdWxlcyA9IGF3YWl0IHRoaXMucHJvY2Vzcy5ydW5MaXN0KGJ1ZmZlcilcbiAgICAgIHRoaXMubW9kTGlzdE1hcC5zZXQocm9vdERpciwgbW9kdWxlcylcbiAgICAgIC8vIHJlZnJlc2ggZXZlcnkgbWludXRlXG4gICAgICBzZXRUaW1lb3V0KCgoKSA9PiB0aGlzLm1vZExpc3RNYXAuZGVsZXRlKHJvb3REaXIpKSwgNjAgKiAxMDAwKVxuICAgIH1cbiAgICByZXR1cm4gRlouZmlsdGVyKG1vZHVsZXMsIHByZWZpeClcbiAgfVxuXG4gIC8qXG4gIGdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUoYnVmZmVyLHByZWZpeCxwb3NpdGlvbix7bW9kdWxlfSlcbiAgVXNlZCBpbiBpbXBvcnQgaGlkaW5nL2xpc3QgY29tcGxldGlvbnNcblxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXG4gIG1vZHVsZTogU3RyaW5nLCBtb2R1bGUgbmFtZSAob3B0aW9uYWwpLiBJZiB1bmRlZmluZWQsIGZ1bmN0aW9uXG4gICAgICAgICAgd2lsbCBhdHRlbXB0IHRvIGluZmVyIG1vZHVsZSBuYW1lIGZyb20gcG9zaXRpb24gYW5kIGJ1ZmZlci5cblxuICBSZXR1cm5zOiBQcm9taXNlKFtzeW1ib2xdKVxuICBzeW1ib2w6IE9iamVjdCwgc3ltYm9sIGluIGdpdmVuIG1vZHVsZVxuICAgIG5hbWU6IFN0cmluZywgc3ltYm9sIG5hbWVcbiAgICB0eXBlU2lnbmF0dXJlOiBTdHJpbmcsIHR5cGUgc2lnbmF0dXJlXG4gICAgc3ltYm9sVHlwZTogU3RyaW5nLCBvbmUgb2YgWyd0eXBlJywgJ2NsYXNzJywgJ2Z1bmN0aW9uJ11cbiAgKi9cbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yU3ltYm9sSW5Nb2R1bGUgKFxuICAgIGJ1ZmZlcjogQXRvbVR5cGVzLlRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBwb3NpdGlvbjogQXRvbVR5cGVzLlBvaW50LFxuICAgIG9wdHM/OiB7bW9kdWxlOiBzdHJpbmd9XG4gICk6IFByb21pc2U8SVN5bWJvbFtdPiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7IHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpIH1cbiAgICBsZXQgbW9kdWxlTmFtZSA9IG9wdHMgPyBvcHRzLm1vZHVsZSA6IHVuZGVmaW5lZFxuICAgIGlmICghbW9kdWxlTmFtZSkge1xuICAgICAgY29uc3QgbGluZVJhbmdlID0gbmV3IFJhbmdlKFswLCBwb3NpdGlvbi5yb3ddLCBwb3NpdGlvbilcbiAgICAgIGJ1ZmZlci5iYWNrd2FyZHNTY2FuSW5SYW5nZSgvXmltcG9ydFxccysoW1xcdy5dKykvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVSYW5nZSwgKHttYXRjaH0pID0+IG1vZHVsZU5hbWUgPSBtYXRjaFsxXSlcbiAgICB9XG5cbiAgICBjb25zdCB7YnVmZmVySW5mb30gPSB0aGlzLmdldEJ1ZmZlckluZm8oe2J1ZmZlcn0pXG4gICAgY29uc3QgbWlzID0gYXdhaXQgdGhpcy5nZXRNb2R1bGVJbmZvKHtidWZmZXJJbmZvLCBtb2R1bGVOYW1lfSlcblxuICAgIC8vIHRzbGludDpkaXNhYmxlOiBuby1udWxsLWtleXdvcmRcbiAgICBjb25zdCBzeW1ib2xzID0gbWlzLm1vZHVsZUluZm8uc2VsZWN0KFxuICAgICAge1xuICAgICAgICBxdWFsaWZpZWQ6IGZhbHNlLFxuICAgICAgICBoaWRpbmc6IGZhbHNlLFxuICAgICAgICBuYW1lOiBtb2R1bGVOYW1lIHx8IG1pcy5tb2R1bGVOYW1lLFxuICAgICAgICBpbXBvcnRMaXN0OiBudWxsLFxuICAgICAgICBhbGlhczogbnVsbFxuICAgICAgfSxcbiAgICAgIHVuZGVmaW5lZCxcbiAgICAgIHRydWVcbiAgICApXG4gICAgLy8gdHNsaW50OmVuYWJsZTogbm8tbnVsbC1rZXl3b3JkXG4gICAgcmV0dXJuIEZaLmZpbHRlcihzeW1ib2xzLCBwcmVmaXgsIHtrZXk6ICduYW1lJ30pXG4gIH1cblxuICAvKlxuICBnZXRDb21wbGV0aW9uc0Zvckxhbmd1YWdlUHJhZ21hcyhidWZmZXIscHJlZml4LHBvc2l0aW9uKVxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXG5cbiAgUmV0dXJuczogUHJvbWlzZShbcHJhZ21hXSlcbiAgcHJhZ21hOiBTdHJpbmcsIGxhbmd1YWdlIG9wdGlvblxuICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JMYW5ndWFnZVByYWdtYXMgKFxuICAgIGJ1ZmZlcjogQXRvbVR5cGVzLlRleHRCdWZmZXIsIHByZWZpeDogc3RyaW5nLCBwb3NpdGlvbjogQXRvbVR5cGVzLlBvaW50XG4gICk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHsgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJykgfVxuXG4gICAgY29uc3QgZGlyID0gYXdhaXQgdGhpcy5wcm9jZXNzLmdldFJvb3REaXIoYnVmZmVyKVxuXG4gICAgbGV0IHBzID0gdGhpcy5sYW5ndWFnZVByYWdtYXMuZ2V0KGRpcilcbiAgICBpZiAoISBwcykge1xuICAgICAgcHMgPSBhd2FpdCB0aGlzLnByb2Nlc3MucnVuTGFuZyhkaXIpXG4gICAgICBwcyAmJiB0aGlzLmxhbmd1YWdlUHJhZ21hcy5zZXQoZGlyLCBwcylcbiAgICB9XG4gICAgcmV0dXJuIEZaLmZpbHRlcihwcywgcHJlZml4KVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JDb21waWxlck9wdGlvbnMoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuXG4gIFJldHVybnM6IFByb21pc2UoW2doY29wdF0pXG4gIGdoY29wdDogU3RyaW5nLCBjb21waWxlciBvcHRpb24gKHN0YXJ0cyB3aXRoICctZicpXG4gICovXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0ZvckNvbXBpbGVyT3B0aW9ucyAoXG4gICAgYnVmZmVyOiBBdG9tVHlwZXMuVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIHBvc2l0aW9uOiBBdG9tVHlwZXMuUG9pbnRcbiAgKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkgeyB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKSB9XG5cbiAgICBjb25zdCBkaXIgPSBhd2FpdCB0aGlzLnByb2Nlc3MuZ2V0Um9vdERpcihidWZmZXIpXG5cbiAgICBsZXQgY28gPSB0aGlzLmNvbXBpbGVyT3B0aW9ucy5nZXQoZGlyKVxuICAgIGlmICghIGNvKSB7XG4gICAgICBjbyA9IGF3YWl0IHRoaXMucHJvY2Vzcy5ydW5GbGFnKGRpcilcbiAgICAgIHRoaXMuY29tcGlsZXJPcHRpb25zLnNldChkaXIsIGNvKVxuICAgIH1cbiAgICByZXR1cm4gRlouZmlsdGVyKGNvLCBwcmVmaXgpXG4gIH1cblxuICAvKlxuICBnZXRDb21wbGV0aW9uc0ZvckhvbGUoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgR2V0IGNvbXBsZXRpb25zIGJhc2VkIG9uIGV4cHJlc3Npb24gdHlwZS5cbiAgSXQgaXMgYXNzdW1lZCB0aGF0IGBwcmVmaXhgIHN0YXJ0cyB3aXRoICdfJ1xuXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cblxuICBSZXR1cm5zOiBQcm9taXNlKFtzeW1ib2xdKVxuICBzeW1ib2w6IFNhbWUgYXMgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xcbiAgKi9cbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9ySG9sZSAoXG4gICAgYnVmZmVyOiBBdG9tVHlwZXMuVGV4dEJ1ZmZlciwgcHJlZml4OiBzdHJpbmcsIHBvc2l0aW9uOiBBdG9tVHlwZXMuUG9pbnRcbiAgKTogUHJvbWlzZTxJU3ltYm9sW10+IHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHsgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJykgfVxuICAgIGNvbnN0IHJhbmdlID0gbmV3IFJhbmdlKHBvc2l0aW9uLCBwb3NpdGlvbilcbiAgICBpZiAocHJlZml4LnN0YXJ0c1dpdGgoJ18nKSkgeyBwcmVmaXggPSBwcmVmaXguc2xpY2UoMSkgfVxuICAgIGNvbnN0IHt0eXBlfSA9IGF3YWl0IHRoaXMucHJvY2Vzcy5nZXRUeXBlSW5CdWZmZXIoYnVmZmVyLCByYW5nZSlcbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgdGhpcy5nZXRTeW1ib2xzRm9yQnVmZmVyKGJ1ZmZlcilcbiAgICBjb25zdCB0cyA9IHN5bWJvbHMuZmlsdGVyKChzKSA9PiB7XG4gICAgICBpZiAoISBzLnR5cGVTaWduYXR1cmUpIHsgcmV0dXJuIGZhbHNlIH1cbiAgICAgIGNvbnN0IHRsID0gcy50eXBlU2lnbmF0dXJlLnNwbGl0KCcgLT4gJykuc2xpY2UoLTEpWzBdXG4gICAgICBpZiAodGwubWF0Y2goL15bYS16XSQvKSkgeyByZXR1cm4gZmFsc2UgfVxuICAgICAgY29uc3QgdHMyID0gdGwucmVwbGFjZSgvWy4/KiteJFtcXF1cXFxcKCl7fXwtXS9nLCAnXFxcXCQmJylcbiAgICAgIGNvbnN0IHJ4ID0gUmVnRXhwKHRzMi5yZXBsYWNlKC9cXGJbYS16XVxcYi9nLCAnLisnKSwgJycpXG4gICAgICByZXR1cm4gcngudGVzdCh0eXBlKVxuICAgIH0pXG4gICAgaWYgKHByZWZpeC5sZW5ndGggPT09IDApIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICByZXR1cm4gdHMuc29ydCgoYSwgYikgPT4gRlouc2NvcmUoYi50eXBlU2lnbmF0dXJlISwgdHlwZSkgLSBGWi5zY29yZShhLnR5cGVTaWduYXR1cmUhLCB0eXBlKSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIEZaLmZpbHRlcih0cywgcHJlZml4LCB7a2V5OiAncW5hbWUnfSlcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFN5bWJvbHNGb3JCdWZmZXIgKGJ1ZmZlcjogQXRvbVR5cGVzLlRleHRCdWZmZXIsIHN5bWJvbFR5cGVzPzogU3ltYm9sVHlwZVtdKTogUHJvbWlzZTxJU3ltYm9sW10+IHtcbiAgICBjb25zdCB7YnVmZmVySW5mb30gPSB0aGlzLmdldEJ1ZmZlckluZm8oe2J1ZmZlcn0pXG4gICAgY29uc3Qge3Jvb3REaXIsIG1vZHVsZU1hcH0gPSBhd2FpdCB0aGlzLmdldE1vZHVsZU1hcCh7YnVmZmVySW5mb30pXG4gICAgaWYgKGJ1ZmZlckluZm8gJiYgbW9kdWxlTWFwKSB7XG4gICAgICBjb25zdCBpbXBvcnRzID0gYXdhaXQgYnVmZmVySW5mby5nZXRJbXBvcnRzKClcbiAgICAgIGNvbnN0IHByb21pc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIGltcG9ydHMubWFwKGFzeW5jIChpbXApID0+IHtcbiAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmdldE1vZHVsZUluZm8oe1xuICAgICAgICAgICAgYnVmZmVySW5mbyxcbiAgICAgICAgICAgIG1vZHVsZU5hbWU6IGltcC5uYW1lLFxuICAgICAgICAgICAgcm9vdERpcixcbiAgICAgICAgICAgIG1vZHVsZU1hcFxuICAgICAgICAgIH0pXG4gICAgICAgICAgaWYgKCFyZXMpIHsgcmV0dXJuIFtdIH1cbiAgICAgICAgICByZXR1cm4gcmVzLm1vZHVsZUluZm8uc2VsZWN0KGltcCwgc3ltYm9sVHlwZXMpXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgICByZXR1cm4gKFtdIGFzIHR5cGVvZiBwcm9taXNlc1swXSkuY29uY2F0KC4uLnByb21pc2VzKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEJ1ZmZlckluZm8gKHtidWZmZXJ9OiB7YnVmZmVyOiBBdG9tVHlwZXMuVGV4dEJ1ZmZlcn0pOiB7YnVmZmVySW5mbzogQnVmZmVySW5mb30ge1xuICAgIGxldCBiaSA9IHRoaXMuYnVmZmVyTWFwLmdldChidWZmZXIpXG4gICAgaWYgKCEgYmkpIHtcbiAgICAgIGJpID0gbmV3IEJ1ZmZlckluZm8oYnVmZmVyKVxuICAgICAgdGhpcy5idWZmZXJNYXAuc2V0KGJ1ZmZlciwgYmkpXG4gICAgfVxuICAgIHJldHVybiB7YnVmZmVySW5mbzogYml9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldE1vZHVsZU1hcCAoXG4gICAge2J1ZmZlckluZm8sIHJvb3REaXJ9OiB7YnVmZmVySW5mbzogQnVmZmVySW5mbywgcm9vdERpcj86IEF0b21UeXBlcy5EaXJlY3Rvcnl9XG4gICk6IFByb21pc2U8e3Jvb3REaXI6IEF0b21UeXBlcy5EaXJlY3RvcnksIG1vZHVsZU1hcDogTWFwPHN0cmluZywgTW9kdWxlSW5mbz59PiB7XG4gICAgaWYgKCEgcm9vdERpcikge1xuICAgICAgcm9vdERpciA9IGF3YWl0IHRoaXMucHJvY2Vzcy5nZXRSb290RGlyKGJ1ZmZlckluZm8uYnVmZmVyKVxuICAgIH1cbiAgICBsZXQgbW0gPSB0aGlzLmRpck1hcC5nZXQocm9vdERpcilcbiAgICBpZiAoIW1tKSB7XG4gICAgICBtbSA9IG5ldyBNYXAoKVxuICAgICAgdGhpcy5kaXJNYXAuc2V0KHJvb3REaXIsIG1tKVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICByb290RGlyLFxuICAgICAgbW9kdWxlTWFwOiBtbVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0TW9kdWxlSW5mbyAoXG4gICAgYXJnOiB7XG4gICAgICBidWZmZXJJbmZvOiBCdWZmZXJJbmZvLCBtb2R1bGVOYW1lPzogc3RyaW5nLFxuICAgICAgcm9vdERpcj86IEF0b21UeXBlcy5EaXJlY3RvcnksIG1vZHVsZU1hcD86IE1hcDxzdHJpbmcsIE1vZHVsZUluZm8+XG4gICAgfVxuICApIHtcbiAgICBjb25zdCB7YnVmZmVySW5mb30gPSBhcmdcbiAgICBsZXQgZGF0XG4gICAgaWYgKGFyZy5yb290RGlyICYmIGFyZy5tb2R1bGVNYXApIHtcbiAgICAgIGRhdCA9IHtyb290RGlyOiBhcmcucm9vdERpciwgbW9kdWxlTWFwOiBhcmcubW9kdWxlTWFwfVxuICAgIH0gZWxzZSB7XG4gICAgICBkYXQgPSBhd2FpdCB0aGlzLmdldE1vZHVsZU1hcCh7YnVmZmVySW5mb30pXG4gICAgfVxuICAgIGNvbnN0IHttb2R1bGVNYXAsIHJvb3REaXJ9ID0gZGF0XG4gICAgbGV0IG1vZHVsZU5hbWUgPSBhcmcubW9kdWxlTmFtZVxuICAgIGlmICghbW9kdWxlTmFtZSkge1xuICAgICAgbW9kdWxlTmFtZSA9IGF3YWl0IGJ1ZmZlckluZm8uZ2V0TW9kdWxlTmFtZSgpXG4gICAgfVxuICAgIGlmICghbW9kdWxlTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBOYW1lbGVzcyBtb2R1bGUgaW4gJHtidWZmZXJJbmZvLmJ1ZmZlci5nZXRVcmkoKX1gKVxuICAgIH1cblxuICAgIGxldCBtb2R1bGVJbmZvID0gbW9kdWxlTWFwLmdldChtb2R1bGVOYW1lKVxuICAgIGlmICghbW9kdWxlSW5mbykge1xuICAgICAgbW9kdWxlSW5mbyA9IG5ldyBNb2R1bGVJbmZvKG1vZHVsZU5hbWUsIHRoaXMucHJvY2Vzcywgcm9vdERpcilcbiAgICAgIG1vZHVsZU1hcC5zZXQobW9kdWxlTmFtZSwgbW9kdWxlSW5mbylcblxuICAgICAgY29uc3QgbW4gPSBtb2R1bGVOYW1lXG4gICAgICBtb2R1bGVJbmZvLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgIG1vZHVsZU1hcC5kZWxldGUobW4pXG4gICAgICAgIHJldHVybiBVdGlsLmRlYnVnKGAke21vZHVsZU5hbWV9IHJlbW92ZWQgZnJvbSBtYXBgKVxuICAgICAgfSlcbiAgICAgIGF3YWl0IG1vZHVsZUluZm8uaW5pdGlhbFVwZGF0ZVByb21pc2VcbiAgICB9XG4gICAgbW9kdWxlSW5mby5zZXRCdWZmZXIoYnVmZmVySW5mbylcbiAgICByZXR1cm4ge2J1ZmZlckluZm8sIHJvb3REaXIsIG1vZHVsZU1hcCwgbW9kdWxlSW5mbywgbW9kdWxlTmFtZX1cbiAgfVxuXG4gIHByaXZhdGUgZmlsdGVyPFQsIEsgZXh0ZW5kcyBrZXlvZiBUPiAoY2FuZGlkYXRlczogVFtdLCBwcmVmaXg6IHN0cmluZywga2V5czogS1tdKTogVFtdIHtcbiAgICBpZiAoIXByZWZpeCkge1xuICAgICAgcmV0dXJuIGNhbmRpZGF0ZXNcbiAgICB9XG4gICAgY29uc3QgbGlzdCA9IFtdXG4gICAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykge1xuICAgICAgY29uc3Qgc2NvcmVzID0ga2V5cy5tYXAoKGtleSkgPT4ge1xuICAgICAgICBjb25zdCBjayA9IGNhbmRpZGF0ZVtrZXldXG4gICAgICAgIGlmIChjaykge1xuICAgICAgICAgIHJldHVybiBGWi5zY29yZShjay50b1N0cmluZygpLCBwcmVmaXgpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIDBcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIGNvbnN0IHNjb3JlID0gTWF0aC5tYXgoLi4uc2NvcmVzKVxuICAgICAgaWYgKHNjb3JlID4gMCkge1xuICAgICAgICBsaXN0LnB1c2goe1xuICAgICAgICAgIHNjb3JlLFxuICAgICAgICAgIHNjb3JlTjogc2NvcmVzLmluZGV4T2Yoc2NvcmUpLFxuICAgICAgICAgIGRhdGE6IGNhbmRpZGF0ZVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbGlzdC5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgIGNvbnN0IHMgPSBiLnNjb3JlIC0gYS5zY29yZVxuICAgICAgICBpZiAocyA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiBhLnNjb3JlTiAtIGIuc2NvcmVOXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNcbiAgICAgIH0pLm1hcCgoe2RhdGF9KSA9PiBkYXRhKVxuICB9XG59XG4iXX0=