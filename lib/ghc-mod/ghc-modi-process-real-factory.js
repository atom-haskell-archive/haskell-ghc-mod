"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const Util = require("../util");
const ghc_modi_process_real_1 = require("./ghc-modi-process-real");
function createGhcModiProcessReal(rootDir) {
    return __awaiter(this, void 0, void 0, function* () {
        let opts;
        let vers;
        let caps;
        try {
            opts = yield Util.getProcessOptions(rootDir.getPath());
            const versP = getVersion(opts);
            const bopts = opts;
            checkComp(bopts, versP).catch((e) => {
                atom.notifications.addError('Failed to check compiler versions', {
                    detail: e,
                    stack: e.stack,
                    dismissable: true,
                });
            });
            vers = yield versP;
            caps = getCaps(vers);
            return new ghc_modi_process_real_1.GhcModiProcessReal(caps, rootDir, opts);
        }
        catch (e) {
            const err = e;
            Util.notifySpawnFail({ dir: rootDir.getPath(), err, opts, vers, caps });
            throw e;
        }
    });
}
exports.createGhcModiProcessReal = createGhcModiProcessReal;
function getCaps({ vers }) {
    const caps = {
        version: vers,
        fileMap: false,
        quoteArgs: false,
        optparse: false,
        typeConstraints: false,
        browseParents: false,
        interactiveCaseSplit: false,
        importedFrom: false,
        browseMain: false,
    };
    const atLeast = (b) => {
        for (let i = 0; i < b.length; i++) {
            const v = b[i];
            if (vers[i] > v) {
                return true;
            }
            else if (vers[i] < v) {
                return false;
            }
        }
        return true;
    };
    const exact = (b) => {
        for (let i = 0; i < b.length; i++) {
            const v = b[i];
            if (vers[i] !== v) {
                return false;
            }
        }
        return true;
    };
    if (!atLeast([5, 4])) {
        atom.notifications.addError(`\
Haskell-ghc-mod: ghc-mod < 5.4 is not supported. \
Use at your own risk or update your ghc-mod installation`, { dismissable: true });
    }
    if (exact([5, 4])) {
        atom.notifications.addWarning(`\
Haskell-ghc-mod: ghc-mod 5.4.* is deprecated. \
Use at your own risk or update your ghc-mod installation`, { dismissable: true });
    }
    if (atLeast([5, 4])) {
        caps.fileMap = true;
    }
    if (atLeast([5, 5])) {
        caps.quoteArgs = true;
        caps.optparse = true;
    }
    if (atLeast([5, 6])) {
        caps.typeConstraints = true;
        caps.browseParents = true;
        caps.interactiveCaseSplit = true;
    }
    if (atom.config.get('haskell-ghc-mod.experimental')) {
        caps.importedFrom = true;
    }
    Util.debug(JSON.stringify(caps));
    return caps;
}
function getVersion(opts) {
    return __awaiter(this, void 0, void 0, function* () {
        const timeout = atom.config.get('haskell-ghc-mod.initTimeout') * 1000;
        const cmd = atom.config.get('haskell-ghc-mod.ghcModPath');
        const { stdout } = yield Util.execPromise(cmd, ['version'], Object.assign({ timeout }, opts));
        const versRaw = /^ghc-mod version (\d+)\.(\d+)\.(\d+)(?:\.(\d+))?/.exec(stdout);
        if (!versRaw) {
            throw new Error("Couldn't get ghc-mod version");
        }
        const vers = versRaw.slice(1, 5).map((i) => parseInt(i, 10));
        const compRaw = /GHC (.+)$/.exec(stdout.trim());
        if (!compRaw) {
            throw new Error("Couldn't get ghc version");
        }
        const comp = compRaw[1];
        Util.debug(`Ghc-mod ${vers} built with ${comp}`);
        return { vers, comp };
    });
}
function checkComp(opts, versP) {
    return __awaiter(this, void 0, void 0, function* () {
        const { comp } = yield versP;
        const timeout = atom.config.get('haskell-ghc-mod.initTimeout') * 1000;
        const tryWarn = (cmd, args) => __awaiter(this, void 0, void 0, function* () {
            try {
                return (yield Util.execPromise(cmd, args, Object.assign({ timeout }, opts))).stdout.trim();
            }
            catch (error) {
                Util.warn(error);
            }
        });
        const [stackghc, pathghc] = yield Promise.all([
            tryWarn('stack', ['ghc', '--', '--numeric-version']),
            tryWarn('ghc', ['--numeric-version']),
        ]);
        Util.debug(`Stack GHC version ${stackghc}`);
        Util.debug(`Path GHC version ${pathghc}`);
        if (stackghc && (stackghc !== comp)) {
            const warn = `\
GHC version in your Stack '${stackghc}' doesn't match with \
GHC version used to build ghc-mod '${comp}'. This can lead to \
problems when using Stack projects`;
            atom.notifications.addWarning(warn);
            Util.warn(warn);
        }
        if (pathghc && (pathghc !== comp)) {
            const warn = `\
GHC version in your PATH '${pathghc}' doesn't match with \
GHC version used to build ghc-mod '${comp}'. This can lead to \
problems when using Cabal or Plain projects`;
            atom.notifications.addWarning(warn);
            Util.warn(warn);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2hjLW1vZGktcHJvY2Vzcy1yZWFsLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZ2hjLW1vZC9naGMtbW9kaS1wcm9jZXNzLXJlYWwtZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQ0EsZ0NBQStCO0FBQy9CLG1FQUF3RTtBQUl4RSxrQ0FBK0MsT0FBNEI7O1FBQ3pFLElBQUksSUFBNEIsQ0FBQTtRQUNoQyxJQUFJLElBQTRCLENBQUE7UUFDaEMsSUFBSSxJQUE0QixDQUFBO1FBQ2hDLElBQUksQ0FBQztZQUNILElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTtZQUN0RCxNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDOUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFBO1lBQ2xCLFNBQVMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBUSxFQUFFLEVBQUU7Z0JBQ3pDLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLG1DQUFtQyxFQUFFO29CQUMvRCxNQUFNLEVBQUUsQ0FBQztvQkFDVCxLQUFLLEVBQUUsQ0FBQyxDQUFDLEtBQUs7b0JBQ2QsV0FBVyxFQUFFLElBQUk7aUJBQ2xCLENBQUMsQ0FBQTtZQUNKLENBQUMsQ0FBQyxDQUFBO1lBQ0YsSUFBSSxHQUFHLE1BQU0sS0FBSyxDQUFBO1lBQ2xCLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDcEIsTUFBTSxDQUFDLElBQUksMENBQWtCLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNwRCxDQUFDO1FBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVYLE1BQU0sR0FBRyxHQUF3QixDQUFDLENBQUE7WUFD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bEIsQ0FBQztRQUNILENBQUMsQ0FBQSxDQUFBO1FBQ0QsTUFBTSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDNUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztZQUNwRCxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUMsbUJBQW1CLENBQUMsQ0FBQztTQUN0QyxDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixRQUFRLEVBQUUsQ0FBQyxDQUFBO1FBQzNDLElBQUksQ0FBQyxLQUFLLENBQUMsb0JBQW9CLE9BQU8sRUFBRSxDQUFDLENBQUE7UUFDekMsRUFBRSxDQUFDLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwQyxNQUFNLElBQUksR0FBRzs2QkFDWSxRQUFRO3FDQUNBLElBQUk7bUNBQ04sQ0FBQTtZQUMvQixJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUNuQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2pCLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xDLE1BQU0sSUFBSSxHQUFHOzRCQUNXLE9BQU87cUNBQ0UsSUFBSTs0Q0FDRyxDQUFBO1lBQ3hDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDakIsQ0FBQztJQUNILENBQUM7Q0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdIQ01vZENhcHMgfSBmcm9tICcuL2ludGVyYWN0aXZlLXByb2Nlc3MnXG5pbXBvcnQgKiBhcyBVdGlsIGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgeyBHaGNNb2RpUHJvY2Vzc1JlYWwsIFJ1bk9wdGlvbnMgfSBmcm9tICcuL2doYy1tb2RpLXByb2Nlc3MtcmVhbCdcblxuZXhwb3J0IHR5cGUgR0hDTW9kVmVycyA9IHsgdmVyczogbnVtYmVyW10sIGNvbXA6IHN0cmluZyB9XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVHaGNNb2RpUHJvY2Vzc1JlYWwocm9vdERpcjogQXRvbVR5cGVzLkRpcmVjdG9yeSk6IFByb21pc2U8R2hjTW9kaVByb2Nlc3NSZWFsPiB7XG4gIGxldCBvcHRzOiBSdW5PcHRpb25zIHwgdW5kZWZpbmVkXG4gIGxldCB2ZXJzOiBHSENNb2RWZXJzIHwgdW5kZWZpbmVkXG4gIGxldCBjYXBzOiBHSENNb2RDYXBzIHwgdW5kZWZpbmVkXG4gIHRyeSB7XG4gICAgb3B0cyA9IGF3YWl0IFV0aWwuZ2V0UHJvY2Vzc09wdGlvbnMocm9vdERpci5nZXRQYXRoKCkpXG4gICAgY29uc3QgdmVyc1AgPSBnZXRWZXJzaW9uKG9wdHMpXG4gICAgY29uc3QgYm9wdHMgPSBvcHRzXG4gICAgY2hlY2tDb21wKGJvcHRzLCB2ZXJzUCkuY2F0Y2goKGU6IEVycm9yKSA9PiB7XG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoJ0ZhaWxlZCB0byBjaGVjayBjb21waWxlciB2ZXJzaW9ucycsIHtcbiAgICAgICAgZGV0YWlsOiBlLFxuICAgICAgICBzdGFjazogZS5zdGFjayxcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICB9KVxuICAgIH0pXG4gICAgdmVycyA9IGF3YWl0IHZlcnNQXG4gICAgY2FwcyA9IGdldENhcHModmVycylcbiAgICByZXR1cm4gbmV3IEdoY01vZGlQcm9jZXNzUmVhbChjYXBzLCByb290RGlyLCBvcHRzKVxuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuc2FmZS1hbnlcbiAgICBjb25zdCBlcnI6IEVycm9yICYge2NvZGU6IGFueX0gPSBlXG4gICAgVXRpbC5ub3RpZnlTcGF3bkZhaWwoeyBkaXI6IHJvb3REaXIuZ2V0UGF0aCgpLCBlcnIsIG9wdHMsIHZlcnMsIGNhcHMgfSlcbiAgICB0aHJvdyBlXG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Q2Fwcyh7IHZlcnMgfTogeyB2ZXJzOiBudW1iZXJbXSB9KTogR0hDTW9kQ2FwcyB7XG4gIGNvbnN0IGNhcHM6IEdIQ01vZENhcHMgPSB7XG4gICAgdmVyc2lvbjogdmVycyxcbiAgICBmaWxlTWFwOiBmYWxzZSxcbiAgICBxdW90ZUFyZ3M6IGZhbHNlLFxuICAgIG9wdHBhcnNlOiBmYWxzZSxcbiAgICB0eXBlQ29uc3RyYWludHM6IGZhbHNlLFxuICAgIGJyb3dzZVBhcmVudHM6IGZhbHNlLFxuICAgIGludGVyYWN0aXZlQ2FzZVNwbGl0OiBmYWxzZSxcbiAgICBpbXBvcnRlZEZyb206IGZhbHNlLFxuICAgIGJyb3dzZU1haW46IGZhbHNlLFxuICB9XG5cbiAgY29uc3QgYXRMZWFzdCA9IChiOiBudW1iZXJbXSkgPT4ge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYi5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgdiA9IGJbaV1cbiAgICAgIGlmICh2ZXJzW2ldID4gdikge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfSBlbHNlIGlmICh2ZXJzW2ldIDwgdikge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGNvbnN0IGV4YWN0ID0gKGI6IG51bWJlcltdKSA9PiB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB2ID0gYltpXVxuICAgICAgaWYgKHZlcnNbaV0gIT09IHYpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBpZiAoIWF0TGVhc3QoWzUsIDRdKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgIGBcXFxuSGFza2VsbC1naGMtbW9kOiBnaGMtbW9kIDwgNS40IGlzIG5vdCBzdXBwb3J0ZWQuIFxcXG5Vc2UgYXQgeW91ciBvd24gcmlzayBvciB1cGRhdGUgeW91ciBnaGMtbW9kIGluc3RhbGxhdGlvbmAsXG4gICAgICB7IGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgKVxuICB9XG4gIGlmIChleGFjdChbNSwgNF0pKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcoXG4gICAgICBgXFxcbkhhc2tlbGwtZ2hjLW1vZDogZ2hjLW1vZCA1LjQuKiBpcyBkZXByZWNhdGVkLiBcXFxuVXNlIGF0IHlvdXIgb3duIHJpc2sgb3IgdXBkYXRlIHlvdXIgZ2hjLW1vZCBpbnN0YWxsYXRpb25gLFxuICAgICAgeyBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgIClcbiAgfVxuICBpZiAoYXRMZWFzdChbNSwgNF0pKSB7XG4gICAgY2Fwcy5maWxlTWFwID0gdHJ1ZVxuICB9XG4gIGlmIChhdExlYXN0KFs1LCA1XSkpIHtcbiAgICBjYXBzLnF1b3RlQXJncyA9IHRydWVcbiAgICBjYXBzLm9wdHBhcnNlID0gdHJ1ZVxuICB9XG4gIGlmIChhdExlYXN0KFs1LCA2XSkpIHtcbiAgICBjYXBzLnR5cGVDb25zdHJhaW50cyA9IHRydWVcbiAgICBjYXBzLmJyb3dzZVBhcmVudHMgPSB0cnVlXG4gICAgY2Fwcy5pbnRlcmFjdGl2ZUNhc2VTcGxpdCA9IHRydWVcbiAgfVxuICBpZiAoYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QuZXhwZXJpbWVudGFsJykpIHtcbiAgICBjYXBzLmltcG9ydGVkRnJvbSA9IHRydWVcbiAgfVxuICBVdGlsLmRlYnVnKEpTT04uc3RyaW5naWZ5KGNhcHMpKVxuICByZXR1cm4gY2Fwc1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRWZXJzaW9uKG9wdHM6IFV0aWwuRXhlY09wdHMpOiBQcm9taXNlPEdIQ01vZFZlcnM+IHtcbiAgY29uc3QgdGltZW91dCA9IGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmluaXRUaW1lb3V0JykgKiAxMDAwXG4gIGNvbnN0IGNtZCA9IGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmdoY01vZFBhdGgnKVxuICBjb25zdCB7IHN0ZG91dCB9ID0gYXdhaXQgVXRpbC5leGVjUHJvbWlzZShjbWQsIFsndmVyc2lvbiddLCB7IHRpbWVvdXQsIC4uLm9wdHMgfSlcbiAgY29uc3QgdmVyc1JhdyA9IC9eZ2hjLW1vZCB2ZXJzaW9uIChcXGQrKVxcLihcXGQrKVxcLihcXGQrKSg/OlxcLihcXGQrKSk/Ly5leGVjKHN0ZG91dClcbiAgaWYgKCF2ZXJzUmF3KSB7IHRocm93IG5ldyBFcnJvcihcIkNvdWxkbid0IGdldCBnaGMtbW9kIHZlcnNpb25cIikgfVxuICBjb25zdCB2ZXJzID0gdmVyc1Jhdy5zbGljZSgxLCA1KS5tYXAoKGkpID0+IHBhcnNlSW50KGksIDEwKSlcbiAgY29uc3QgY29tcFJhdyA9IC9HSEMgKC4rKSQvLmV4ZWMoc3Rkb3V0LnRyaW0oKSlcbiAgaWYgKCFjb21wUmF3KSB7IHRocm93IG5ldyBFcnJvcihcIkNvdWxkbid0IGdldCBnaGMgdmVyc2lvblwiKSB9XG4gIGNvbnN0IGNvbXAgPSBjb21wUmF3WzFdXG4gIFV0aWwuZGVidWcoYEdoYy1tb2QgJHt2ZXJzfSBidWlsdCB3aXRoICR7Y29tcH1gKVxuICByZXR1cm4geyB2ZXJzLCBjb21wIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tDb21wKG9wdHM6IFV0aWwuRXhlY09wdHMsIHZlcnNQOiBQcm9taXNlPEdIQ01vZFZlcnM+KSB7XG4gIGNvbnN0IHtjb21wfSA9IGF3YWl0IHZlcnNQXG4gIGNvbnN0IHRpbWVvdXQgPSBhdG9tLmNvbmZpZy5nZXQoJ2hhc2tlbGwtZ2hjLW1vZC5pbml0VGltZW91dCcpICogMTAwMFxuICBjb25zdCB0cnlXYXJuID0gYXN5bmMgKGNtZDogc3RyaW5nLCBhcmdzOiBzdHJpbmdbXSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gKGF3YWl0IFV0aWwuZXhlY1Byb21pc2UoY21kLCBhcmdzLCB7IHRpbWVvdXQsIC4uLm9wdHMgfSkpLnN0ZG91dC50cmltKClcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgVXRpbC53YXJuKGVycm9yKVxuICAgIH1cbiAgfVxuICBjb25zdCBbc3RhY2tnaGMsIHBhdGhnaGNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgIHRyeVdhcm4oJ3N0YWNrJywgWydnaGMnLCAnLS0nLCAnLS1udW1lcmljLXZlcnNpb24nXSksXG4gICAgdHJ5V2FybignZ2hjJywgWyctLW51bWVyaWMtdmVyc2lvbiddKSxcbiAgXSlcbiAgVXRpbC5kZWJ1ZyhgU3RhY2sgR0hDIHZlcnNpb24gJHtzdGFja2doY31gKVxuICBVdGlsLmRlYnVnKGBQYXRoIEdIQyB2ZXJzaW9uICR7cGF0aGdoY31gKVxuICBpZiAoc3RhY2tnaGMgJiYgKHN0YWNrZ2hjICE9PSBjb21wKSkge1xuICAgIGNvbnN0IHdhcm4gPSBgXFxcbkdIQyB2ZXJzaW9uIGluIHlvdXIgU3RhY2sgJyR7c3RhY2tnaGN9JyBkb2Vzbid0IG1hdGNoIHdpdGggXFxcbkdIQyB2ZXJzaW9uIHVzZWQgdG8gYnVpbGQgZ2hjLW1vZCAnJHtjb21wfScuIFRoaXMgY2FuIGxlYWQgdG8gXFxcbnByb2JsZW1zIHdoZW4gdXNpbmcgU3RhY2sgcHJvamVjdHNgXG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcod2FybilcbiAgICBVdGlsLndhcm4od2FybilcbiAgfVxuICBpZiAocGF0aGdoYyAmJiAocGF0aGdoYyAhPT0gY29tcCkpIHtcbiAgICBjb25zdCB3YXJuID0gYFxcXG5HSEMgdmVyc2lvbiBpbiB5b3VyIFBBVEggJyR7cGF0aGdoY30nIGRvZXNuJ3QgbWF0Y2ggd2l0aCBcXFxuR0hDIHZlcnNpb24gdXNlZCB0byBidWlsZCBnaGMtbW9kICcke2NvbXB9Jy4gVGhpcyBjYW4gbGVhZCB0byBcXFxucHJvYmxlbXMgd2hlbiB1c2luZyBDYWJhbCBvciBQbGFpbiBwcm9qZWN0c2BcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyh3YXJuKVxuICAgIFV0aWwud2Fybih3YXJuKVxuICB9XG59XG4iXX0=