"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Util = require("../util");
const ghc_modi_process_real_1 = require("./ghc-modi-process-real");
const build_stack_1 = require("./build-stack");
async function createGhcModiProcessReal(rootDir, upi) {
    let opts;
    let vers;
    let caps;
    let builder;
    try {
        if (upi && atom.config.get('haskell-ghc-mod.builderManagement')) {
            builder = await upi.getOthersConfigParam('ide-haskell-cabal', 'builder');
        }
        const bn = builder && builder.name;
        Util.debug(`Using builder ${bn}`);
        opts = await Util.getProcessOptions(rootDir.getPath());
        const versP = getVersion(opts);
        const bopts = opts;
        const shouldBuild = await checkComp(bopts, versP, bn).catch(async (e) => {
            if (e.code === 'ENOENT') {
                return askBuild(bn, `Atom couldn't find ghc-mod.`);
            }
            else {
                atom.notifications.addError('Failed to check compiler versions', {
                    detail: e.toString(),
                    stack: e.stack,
                    dismissable: true,
                });
                return false;
            }
        });
        if (shouldBuild) {
            const success = await build_stack_1.buildStack(bopts, upi);
            if (success) {
                return createGhcModiProcessReal(rootDir, upi);
            }
            else {
                atom.notifications.addWarning('Building ghc-mod failed, continuing as-is');
            }
        }
        vers = await versP;
        caps = getCaps(vers);
        return new ghc_modi_process_real_1.GhcModiProcessReal(caps, rootDir, opts);
    }
    catch (e) {
        const err = e;
        Util.notifySpawnFail({ dir: rootDir.getPath(), err, opts, vers, caps });
        throw e;
    }
}
exports.createGhcModiProcessReal = createGhcModiProcessReal;
function getCaps({ vers }) {
    const caps = {
        version: vers,
        fileMap: false,
        quoteArgs: false,
        optparse: false,
        typeConstraints: false,
        browseParents: false,
        interactiveCaseSplit: false,
        importedFrom: false,
        browseMain: false,
    };
    const atLeast = (b) => {
        for (let i = 0; i < b.length; i++) {
            const v = b[i];
            if (vers[i] > v) {
                return true;
            }
            else if (vers[i] < v) {
                return false;
            }
        }
        return true;
    };
    const exact = (b) => {
        for (let i = 0; i < b.length; i++) {
            const v = b[i];
            if (vers[i] !== v) {
                return false;
            }
        }
        return true;
    };
    if (!atLeast([5, 4])) {
        atom.notifications.addError(`\
Haskell-ghc-mod: ghc-mod < 5.4 is not supported. \
Use at your own risk or update your ghc-mod installation`, { dismissable: true });
    }
    if (exact([5, 4])) {
        atom.notifications.addWarning(`\
Haskell-ghc-mod: ghc-mod 5.4.* is deprecated. \
Use at your own risk or update your ghc-mod installation`, { dismissable: true });
    }
    if (atLeast([5, 4])) {
        caps.fileMap = true;
    }
    if (atLeast([5, 5])) {
        caps.quoteArgs = true;
        caps.optparse = true;
    }
    if (atLeast([5, 6])) {
        caps.typeConstraints = true;
        caps.browseParents = true;
        caps.interactiveCaseSplit = true;
    }
    if (atom.config.get('haskell-ghc-mod.experimental')) {
        caps.importedFrom = true;
    }
    Util.debug(JSON.stringify(caps));
    return caps;
}
async function getVersion(opts) {
    const timeout = atom.config.get('haskell-ghc-mod.initTimeout') * 1000;
    const cmd = atom.config.get('haskell-ghc-mod.ghcModPath');
    const { stdout } = await Util.execPromise(cmd, ['version'], Object.assign({ timeout }, opts));
    const versRaw = /^ghc-mod version (\d+)\.(\d+)\.(\d+)(?:\.(\d+))?/.exec(stdout);
    if (!versRaw) {
        throw new Error("Couldn't get ghc-mod version");
    }
    const vers = versRaw.slice(1, 5).map((i) => parseInt(i, 10));
    const compRaw = /GHC (.+)$/.exec(stdout.trim());
    if (!compRaw) {
        throw new Error("Couldn't get ghc version");
    }
    const comp = compRaw[1];
    Util.debug(`Ghc-mod ${vers} built with ${comp}`);
    return { vers, comp };
}
async function checkComp(opts, versP, builder) {
    const { comp } = await versP;
    const timeout = atom.config.get('haskell-ghc-mod.initTimeout') * 1000;
    const tryWarn = async (cmd, args) => {
        try {
            return (await Util.execPromise(cmd, args, Object.assign({ timeout }, opts))).stdout.trim();
        }
        catch (error) {
            Util.warn(error);
            return undefined;
        }
    };
    const [stackghc, pathghc] = await Promise.all([
        tryWarn('stack', ['ghc', '--', '--numeric-version']),
        tryWarn('ghc', ['--numeric-version']),
    ]);
    Util.debug(`Stack GHC version ${stackghc}`);
    Util.debug(`Path GHC version ${pathghc}`);
    const warnStack = ['stack', undefined].includes(builder);
    const warnCabal = ['cabal', 'none', undefined].includes(builder);
    let shouldBuild = false;
    if (pathghc && (pathghc !== comp) && warnCabal) {
        shouldBuild = shouldBuild || await askBuild(builder, `\
GHC version in your PATH '${pathghc}' doesn't match with \
GHC version used to build ghc-mod '${comp}'. This can lead to \
problems when using Cabal or Plain projects`);
    }
    if (stackghc && (stackghc !== comp) && warnStack) {
        shouldBuild = shouldBuild || await askBuild(builder, `\
GHC version in your Stack '${stackghc}' doesn't match with \
GHC version used to build ghc-mod '${comp}'. This can lead to \
problems when using Stack projects.`);
    }
    return shouldBuild;
}
async function askBuild(builder, msg) {
    let buttons;
    return new Promise((resolve) => {
        let notif;
        if (builder === 'stack') {
            buttons = [{
                    className: 'icon icon-zap',
                    text: 'Build ghc-mod',
                    onDidClick() {
                        resolve(true);
                        notif && notif.dismiss();
                    },
                }, {
                    className: 'icon icon-x',
                    text: 'No thanks',
                    onDidClick() {
                        resolve(false);
                        notif && notif.dismiss();
                    },
                }];
        }
        const warn = `${msg} ${buttons ? 'Would you like to attempt building ghc-mod?' : ''}`;
        notif = atom.notifications.addWarning(warn, {
            dismissable: builder !== undefined,
            buttons,
        });
        Util.warn(msg);
        if (buttons) {
            const disp = notif.onDidDismiss(() => {
                disp.dispose();
                resolve(false);
            });
        }
        else {
            resolve(false);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2hjLW1vZGktcHJvY2Vzcy1yZWFsLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZ2hjLW1vZC9naGMtbW9kaS1wcm9jZXNzLXJlYWwtZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLGdDQUErQjtBQUMvQixtRUFBd0U7QUFHeEUsK0NBQTBDO0FBSW5DLEtBQUssbUNBQW1DLE9BQWtCLEVBQUUsR0FBNkI7SUFDOUYsSUFBSSxJQUE0QixDQUFBO0lBQ2hDLElBQUksSUFBNEIsQ0FBQTtJQUNoQyxJQUFJLElBQTRCLENBQUE7SUFDaEMsSUFBSSxPQUFxQyxDQUFBO0lBQ3pDLElBQUksQ0FBQztRQUNILEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVoRSxPQUFPLEdBQUcsTUFBTSxHQUFHLENBQUMsb0JBQW9CLENBQW1CLG1CQUFtQixFQUFFLFNBQVMsQ0FBQyxDQUFBO1FBQzVGLENBQUM7UUFDRCxNQUFNLEVBQUUsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQTtRQUNsQyxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBRWpDLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTtRQUN0RCxNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDOUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFBO1FBRWxCLE1BQU0sV0FBVyxHQUFHLE1BQU0sU0FBUyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFNLEVBQUUsRUFBRTtZQUMzRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFB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QUFLLENBQUMsQ0FBQTtZQUNoQixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNoQixDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR0hDTW9kQ2FwcyB9IGZyb20gJy4vaW50ZXJhY3RpdmUtcHJvY2VzcydcbmltcG9ydCAqIGFzIFV0aWwgZnJvbSAnLi4vdXRpbCdcbmltcG9ydCB7IEdoY01vZGlQcm9jZXNzUmVhbCwgUnVuT3B0aW9ucyB9IGZyb20gJy4vZ2hjLW1vZGktcHJvY2Vzcy1yZWFsJ1xuaW1wb3J0IHsgRGlyZWN0b3J5LCBOb3RpZmljYXRpb24gfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgSVVQSUluc3RhbmNlIH0gZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmltcG9ydCB7IGJ1aWxkU3RhY2sgfSBmcm9tICcuL2J1aWxkLXN0YWNrJ1xuXG5leHBvcnQgdHlwZSBHSENNb2RWZXJzID0geyB2ZXJzOiBudW1iZXJbXSwgY29tcDogc3RyaW5nIH1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUdoY01vZGlQcm9jZXNzUmVhbChyb290RGlyOiBEaXJlY3RvcnksIHVwaTogSVVQSUluc3RhbmNlIHwgdW5kZWZpbmVkKTogUHJvbWlzZTxHaGNNb2RpUHJvY2Vzc1JlYWw+IHtcbiAgbGV0IG9wdHM6IFJ1bk9wdGlvbnMgfCB1bmRlZmluZWRcbiAgbGV0IHZlcnM6IEdIQ01vZFZlcnMgfCB1bmRlZmluZWRcbiAgbGV0IGNhcHM6IEdIQ01vZENhcHMgfCB1bmRlZmluZWRcbiAgbGV0IGJ1aWxkZXI6IHsgbmFtZTogc3RyaW5nIH0gfCB1bmRlZmluZWRcbiAgdHJ5IHtcbiAgICBpZiAodXBpICYmIGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmJ1aWxkZXJNYW5hZ2VtZW50JykpIHtcbiAgICAgIC8vIFRPRE86IHRoaXMgaXMgdXNlZCB0d2ljZSwgdGhlIHNlY29uZCB0aW1lIGluIGdoYy1tb2QvaW5kZXgudHMsIHNob3VsZCBwcm9iYWJseSBmaXggdGhhdFxuICAgICAgYnVpbGRlciA9IGF3YWl0IHVwaS5nZXRPdGhlcnNDb25maWdQYXJhbTx7IG5hbWU6IHN0cmluZyB9PignaWRlLWhhc2tlbGwtY2FiYWwnLCAnYnVpbGRlcicpXG4gICAgfVxuICAgIGNvbnN0IGJuID0gYnVpbGRlciAmJiBidWlsZGVyLm5hbWVcbiAgICBVdGlsLmRlYnVnKGBVc2luZyBidWlsZGVyICR7Ym59YClcbiAgICAvLyBUT0RPOiBTaG91bGQgcHJlZmVyIHN0YWNrIHNhbmRib3ggd2hlbiB1c2luZyBzdGFjayBhbmQgY2FiYWwgc2FuYmRveCB3aGVuIHVzaW5nIGNhYmFsIVxuICAgIG9wdHMgPSBhd2FpdCBVdGlsLmdldFByb2Nlc3NPcHRpb25zKHJvb3REaXIuZ2V0UGF0aCgpKVxuICAgIGNvbnN0IHZlcnNQID0gZ2V0VmVyc2lvbihvcHRzKVxuICAgIGNvbnN0IGJvcHRzID0gb3B0c1xuICAgIC8vIFRPRE86IHRoaXMgZ2V0cyBjaGVja2VkIG9ubHkgb25jZSwgc2hvdWxkIGNoZWNrIG9uIGdoYy1tb2QgcmVzdGFydD9cbiAgICBjb25zdCBzaG91bGRCdWlsZCA9IGF3YWl0IGNoZWNrQ29tcChib3B0cywgdmVyc1AsIGJuKS5jYXRjaChhc3luYyAoZTogYW55KSA9PiB7XG4gICAgICBpZiAoZS5jb2RlID09PSAnRU5PRU5UJykge1xuICAgICAgICByZXR1cm4gYXNrQnVpbGQoYm4sIGBBdG9tIGNvdWxkbid0IGZpbmQgZ2hjLW1vZC5gKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdGYWlsZWQgdG8gY2hlY2sgY29tcGlsZXIgdmVyc2lvbnMnLCB7XG4gICAgICAgICAgZGV0YWlsOiBlLnRvU3RyaW5nKCksXG4gICAgICAgICAgc3RhY2s6IGUuc3RhY2ssXG4gICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgIH0pXG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgIH0pXG4gICAgaWYgKHNob3VsZEJ1aWxkKSB7XG4gICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgYnVpbGRTdGFjayhib3B0cywgdXBpKVxuICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUdoY01vZGlQcm9jZXNzUmVhbChyb290RGlyLCB1cGkpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZygnQnVpbGRpbmcgZ2hjLW1vZCBmYWlsZWQsIGNvbnRpbnVpbmcgYXMtaXMnKVxuICAgICAgfVxuICAgIH1cbiAgICB2ZXJzID0gYXdhaXQgdmVyc1BcbiAgICBjYXBzID0gZ2V0Q2Fwcyh2ZXJzKVxuICAgIHJldHVybiBuZXcgR2hjTW9kaVByb2Nlc3NSZWFsKGNhcHMsIHJvb3REaXIsIG9wdHMpXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5zYWZlLWFueVxuICAgIGNvbnN0IGVycjogRXJyb3IgJiB7Y29kZTogYW55fSA9IGVcbiAgICBVdGlsLm5vdGlmeVNwYXduRmFpbCh7IGRpcjogcm9vdERpci5nZXRQYXRoKCksIGVyciwgb3B0cywgdmVycywgY2FwcyB9KVxuICAgIHRocm93IGVcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRDYXBzKHsgdmVycyB9OiB7IHZlcnM6IG51bWJlcltdIH0pOiBHSENNb2RDYXBzIHtcbiAgY29uc3QgY2FwczogR0hDTW9kQ2FwcyA9IHtcbiAgICB2ZXJzaW9uOiB2ZXJzLFxuICAgIGZpbGVNYXA6IGZhbHNlLFxuICAgIHF1b3RlQXJnczogZmFsc2UsXG4gICAgb3B0cGFyc2U6IGZhbHNlLFxuICAgIHR5cGVDb25zdHJhaW50czogZmFsc2UsXG4gICAgYnJvd3NlUGFyZW50czogZmFsc2UsXG4gICAgaW50ZXJhY3RpdmVDYXNlU3BsaXQ6IGZhbHNlLFxuICAgIGltcG9ydGVkRnJvbTogZmFsc2UsXG4gICAgYnJvd3NlTWFpbjogZmFsc2UsXG4gIH1cblxuICBjb25zdCBhdExlYXN0ID0gKGI6IG51bWJlcltdKSA9PiB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB2ID0gYltpXVxuICAgICAgaWYgKHZlcnNbaV0gPiB2KSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9IGVsc2UgaWYgKHZlcnNbaV0gPCB2KSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgY29uc3QgZXhhY3QgPSAoYjogbnVtYmVyW10pID0+IHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGIubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHYgPSBiW2ldXG4gICAgICBpZiAodmVyc1tpXSAhPT0gdikge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGlmICghYXRMZWFzdChbNSwgNF0pKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgYFxcXG5IYXNrZWxsLWdoYy1tb2Q6IGdoYy1tb2QgPCA1LjQgaXMgbm90IHN1cHBvcnRlZC4gXFxcblVzZSBhdCB5b3VyIG93biByaXNrIG9yIHVwZGF0ZSB5b3VyIGdoYy1tb2QgaW5zdGFsbGF0aW9uYCxcbiAgICAgIHsgZGlzbWlzc2FibGU6IHRydWUgfSxcbiAgICApXG4gIH1cbiAgaWYgKGV4YWN0KFs1LCA0XSkpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyhcbiAgICAgIGBcXFxuSGFza2VsbC1naGMtbW9kOiBnaGMtbW9kIDUuNC4qIGlzIGRlcHJlY2F0ZWQuIFxcXG5Vc2UgYXQgeW91ciBvd24gcmlzayBvciB1cGRhdGUgeW91ciBnaGMtbW9kIGluc3RhbGxhdGlvbmAsXG4gICAgICB7IGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgKVxuICB9XG4gIGlmIChhdExlYXN0KFs1LCA0XSkpIHtcbiAgICBjYXBzLmZpbGVNYXAgPSB0cnVlXG4gIH1cbiAgaWYgKGF0TGVhc3QoWzUsIDVdKSkge1xuICAgIGNhcHMucXVvdGVBcmdzID0gdHJ1ZVxuICAgIGNhcHMub3B0cGFyc2UgPSB0cnVlXG4gIH1cbiAgaWYgKGF0TGVhc3QoWzUsIDZdKSkge1xuICAgIGNhcHMudHlwZUNvbnN0cmFpbnRzID0gdHJ1ZVxuICAgIGNhcHMuYnJvd3NlUGFyZW50cyA9IHRydWVcbiAgICBjYXBzLmludGVyYWN0aXZlQ2FzZVNwbGl0ID0gdHJ1ZVxuICB9XG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2hhc2tlbGwtZ2hjLW1vZC5leHBlcmltZW50YWwnKSkge1xuICAgIGNhcHMuaW1wb3J0ZWRGcm9tID0gdHJ1ZVxuICB9XG4gIFV0aWwuZGVidWcoSlNPTi5zdHJpbmdpZnkoY2FwcykpXG4gIHJldHVybiBjYXBzXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFZlcnNpb24ob3B0czogVXRpbC5FeGVjT3B0cyk6IFByb21pc2U8R0hDTW9kVmVycz4ge1xuICBjb25zdCB0aW1lb3V0ID0gYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QuaW5pdFRpbWVvdXQnKSAqIDEwMDBcbiAgY29uc3QgY21kID0gYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QuZ2hjTW9kUGF0aCcpXG4gIGNvbnN0IHsgc3Rkb3V0IH0gPSBhd2FpdCBVdGlsLmV4ZWNQcm9taXNlKGNtZCwgWyd2ZXJzaW9uJ10sIHsgdGltZW91dCwgLi4ub3B0cyB9KVxuICBjb25zdCB2ZXJzUmF3ID0gL15naGMtbW9kIHZlcnNpb24gKFxcZCspXFwuKFxcZCspXFwuKFxcZCspKD86XFwuKFxcZCspKT8vLmV4ZWMoc3Rkb3V0KVxuICBpZiAoIXZlcnNSYXcpIHsgdGhyb3cgbmV3IEVycm9yKFwiQ291bGRuJ3QgZ2V0IGdoYy1tb2QgdmVyc2lvblwiKSB9XG4gIGNvbnN0IHZlcnMgPSB2ZXJzUmF3LnNsaWNlKDEsIDUpLm1hcCgoaSkgPT4gcGFyc2VJbnQoaSwgMTApKVxuICBjb25zdCBjb21wUmF3ID0gL0dIQyAoLispJC8uZXhlYyhzdGRvdXQudHJpbSgpKVxuICBpZiAoIWNvbXBSYXcpIHsgdGhyb3cgbmV3IEVycm9yKFwiQ291bGRuJ3QgZ2V0IGdoYyB2ZXJzaW9uXCIpIH1cbiAgY29uc3QgY29tcCA9IGNvbXBSYXdbMV1cbiAgVXRpbC5kZWJ1ZyhgR2hjLW1vZCAke3ZlcnN9IGJ1aWx0IHdpdGggJHtjb21wfWApXG4gIHJldHVybiB7IHZlcnMsIGNvbXAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja0NvbXAob3B0czogVXRpbC5FeGVjT3B0cywgdmVyc1A6IFByb21pc2U8R0hDTW9kVmVycz4sIGJ1aWxkZXI6IHN0cmluZyB8IHVuZGVmaW5lZCkge1xuICBjb25zdCB7IGNvbXAgfSA9IGF3YWl0IHZlcnNQXG4gIGNvbnN0IHRpbWVvdXQgPSBhdG9tLmNvbmZpZy5nZXQoJ2hhc2tlbGwtZ2hjLW1vZC5pbml0VGltZW91dCcpICogMTAwMFxuICBjb25zdCB0cnlXYXJuID0gYXN5bmMgKGNtZDogc3RyaW5nLCBhcmdzOiBzdHJpbmdbXSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gKGF3YWl0IFV0aWwuZXhlY1Byb21pc2UoY21kLCBhcmdzLCB7IHRpbWVvdXQsIC4uLm9wdHMgfSkpLnN0ZG91dC50cmltKClcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgVXRpbC53YXJuKGVycm9yKVxuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuICBjb25zdCBbc3RhY2tnaGMsIHBhdGhnaGNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgIHRyeVdhcm4oJ3N0YWNrJywgWydnaGMnLCAnLS0nLCAnLS1udW1lcmljLXZlcnNpb24nXSksXG4gICAgdHJ5V2FybignZ2hjJywgWyctLW51bWVyaWMtdmVyc2lvbiddKSxcbiAgXSlcbiAgVXRpbC5kZWJ1ZyhgU3RhY2sgR0hDIHZlcnNpb24gJHtzdGFja2doY31gKVxuICBVdGlsLmRlYnVnKGBQYXRoIEdIQyB2ZXJzaW9uICR7cGF0aGdoY31gKVxuICBjb25zdCB3YXJuU3RhY2sgPSBbJ3N0YWNrJywgdW5kZWZpbmVkXS5pbmNsdWRlcyhidWlsZGVyKVxuICBjb25zdCB3YXJuQ2FiYWwgPSBbJ2NhYmFsJywgJ25vbmUnLCB1bmRlZmluZWRdLmluY2x1ZGVzKGJ1aWxkZXIpXG4gIGxldCBzaG91bGRCdWlsZCA9IGZhbHNlXG4gIGlmIChwYXRoZ2hjICYmIChwYXRoZ2hjICE9PSBjb21wKSAmJiB3YXJuQ2FiYWwpIHtcbiAgICBzaG91bGRCdWlsZCA9IHNob3VsZEJ1aWxkIHx8IGF3YWl0IGFza0J1aWxkKGJ1aWxkZXIsIGBcXFxuR0hDIHZlcnNpb24gaW4geW91ciBQQVRIICcke3BhdGhnaGN9JyBkb2Vzbid0IG1hdGNoIHdpdGggXFxcbkdIQyB2ZXJzaW9uIHVzZWQgdG8gYnVpbGQgZ2hjLW1vZCAnJHtjb21wfScuIFRoaXMgY2FuIGxlYWQgdG8gXFxcbnByb2JsZW1zIHdoZW4gdXNpbmcgQ2FiYWwgb3IgUGxhaW4gcHJvamVjdHNgKVxuICB9XG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vIHN0YWNrIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICBpZiAoc3RhY2tnaGMgJiYgKHN0YWNrZ2hjICE9PSBjb21wKSAmJiB3YXJuU3RhY2spIHtcbiAgICBzaG91bGRCdWlsZCA9IHNob3VsZEJ1aWxkIHx8IGF3YWl0IGFza0J1aWxkKGJ1aWxkZXIsIGBcXFxuR0hDIHZlcnNpb24gaW4geW91ciBTdGFjayAnJHtzdGFja2doY30nIGRvZXNuJ3QgbWF0Y2ggd2l0aCBcXFxuR0hDIHZlcnNpb24gdXNlZCB0byBidWlsZCBnaGMtbW9kICcke2NvbXB9Jy4gVGhpcyBjYW4gbGVhZCB0byBcXFxucHJvYmxlbXMgd2hlbiB1c2luZyBTdGFjayBwcm9qZWN0cy5gKVxuICB9XG4gIHJldHVybiBzaG91bGRCdWlsZFxufVxuXG5hc3luYyBmdW5jdGlvbiBhc2tCdWlsZChidWlsZGVyOiBzdHJpbmcgfCB1bmRlZmluZWQsIG1zZzogc3RyaW5nKSB7XG4gIGxldCBidXR0b25zOiBBcnJheTx7XG4gICAgY2xhc3NOYW1lPzogc3RyaW5nXG4gICAgdGV4dD86IHN0cmluZ1xuICAgIG9uRGlkQ2xpY2s/KGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZFxuICB9PiB8IHVuZGVmaW5lZFxuXG4gIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xuICAgIGxldCBub3RpZjogTm90aWZpY2F0aW9uXG4gICAgaWYgKGJ1aWxkZXIgPT09ICdzdGFjaycpIHtcbiAgICAgIC8vIG9mZmVyIHRvIGJ1aWxkIGdoYy1tb2RcbiAgICAgIGJ1dHRvbnMgPSBbe1xuICAgICAgICBjbGFzc05hbWU6ICdpY29uIGljb24temFwJyxcbiAgICAgICAgdGV4dDogJ0J1aWxkIGdoYy1tb2QnLFxuICAgICAgICBvbkRpZENsaWNrKCkge1xuICAgICAgICAgIHJlc29sdmUodHJ1ZSlcbiAgICAgICAgICBub3RpZiAmJiBub3RpZi5kaXNtaXNzKClcbiAgICAgICAgfSxcbiAgICAgIH0se1xuICAgICAgICBjbGFzc05hbWU6ICdpY29uIGljb24teCcsXG4gICAgICAgIHRleHQ6ICdObyB0aGFua3MnLFxuICAgICAgICBvbkRpZENsaWNrKCkge1xuICAgICAgICAgIHJlc29sdmUoZmFsc2UpXG4gICAgICAgICAgbm90aWYgJiYgbm90aWYuZGlzbWlzcygpXG4gICAgICAgIH0sXG4gICAgICB9XVxuICAgIH1cbiAgICBjb25zdCB3YXJuID0gYCR7bXNnfSAke2J1dHRvbnMgPyAnV291bGQgeW91IGxpa2UgdG8gYXR0ZW1wdCBidWlsZGluZyBnaGMtbW9kPycgOiAnJ31gXG4gICAgbm90aWYgPSBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyh3YXJuLCB7XG4gICAgICBkaXNtaXNzYWJsZTogYnVpbGRlciAhPT0gdW5kZWZpbmVkLFxuICAgICAgYnV0dG9ucyxcbiAgICB9KVxuICAgIFV0aWwud2Fybihtc2cpXG4gICAgaWYgKGJ1dHRvbnMpIHtcbiAgICAgIGNvbnN0IGRpc3AgPSBub3RpZi5vbkRpZERpc21pc3MoKCkgPT4ge1xuICAgICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgICByZXNvbHZlKGZhbHNlKVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzb2x2ZShmYWxzZSlcbiAgICB9XG4gIH0pXG59XG4iXX0=