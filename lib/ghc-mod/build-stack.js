"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const CP = require("child_process");
const os_1 = require("os");
const Util = require("../util");
async function buildStack(opts, upi) {
    const messages = [];
    const disp = new atom_1.CompositeDisposable();
    try {
        const vers = await Util.execPromise('stack', ['--no-install-ghc', '--numeric-version'], opts)
            .then(({ stdout }) => stdout.split('.').map((n) => parseInt(n, 10)))
            .catch(() => undefined);
        const hasCopyCompiler = vers ? Util.versAtLeast(vers, [1, 6, 1]) : false;
        return await new Promise((resolve, reject) => {
            const args = ['--no-install-ghc', 'build'];
            if (hasCopyCompiler)
                args.push('--copy-compiler-tool');
            args.push('ghc-mod');
            Util.warn(`Running stack ${args.join(' ')}`);
            const proc = CP.spawn('stack', args, opts);
            const buffered = () => {
                let buffer = '';
                return (data) => {
                    const output = data.toString('utf8');
                    const [first, ...tail] = output.split(os_1.EOL);
                    buffer += first;
                    if (tail.length > 0) {
                        const lines = [buffer, ...tail.slice(0, -1)];
                        buffer = tail.slice(-1)[0];
                        messages.push(...lines.map((message) => ({ message, severity: 'build' })));
                        if (upi) {
                            upi.setMessages(messages);
                        }
                        else {
                            atom.notifications.addInfo(lines.join('\n'));
                        }
                        console.log(lines.join('\n'));
                    }
                };
            };
            proc.stdout.on('data', buffered());
            proc.stderr.on('data', buffered());
            if (upi) {
                disp.add(upi.addPanelControl({
                    element: 'ide-haskell-button',
                    opts: {
                        classes: ['cancel'],
                        events: {
                            click: () => {
                                proc.kill('SIGTERM');
                                proc.kill('SIGKILL');
                            },
                        },
                    },
                }));
            }
            proc.once('exit', (code, signal) => {
                if (code === 0) {
                    resolve(true);
                }
                else {
                    reject(new Error(`Stack build exited with nonzero exit status ${code} due to ${signal}`));
                    Util.warn(messages.map((m) => m.message).join('\n'));
                }
            });
        });
    }
    catch (e) {
        Util.warn(e);
        atom.notifications.addError(e.toString(), {
            dismissable: true,
            detail: messages.map((m) => m.message).join('\n'),
        });
        return false;
    }
    finally {
        upi && upi.setMessages([]);
        disp.dispose();
    }
}
exports.buildStack = buildStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGQtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZ2hjLW1vZC9idWlsZC1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUEwQztBQUUxQyxvQ0FBbUM7QUFDbkMsMkJBQXdCO0FBQ3hCLGdDQUErQjtBQUd4QixLQUFLLHFCQUNWLElBQWdCLEVBQ2hCLEdBQTZCO0lBRTdCLE1BQU0sUUFBUSxHQUFrQixFQUFFLENBQUE7SUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO0lBQ3RDLElBQUksQ0FBQztRQUNILE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FDakMsT0FBTyxFQUNQLENBQUMsa0JBQWtCLEVBQUUsbUJBQW1CLENBQUMsRUFDekMsSUFBSSxDQUNMO2FBQ0UsSUFBSSxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUNuRSxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDekIsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFBO1FBQ3hFLE1BQU0sQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFVLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3BELE1BQU0sSUFBSSxHQUFHLENBQUMsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLENBQUE7WUFDMUMsRUFBRSxDQUFDLENBQUMsZUFBZSxDQUFDO2dCQUFD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Q2YsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDTixNQUFNLENBQ0osSUFBSSxLQUFLLENBQ1AsK0NBQStDLElBQUksV0FBVyxNQUFNLEVBQUUsQ0FDdkUsQ0FDRixDQUFBO29CQUNELElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO2dCQUN0RCxDQUFDO1lBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1gsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNaLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUN4QyxXQUFXLEVBQUUsSUFBSTtZQUNqQixNQUFNLEVBQUUsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDbEQsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQTtJQUNkLENBQUM7WUFBUyxDQUFDO1FBQ1QsR0FBRyxJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDMUIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ2hCLENBQUM7QUFDSCxDQUFDO0FBckZELGdDQXFGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgSVVQSUluc3RhbmNlLCBJUmVzdWx0SXRlbSB9IGZyb20gJ2F0b20taGFza2VsbC11cGknXG5pbXBvcnQgKiBhcyBDUCBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IHsgRU9MIH0gZnJvbSAnb3MnXG5pbXBvcnQgKiBhcyBVdGlsIGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgeyBSdW5PcHRpb25zIH0gZnJvbSAnLi9naGMtbW9kaS1wcm9jZXNzLXJlYWwnXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZFN0YWNrKFxuICBvcHRzOiBSdW5PcHRpb25zLFxuICB1cGk6IElVUElJbnN0YW5jZSB8IHVuZGVmaW5lZCxcbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICBjb25zdCBtZXNzYWdlczogSVJlc3VsdEl0ZW1bXSA9IFtdXG4gIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHRyeSB7XG4gICAgY29uc3QgdmVycyA9IGF3YWl0IFV0aWwuZXhlY1Byb21pc2UoXG4gICAgICAnc3RhY2snLFxuICAgICAgWyctLW5vLWluc3RhbGwtZ2hjJywgJy0tbnVtZXJpYy12ZXJzaW9uJ10sXG4gICAgICBvcHRzLFxuICAgIClcbiAgICAgIC50aGVuKCh7IHN0ZG91dCB9KSA9PiBzdGRvdXQuc3BsaXQoJy4nKS5tYXAoKG4pID0+IHBhcnNlSW50KG4sIDEwKSkpXG4gICAgICAuY2F0Y2goKCkgPT4gdW5kZWZpbmVkKVxuICAgIGNvbnN0IGhhc0NvcHlDb21waWxlciA9IHZlcnMgPyBVdGlsLnZlcnNBdExlYXN0KHZlcnMsIFsxLCA2LCAxXSkgOiBmYWxzZVxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBhcmdzID0gWyctLW5vLWluc3RhbGwtZ2hjJywgJ2J1aWxkJ11cbiAgICAgIGlmIChoYXNDb3B5Q29tcGlsZXIpIGFyZ3MucHVzaCgnLS1jb3B5LWNvbXBpbGVyLXRvb2wnKVxuICAgICAgYXJncy5wdXNoKCdnaGMtbW9kJylcbiAgICAgIFV0aWwud2FybihgUnVubmluZyBzdGFjayAke2FyZ3Muam9pbignICcpfWApXG4gICAgICBjb25zdCBwcm9jID0gQ1Auc3Bhd24oJ3N0YWNrJywgYXJncywgb3B0cylcbiAgICAgIGNvbnN0IGJ1ZmZlcmVkID0gKCkgPT4ge1xuICAgICAgICBsZXQgYnVmZmVyID0gJydcbiAgICAgICAgcmV0dXJuIChkYXRhOiBCdWZmZXIpID0+IHtcbiAgICAgICAgICBjb25zdCBvdXRwdXQgPSBkYXRhLnRvU3RyaW5nKCd1dGY4JylcbiAgICAgICAgICBjb25zdCBbZmlyc3QsIC4uLnRhaWxdID0gb3V0cHV0LnNwbGl0KEVPTClcbiAgICAgICAgICBidWZmZXIgKz0gZmlyc3RcbiAgICAgICAgICBpZiAodGFpbC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAvLyBpdCBtZWFucyB0aGVyZSdzIGF0IGxlYXN0IG9uZSBuZXdsaW5lXG4gICAgICAgICAgICBjb25zdCBsaW5lcyA9IFtidWZmZXIsIC4uLnRhaWwuc2xpY2UoMCwgLTEpXVxuICAgICAgICAgICAgYnVmZmVyID0gdGFpbC5zbGljZSgtMSlbMF1cbiAgICAgICAgICAgIG1lc3NhZ2VzLnB1c2goXG4gICAgICAgICAgICAgIC4uLmxpbmVzLm1hcCgobWVzc2FnZSkgPT4gKHsgbWVzc2FnZSwgc2V2ZXJpdHk6ICdidWlsZCcgfSkpLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgaWYgKHVwaSkge1xuICAgICAgICAgICAgICB1cGkuc2V0TWVzc2FnZXMobWVzc2FnZXMpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkSW5mbyhsaW5lcy5qb2luKCdcXG4nKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGxpbmVzLmpvaW4oJ1xcbicpKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcHJvYy5zdGRvdXQub24oJ2RhdGEnLCBidWZmZXJlZCgpKVxuICAgICAgcHJvYy5zdGRlcnIub24oJ2RhdGEnLCBidWZmZXJlZCgpKVxuICAgICAgaWYgKHVwaSkge1xuICAgICAgICBkaXNwLmFkZChcbiAgICAgICAgICB1cGkuYWRkUGFuZWxDb250cm9sKHtcbiAgICAgICAgICAgIGVsZW1lbnQ6ICdpZGUtaGFza2VsbC1idXR0b24nLFxuICAgICAgICAgICAgb3B0czoge1xuICAgICAgICAgICAgICBjbGFzc2VzOiBbJ2NhbmNlbCddLFxuICAgICAgICAgICAgICBldmVudHM6IHtcbiAgICAgICAgICAgICAgICBjbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgcHJvYy5raWxsKCdTSUdURVJNJylcbiAgICAgICAgICAgICAgICAgIHByb2Mua2lsbCgnU0lHS0lMTCcpXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIClcbiAgICAgIH1cbiAgICAgIHByb2Mub25jZSgnZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgICByZXNvbHZlKHRydWUpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVqZWN0KFxuICAgICAgICAgICAgbmV3IEVycm9yKFxuICAgICAgICAgICAgICBgU3RhY2sgYnVpbGQgZXhpdGVkIHdpdGggbm9uemVybyBleGl0IHN0YXR1cyAke2NvZGV9IGR1ZSB0byAke3NpZ25hbH1gLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApXG4gICAgICAgICAgVXRpbC53YXJuKG1lc3NhZ2VzLm1hcCgobSkgPT4gbS5tZXNzYWdlKS5qb2luKCdcXG4nKSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9IGNhdGNoIChlKSB7XG4gICAgVXRpbC53YXJuKGUpXG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKGUudG9TdHJpbmcoKSwge1xuICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICBkZXRhaWw6IG1lc3NhZ2VzLm1hcCgobSkgPT4gbS5tZXNzYWdlKS5qb2luKCdcXG4nKSxcbiAgICB9KVxuICAgIHJldHVybiBmYWxzZVxuICB9IGZpbmFsbHkge1xuICAgIHVwaSAmJiB1cGkuc2V0TWVzc2FnZXMoW10pXG4gICAgZGlzcC5kaXNwb3NlKClcbiAgfVxufVxuIl19