"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const Util = require("../util");
class ModuleInfo {
    constructor(name, process, rootDir) {
        this.name = name;
        this.process = process;
        this.rootDir = rootDir;
        this.invalidateInterval = 30 * 60 * 1000;
        this.destroy = () => {
            Util.debug(`${this.name} destroyed`);
            clearTimeout(this.timeout);
            this.emitter.emit('did-destroy');
            this.disposables.dispose();
        };
        Util.debug(`${this.name} created`);
        this.symbols = [];
        this.disposables = new atom_1.CompositeDisposable();
        this.bufferSet = new WeakSet();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        this.updatePromise = this.update(rootDir);
        this.timeout = setTimeout(this.destroy, this.invalidateInterval);
        this.disposables.add(this.process.onDidDestroy(this.destroy));
    }
    onDidDestroy(callback) {
        return this.emitter.on('did-destroy', callback);
    }
    async setBuffer(bufferInfo) {
        const name = await bufferInfo.getModuleName();
        if (name !== this.name) {
            return;
        }
        if (this.bufferSet.has(bufferInfo.buffer)) {
            return;
        }
        this.bufferSet.add(bufferInfo.buffer);
        Util.debug(`${this.name} buffer is set`);
        const disposables = new atom_1.CompositeDisposable();
        disposables.add(bufferInfo.buffer.onDidSave(() => {
            Util.debug(`${this.name} did-save triggered`);
            this.updatePromise = this.update(this.rootDir);
        }));
        disposables.add(bufferInfo.buffer.onDidDestroy(() => {
            disposables.dispose();
            this.bufferSet.delete(bufferInfo.buffer);
            this.disposables.remove(disposables);
        }));
        this.disposables.add(disposables);
    }
    async select(importDesc, symbolTypes, skipQualified = false) {
        await this.updatePromise;
        clearTimeout(this.timeout);
        this.timeout = setTimeout(this.destroy, this.invalidateInterval);
        let symbols = this.symbols;
        if (importDesc.importList) {
            const il = importDesc.importList;
            symbols = symbols.filter((s) => {
                const inImportList = il.includes(s.name);
                const parentInImportList = il.some((i) => typeof i !== 'string' && s.parent === i.parent);
                const shouldShow = inImportList || parentInImportList;
                return importDesc.hiding !== shouldShow;
            });
        }
        const res = [];
        for (const symbol of symbols) {
            if (symbolTypes && !symbolTypes.includes(symbol.symbolType)) {
                continue;
            }
            const specific = {
                name: symbol.name,
                typeSignature: symbol.typeSignature,
                symbolType: symbol.symbolType,
                module: importDesc,
            };
            const qn = (n) => `${importDesc.alias || importDesc.name}.${n}`;
            if (!skipQualified) {
                res.push(Object.assign({}, specific, { qparent: symbol.parent ? qn(symbol.parent) : undefined, qname: qn(symbol.name) }));
            }
            if (!importDesc.qualified) {
                res.push(Object.assign({}, specific, { qparent: symbol.parent, qname: symbol.name }));
            }
        }
        return res;
    }
    async update(rootDir) {
        Util.debug(`${this.name} updating`);
        this.symbols = await this.process.runBrowse(rootDir, [this.name]);
        Util.debug(`${this.name} updated`);
    }
}
exports.ModuleInfo = ModuleInfo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlLWluZm8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tcGxldGlvbi1iYWNrZW5kL21vZHVsZS1pbmZvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQTBFO0FBQzFFLGdDQUErQjtBQU8vQjtJQVdFLFlBQ21CLElBQVksRUFDWixPQUF1QixFQUN2QixPQUFrQjtRQUZsQixTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFDdkIsWUFBTyxHQUFQLE9BQU8sQ0FBVztRQVRwQix1QkFBa0IsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQTtRQXNCN0MsWUFBTyxHQUFHLEdBQUcsRUFBRTtZQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksWUFBWSxDQUFDLENBQUE7WUFDcEMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUMxQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQTtZQUNoQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQzVCLENBQUMsQ0FBQTtRQWhCQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksVUFBVSxDQUFDLENBQUE7UUFDbEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUE7UUFDakIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDNUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBQzlCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxjQUFPLEVBQUUsQ0FBQTtRQUM1QixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDbEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENB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QUN0QixDQUFBO1lBQ0osQ0FBQztZQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQzFCLEdBQUcsQ0FBQyxJQUFJLG1CQUNILFFBQVEsSUFDWCxPQUFPLEVBQUUsTUFBTSxDQUFDLE1BQU0sRUFDdEIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLElBQ2xCLENBQUE7WUFDSixDQUFDO1FBQ0gsQ0FBQztRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUE7SUFDWixDQUFDO0lBRU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFrQjtRQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksV0FBVyxDQUFDLENBQUE7UUFDbkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO1FBQ2pFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxVQUFVLENBQUMsQ0FBQTtJQUNwQyxDQUFDO0NBQ0Y7QUF4SEQsZ0NBd0hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgRW1pdHRlciwgVGV4dEJ1ZmZlciwgRGlyZWN0b3J5IH0gZnJvbSAnYXRvbSdcbmltcG9ydCAqIGFzIFV0aWwgZnJvbSAnLi4vdXRpbCdcbmltcG9ydCB7IEdoY01vZGlQcm9jZXNzLCBTeW1ib2xEZXNjIH0gZnJvbSAnLi4vZ2hjLW1vZCdcbmltcG9ydCB7IEJ1ZmZlckluZm8sIElJbXBvcnQgfSBmcm9tICcuL2J1ZmZlci1pbmZvJ1xuaW1wb3J0ICogYXMgQ29tcGxldGlvbkJhY2tlbmQgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaS9jb21wbGV0aW9uLWJhY2tlbmQnXG5cbmltcG9ydCBTeW1ib2xUeXBlID0gQ29tcGxldGlvbkJhY2tlbmQuU3ltYm9sVHlwZVxuXG5leHBvcnQgY2xhc3MgTW9kdWxlSW5mbyB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgcHJpdmF0ZSByZWFkb25seSBlbWl0dGVyOiBFbWl0dGVyPHtcbiAgICAnZGlkLWRlc3Ryb3knOiB1bmRlZmluZWRcbiAgfT5cbiAgcHJpdmF0ZSByZWFkb25seSBpbnZhbGlkYXRlSW50ZXJ2YWwgPSAzMCAqIDYwICogMTAwMCAvLyBpZiBtb2R1bGUgdW51c2VkIGZvciAzMCBtaW51dGVzLCByZW1vdmUgaXRcbiAgcHJpdmF0ZSByZWFkb25seSBidWZmZXJTZXQ6IFdlYWtTZXQ8VGV4dEJ1ZmZlcj5cbiAgcHJpdmF0ZSB0aW1lb3V0OiBOb2RlSlMuVGltZXJcbiAgcHJpdmF0ZSB1cGRhdGVQcm9taXNlOiBQcm9taXNlPHZvaWQ+XG4gIHByaXZhdGUgc3ltYm9sczogU3ltYm9sRGVzY1tdIC8vIG1vZHVsZSBzeW1ib2xzXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBuYW1lOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9jZXNzOiBHaGNNb2RpUHJvY2VzcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJvb3REaXI6IERpcmVjdG9yeSxcbiAgKSB7XG4gICAgVXRpbC5kZWJ1ZyhgJHt0aGlzLm5hbWV9IGNyZWF0ZWRgKVxuICAgIHRoaXMuc3ltYm9scyA9IFtdXG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmJ1ZmZlclNldCA9IG5ldyBXZWFrU2V0KClcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxuICAgIHRoaXMudXBkYXRlUHJvbWlzZSA9IHRoaXMudXBkYXRlKHJvb3REaXIpXG4gICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCh0aGlzLmRlc3Ryb3ksIHRoaXMuaW52YWxpZGF0ZUludGVydmFsKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucHJvY2Vzcy5vbkRpZERlc3Ryb3kodGhpcy5kZXN0cm95KSlcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95ID0gKCkgPT4ge1xuICAgIFV0aWwuZGVidWcoYCR7dGhpcy5uYW1lfSBkZXN0cm95ZWRgKVxuICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXQpXG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1kZXN0cm95JylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG5cbiAgcHVibGljIG9uRGlkRGVzdHJveShjYWxsYmFjazogKCkgPT4gdm9pZCkge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1kZXN0cm95JywgY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2V0QnVmZmVyKGJ1ZmZlckluZm86IEJ1ZmZlckluZm8pIHtcbiAgICBjb25zdCBuYW1lID0gYXdhaXQgYnVmZmVySW5mby5nZXRNb2R1bGVOYW1lKClcbiAgICBpZiAobmFtZSAhPT0gdGhpcy5uYW1lKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgaWYgKHRoaXMuYnVmZmVyU2V0LmhhcyhidWZmZXJJbmZvLmJ1ZmZlcikpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICB0aGlzLmJ1ZmZlclNldC5hZGQoYnVmZmVySW5mby5idWZmZXIpXG4gICAgVXRpbC5kZWJ1ZyhgJHt0aGlzLm5hbWV9IGJ1ZmZlciBpcyBzZXRgKVxuICAgIGNvbnN0IGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGJ1ZmZlckluZm8uYnVmZmVyLm9uRGlkU2F2ZSgoKSA9PiB7XG4gICAgICAgIFV0aWwuZGVidWcoYCR7dGhpcy5uYW1lfSBkaWQtc2F2ZSB0cmlnZ2VyZWRgKVxuICAgICAgICB0aGlzLnVwZGF0ZVByb21pc2UgPSB0aGlzLnVwZGF0ZSh0aGlzLnJvb3REaXIpXG4gICAgICB9KSxcbiAgICApXG4gICAgZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgYnVmZmVySW5mby5idWZmZXIub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgICAgZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gICAgICAgIHRoaXMuYnVmZmVyU2V0LmRlbGV0ZShidWZmZXJJbmZvLmJ1ZmZlcilcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5yZW1vdmUoZGlzcG9zYWJsZXMpXG4gICAgICB9KSxcbiAgICApXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcG9zYWJsZXMpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2VsZWN0KFxuICAgIGltcG9ydERlc2M6IElJbXBvcnQsXG4gICAgc3ltYm9sVHlwZXM/OiBTeW1ib2xUeXBlW10sXG4gICAgc2tpcFF1YWxpZmllZDogYm9vbGVhbiA9IGZhbHNlLFxuICApIHtcbiAgICBhd2FpdCB0aGlzLnVwZGF0ZVByb21pc2VcbiAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KVxuICAgIHRoaXMudGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5kZXN0cm95LCB0aGlzLmludmFsaWRhdGVJbnRlcnZhbClcbiAgICBsZXQgc3ltYm9scyA9IHRoaXMuc3ltYm9sc1xuICAgIGlmIChpbXBvcnREZXNjLmltcG9ydExpc3QpIHtcbiAgICAgIGNvbnN0IGlsID0gaW1wb3J0RGVzYy5pbXBvcnRMaXN0XG4gICAgICBzeW1ib2xzID0gc3ltYm9scy5maWx0ZXIoKHMpID0+IHtcbiAgICAgICAgY29uc3QgaW5JbXBvcnRMaXN0ID0gaWwuaW5jbHVkZXMocy5uYW1lKVxuICAgICAgICBjb25zdCBwYXJlbnRJbkltcG9ydExpc3QgPSBpbC5zb21lKFxuICAgICAgICAgIChpKSA9PiB0eXBlb2YgaSAhPT0gJ3N0cmluZycgJiYgcy5wYXJlbnQgPT09IGkucGFyZW50LFxuICAgICAgICApXG4gICAgICAgIGNvbnN0IHNob3VsZFNob3cgPSBpbkltcG9ydExpc3QgfHwgcGFyZW50SW5JbXBvcnRMaXN0XG4gICAgICAgIHJldHVybiBpbXBvcnREZXNjLmhpZGluZyAhPT0gc2hvdWxkU2hvdyAvLyBYT1JcbiAgICAgIH0pXG4gICAgfVxuICAgIGNvbnN0IHJlcyA9IFtdXG4gICAgZm9yIChjb25zdCBzeW1ib2wgb2Ygc3ltYm9scykge1xuICAgICAgaWYgKHN5bWJvbFR5cGVzICYmICFzeW1ib2xUeXBlcy5pbmNsdWRlcyhzeW1ib2wuc3ltYm9sVHlwZSkpIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH1cbiAgICAgIGNvbnN0IHNwZWNpZmljID0ge1xuICAgICAgICBuYW1lOiBzeW1ib2wubmFtZSxcbiAgICAgICAgdHlwZVNpZ25hdHVyZTogc3ltYm9sLnR5cGVTaWduYXR1cmUsXG4gICAgICAgIHN5bWJvbFR5cGU6IHN5bWJvbC5zeW1ib2xUeXBlLFxuICAgICAgICBtb2R1bGU6IGltcG9ydERlc2MsXG4gICAgICB9XG4gICAgICBjb25zdCBxbiA9IChuOiBzdHJpbmcpID0+IGAke2ltcG9ydERlc2MuYWxpYXMgfHwgaW1wb3J0RGVzYy5uYW1lfS4ke259YFxuICAgICAgaWYgKCFza2lwUXVhbGlmaWVkKSB7XG4gICAgICAgIHJlcy5wdXNoKHtcbiAgICAgICAgICAuLi5zcGVjaWZpYyxcbiAgICAgICAgICBxcGFyZW50OiBzeW1ib2wucGFyZW50ID8gcW4oc3ltYm9sLnBhcmVudCkgOiB1bmRlZmluZWQsXG4gICAgICAgICAgcW5hbWU6IHFuKHN5bWJvbC5uYW1lKSxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIGlmICghaW1wb3J0RGVzYy5xdWFsaWZpZWQpIHtcbiAgICAgICAgcmVzLnB1c2goe1xuICAgICAgICAgIC4uLnNwZWNpZmljLFxuICAgICAgICAgIHFwYXJlbnQ6IHN5bWJvbC5wYXJlbnQsXG4gICAgICAgICAgcW5hbWU6IHN5bWJvbC5uYW1lLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVwZGF0ZShyb290RGlyOiBEaXJlY3RvcnkpIHtcbiAgICBVdGlsLmRlYnVnKGAke3RoaXMubmFtZX0gdXBkYXRpbmdgKVxuICAgIHRoaXMuc3ltYm9scyA9IGF3YWl0IHRoaXMucHJvY2Vzcy5ydW5Ccm93c2Uocm9vdERpciwgW3RoaXMubmFtZV0pXG4gICAgVXRpbC5kZWJ1ZyhgJHt0aGlzLm5hbWV9IHVwZGF0ZWRgKVxuICB9XG59XG4iXX0=