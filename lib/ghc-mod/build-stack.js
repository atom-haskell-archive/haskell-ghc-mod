"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const CP = require("child_process");
const os_1 = require("os");
const Util = require("../util");
async function buildStack(opts, upi) {
    const messages = [];
    const disp = new atom_1.CompositeDisposable();
    try {
        const vers = await Util.execPromise('stack', ['--no-install-ghc', '--numeric-version'], opts)
            .then(({ stdout }) => stdout.split('.').map((n) => parseInt(n, 10)))
            .catch(() => undefined);
        const hasCopyCompiler = vers ? Util.versAtLeast(vers, [1, 6, 1]) : false;
        return await new Promise((resolve, reject) => {
            const args = ['--no-install-ghc', 'build'];
            if (hasCopyCompiler)
                args.push('--copy-compiler-tool');
            args.push('ghc-mod');
            Util.warn(`Running stack ${args.join(' ')}`);
            const proc = CP.spawn('stack', args, opts);
            const buffered = () => {
                let buffer = '';
                return (data) => {
                    const output = data.toString('utf8');
                    const [first, ...tail] = output.split(os_1.EOL);
                    buffer += first;
                    if (tail.length > 0) {
                        const lines = [buffer, ...tail.slice(0, -1)];
                        buffer = tail.slice(-1)[0];
                        messages.push(...lines.map((message) => ({ message, severity: 'build' })));
                        if (upi) {
                            upi.setMessages(messages);
                        }
                        else {
                            atom.notifications.addInfo(lines.join('\n'));
                        }
                        console.log(lines.join('\n'));
                    }
                };
            };
            proc.stdout.on('data', buffered());
            proc.stderr.on('data', buffered());
            if (upi) {
                disp.add(upi.addPanelControl({
                    element: 'ide-haskell-button',
                    opts: {
                        classes: ['cancel'],
                        events: {
                            click: () => {
                                proc.kill('SIGTERM');
                                proc.kill('SIGKILL');
                            },
                        },
                    },
                }));
            }
            proc.once('exit', (code, signal) => {
                if (code === 0) {
                    resolve(true);
                }
                else {
                    reject(new Error(`Stack build exited with nonzero exit status ${code} due to ${signal}`));
                    Util.warn(messages.map((m) => m.message).join('\n'));
                }
            });
        });
    }
    catch (e) {
        Util.warn(e);
        atom.notifications.addError(e.toString(), {
            dismissable: true,
            detail: messages.map((m) => m.message).join('\n'),
        });
        return false;
    }
    finally {
        upi && upi.setMessages([]);
        disp.dispose();
    }
}
exports.buildStack = buildStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGQtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZ2hjLW1vZC9idWlsZC1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUEwQztBQUUxQyxvQ0FBbUM7QUFDbkMsMkJBQXdCO0FBQ3hCLGdDQUErQjtBQUd4QixLQUFLLFVBQVUsVUFBVSxDQUM5QixJQUFnQixFQUNoQixHQUE2QjtJQUU3QixNQUFNLFFBQVEsR0FBa0IsRUFBRSxDQUFBO0lBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUN0QyxJQUFJO1FBQ0YsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUNqQyxPQUFPLEVBQ1AsQ0FBQyxrQkFBa0IsRUFBRSxtQkFBbUIsQ0FBQyxFQUN6QyxJQUFJLENBQ0w7YUFDRSxJQUFJLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ25FLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUN6QixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUE7UUFDeEUsT0FBTyxNQUFNLElBQUksT0FBTyxDQUFVLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3BELE1BQU0sSUFBSSxHQUFHLENBQUMsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLENBQUE7WUFDMUMsSUFBSSxlQUFlO2dCQUFFLElBQUksQ0FBQyxJQUFJ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QUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtpQkFDckQ7WUFDSCxDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0tBQ0g7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDWixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDeEMsV0FBVyxFQUFFLElBQUk7WUFDakIsTUFBTSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ2xELENBQUMsQ0FBQTtRQUNGLE9BQU8sS0FBSyxDQUFBO0tBQ2I7WUFBUztRQUNSLEdBQUcsSUFBSSxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQzFCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtLQUNmO0FBQ0gsQ0FBQztBQXJGRCxnQ0FxRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IElVUElJbnN0YW5jZSwgSVJlc3VsdEl0ZW0gfSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0ICogYXMgQ1AgZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJ1xuaW1wb3J0ICogYXMgVXRpbCBmcm9tICcuLi91dGlsJ1xuaW1wb3J0IHsgUnVuT3B0aW9ucyB9IGZyb20gJy4vZ2hjLW1vZGktcHJvY2Vzcy1yZWFsJ1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYnVpbGRTdGFjayhcbiAgb3B0czogUnVuT3B0aW9ucyxcbiAgdXBpOiBJVVBJSW5zdGFuY2UgfCB1bmRlZmluZWQsXG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgY29uc3QgbWVzc2FnZXM6IElSZXN1bHRJdGVtW10gPSBbXVxuICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICB0cnkge1xuICAgIGNvbnN0IHZlcnMgPSBhd2FpdCBVdGlsLmV4ZWNQcm9taXNlKFxuICAgICAgJ3N0YWNrJyxcbiAgICAgIFsnLS1uby1pbnN0YWxsLWdoYycsICctLW51bWVyaWMtdmVyc2lvbiddLFxuICAgICAgb3B0cyxcbiAgICApXG4gICAgICAudGhlbigoeyBzdGRvdXQgfSkgPT4gc3Rkb3V0LnNwbGl0KCcuJykubWFwKChuKSA9PiBwYXJzZUludChuLCAxMCkpKVxuICAgICAgLmNhdGNoKCgpID0+IHVuZGVmaW5lZClcbiAgICBjb25zdCBoYXNDb3B5Q29tcGlsZXIgPSB2ZXJzID8gVXRpbC52ZXJzQXRMZWFzdCh2ZXJzLCBbMSwgNiwgMV0pIDogZmFsc2VcbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgYXJncyA9IFsnLS1uby1pbnN0YWxsLWdoYycsICdidWlsZCddXG4gICAgICBpZiAoaGFzQ29weUNvbXBpbGVyKSBhcmdzLnB1c2goJy0tY29weS1jb21waWxlci10b29sJylcbiAgICAgIGFyZ3MucHVzaCgnZ2hjLW1vZCcpXG4gICAgICBVdGlsLndhcm4oYFJ1bm5pbmcgc3RhY2sgJHthcmdzLmpvaW4oJyAnKX1gKVxuICAgICAgY29uc3QgcHJvYyA9IENQLnNwYXduKCdzdGFjaycsIGFyZ3MsIG9wdHMpXG4gICAgICBjb25zdCBidWZmZXJlZCA9ICgpID0+IHtcbiAgICAgICAgbGV0IGJ1ZmZlciA9ICcnXG4gICAgICAgIHJldHVybiAoZGF0YTogQnVmZmVyKSA9PiB7XG4gICAgICAgICAgY29uc3Qgb3V0cHV0ID0gZGF0YS50b1N0cmluZygndXRmOCcpXG4gICAgICAgICAgY29uc3QgW2ZpcnN0LCAuLi50YWlsXSA9IG91dHB1dC5zcGxpdChFT0wpXG4gICAgICAgICAgYnVmZmVyICs9IGZpcnN0XG4gICAgICAgICAgaWYgKHRhaWwubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgLy8gaXQgbWVhbnMgdGhlcmUncyBhdCBsZWFzdCBvbmUgbmV3bGluZVxuICAgICAgICAgICAgY29uc3QgbGluZXMgPSBbYnVmZmVyLCAuLi50YWlsLnNsaWNlKDAsIC0xKV1cbiAgICAgICAgICAgIGJ1ZmZlciA9IHRhaWwuc2xpY2UoLTEpWzBdXG4gICAgICAgICAgICBtZXNzYWdlcy5wdXNoKFxuICAgICAgICAgICAgICAuLi5saW5lcy5tYXAoKG1lc3NhZ2UpID0+ICh7IG1lc3NhZ2UsIHNldmVyaXR5OiAnYnVpbGQnIH0pKSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIGlmICh1cGkpIHtcbiAgICAgICAgICAgICAgdXBpLnNldE1lc3NhZ2VzKG1lc3NhZ2VzKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8obGluZXMuam9pbignXFxuJykpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhsaW5lcy5qb2luKCdcXG4nKSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHByb2Muc3Rkb3V0Lm9uKCdkYXRhJywgYnVmZmVyZWQoKSlcbiAgICAgIHByb2Muc3RkZXJyLm9uKCdkYXRhJywgYnVmZmVyZWQoKSlcbiAgICAgIGlmICh1cGkpIHtcbiAgICAgICAgZGlzcC5hZGQoXG4gICAgICAgICAgdXBpLmFkZFBhbmVsQ29udHJvbCh7XG4gICAgICAgICAgICBlbGVtZW50OiAnaWRlLWhhc2tlbGwtYnV0dG9uJyxcbiAgICAgICAgICAgIG9wdHM6IHtcbiAgICAgICAgICAgICAgY2xhc3NlczogWydjYW5jZWwnXSxcbiAgICAgICAgICAgICAgZXZlbnRzOiB7XG4gICAgICAgICAgICAgICAgY2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgIHByb2Mua2lsbCgnU0lHVEVSTScpXG4gICAgICAgICAgICAgICAgICBwcm9jLmtpbGwoJ1NJR0tJTEwnKVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pLFxuICAgICAgICApXG4gICAgICB9XG4gICAgICBwcm9jLm9uY2UoJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlamVjdChcbiAgICAgICAgICAgIG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgYFN0YWNrIGJ1aWxkIGV4aXRlZCB3aXRoIG5vbnplcm8gZXhpdCBzdGF0dXMgJHtjb2RlfSBkdWUgdG8gJHtzaWduYWx9YCxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgKVxuICAgICAgICAgIFV0aWwud2FybihtZXNzYWdlcy5tYXAoKG0pID0+IG0ubWVzc2FnZSkuam9pbignXFxuJykpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfSBjYXRjaCAoZSkge1xuICAgIFV0aWwud2FybihlKVxuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlLnRvU3RyaW5nKCksIHtcbiAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgZGV0YWlsOiBtZXNzYWdlcy5tYXAoKG0pID0+IG0ubWVzc2FnZSkuam9pbignXFxuJyksXG4gICAgfSlcbiAgICByZXR1cm4gZmFsc2VcbiAgfSBmaW5hbGx5IHtcbiAgICB1cGkgJiYgdXBpLnNldE1lc3NhZ2VzKFtdKVxuICAgIGRpc3AuZGlzcG9zZSgpXG4gIH1cbn1cbiJdfQ==