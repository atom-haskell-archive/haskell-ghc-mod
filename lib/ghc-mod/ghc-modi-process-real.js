"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const interactive_process_1 = require("./interactive-process");
const Util = require("../util");
const { debug, withTempFile, EOT } = Util;
const os_1 = require("os");
const _ = require("underscore");
class GhcModiProcessReal {
    constructor(caps, rootDir, options) {
        this.caps = caps;
        this.rootDir = rootDir;
        this.options = options;
        this.runModCmd = async ({ ghcModOptions, command, text, uri, args, }) => {
            const modPath = atom.config.get('haskell-ghc-mod.ghcModPath');
            let stdin;
            const cmd = [...ghcModOptions];
            if (text && uri) {
                cmd.push('--map-file', uri);
                stdin = `${text}${EOT}`;
            }
            cmd.push(command);
            if (uri) {
                cmd.push(uri);
            }
            cmd.push(...args);
            const { stdout, stderr } = await Util.execPromise(modPath, cmd, this.options, stdin);
            return {
                stdout: stdout.split(os_1.EOL).slice(0, -1),
                stderr: stderr.split(os_1.EOL),
            };
        };
        this.runModiCmd = async (o) => {
            const { ghcModOptions, command, text, args } = o;
            let { uri } = o;
            debug(`Trying to run ghc-modi in ${this.rootDir.getPath()}`);
            const proc = await this.spawnProcess(ghcModOptions);
            if (!proc) {
                debug('Failed. Falling back to ghc-mod');
                return this.runModCmd(o);
            }
            debug('Success. Resuming...');
            if (uri && !this.caps.quoteArgs) {
                uri = this.rootDir.relativize(uri);
            }
            try {
                if (uri && text) {
                    await proc.interact('map-file', [uri], text);
                }
                const res = await proc.interact(command, uri ? [uri].concat(args) : args);
                if (uri && text) {
                    await proc.interact('unmap-file', [uri]);
                }
                return res;
            }
            finally {
                if (uri && text) {
                    await proc.interact('unmap-file', [uri]);
                }
            }
        };
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
    }
    getCaps() {
        return this.caps;
    }
    async run(runArgs) {
        let { interactive, dashArgs, args, suppressErrors, ghcOptions, ghcModOptions, } = runArgs;
        const { command, text, uri, builder } = runArgs;
        if (!args) {
            args = [];
        }
        if (!dashArgs) {
            dashArgs = [];
        }
        if (!suppressErrors) {
            suppressErrors = false;
        }
        if (!ghcOptions) {
            ghcOptions = [];
        }
        if (!ghcModOptions) {
            ghcModOptions = [];
        }
        ghcModOptions = ghcModOptions.concat(...ghcOptions.map((opt) => ['--ghc-option', opt]));
        if (atom.config.get('haskell-ghc-mod.lowMemorySystem')) {
            interactive = atom.config.get('haskell-ghc-mod.enableGhcModi');
        }
        if (builder) {
            switch (builder) {
                case 'cabal':
                    ghcModOptions.push('--with-stack', '');
                    break;
                case 'stack':
                    ghcModOptions.push('--with-cabal', '');
                    break;
                case 'none':
                    ghcModOptions.push('--with-stack', '');
                    ghcModOptions.push('--with-cabal', '');
                    break;
                default:
                    atom.notifications.addWarning(`Haskell-ghc-mod: unknown builder ${builder}, falling back to autodetection`);
            }
        }
        if (this.caps.optparse) {
            args = dashArgs.concat(['--']).concat(args);
        }
        else {
            args = dashArgs.concat(args);
        }
        const fun = interactive ? this.runModiCmd : this.runModCmd;
        try {
            let res;
            if (uri && text && !this.caps.fileMap) {
                const myOpts = { ghcModOptions, command, args };
                res = withTempFile(text, uri, async (tempuri) => {
                    const { stdout, stderr } = await fun(Object.assign({}, myOpts, { uri: tempuri }));
                    return {
                        stdout: stdout.map((line) => line.split(tempuri).join(uri)),
                        stderr: stderr.map((line) => line.split(tempuri).join(uri)),
                    };
                });
            }
            else {
                res = fun({ ghcModOptions, command, text, uri, args });
            }
            const { stdout, stderr } = await res;
            if (stderr.join('').length) {
                this.emitter.emit('warning', stderr.join('\n'));
            }
            return stdout.map((line) => line.replace(/\0/g, '\n'));
        }
        catch (err) {
            debug(err);
            this.emitter.emit('error', { runArgs, err, caps: this.caps });
            return [];
        }
    }
    killProcess() {
        debug(`Killing ghc-modi process for ${this.rootDir.getPath()}`);
        this.proc && this.proc.kill();
    }
    destroy() {
        debug('GhcModiProcessBase destroying');
        this.killProcess();
        this.emitter.emit('did-destroy');
        this.disposables.dispose();
    }
    onDidDestroy(callback) {
        return this.emitter.on('did-destroy', callback);
    }
    onWarning(callback) {
        return this.emitter.on('warning', callback);
    }
    onError(callback) {
        return this.emitter.on('error', callback);
    }
    async spawnProcess(ghcModOptions) {
        if (!atom.config.get('haskell-ghc-mod.enableGhcModi')) {
            return undefined;
        }
        debug(`Checking for ghc-modi in ${this.rootDir.getPath()}`);
        if (this.proc) {
            if (!_.isEqual(this.ghcModOptions, ghcModOptions)) {
                debug(`Found running ghc-modi instance for ${this.rootDir.getPath()}, but ghcModOptions don't match. Old: `, this.ghcModOptions, ' new: ', ghcModOptions);
                await this.proc.kill();
                return this.spawnProcess(ghcModOptions);
            }
            debug(`Found running ghc-modi instance for ${this.rootDir.getPath()}`);
            return this.proc;
        }
        debug(`Spawning new ghc-modi instance for ${this.rootDir.getPath()} with`, this.options);
        const modPath = atom.config.get('haskell-ghc-mod.ghcModPath');
        this.ghcModOptions = ghcModOptions;
        this.proc = new interactive_process_1.InteractiveProcess(modPath, ghcModOptions.concat(['legacy-interactive']), this.options, this.caps);
        this.proc.onceExit((code) => {
            debug(`ghc-modi for ${this.rootDir.getPath()} ended with ${code}`);
            this.proc = undefined;
        });
        return this.proc;
    }
}
exports.GhcModiProcessReal = GhcModiProcessReal;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2hjLW1vZGktcHJvY2Vzcy1yZWFsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2doYy1tb2QvZ2hjLW1vZGktcHJvY2Vzcy1yZWFsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQThEO0FBQzlELCtEQUFzRTtBQUN0RSxnQ0FBK0I7QUFDL0IsTUFBTSxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFBO0FBQ3pDLDJCQUF3QjtBQUN4QixnQ0FBK0I7QUE4Qi9CLE1BQWEsa0JBQWtCO0lBYzdCLFlBQ1UsSUFBZ0IsRUFDaEIsT0FBa0IsRUFDbEIsT0FBbUI7UUFGbkIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQixZQUFPLEdBQVAsT0FBTyxDQUFXO1FBQ2xCLFlBQU8sR0FBUCxPQUFPLENBQVk7UUFnS3JCLGNBQVMsR0FBRyxLQUFLLEVBQUUsRUFDekIsYUFBYSxFQUNiLE9BQU8sRUFDUCxJQUFJLEVBQ0osR0FBRyxFQUNILElBQUksR0FPTCxFQUFFLEVBQUU7WUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFBO1lBQzdELElBQUksS0FBSyxDQUFBO1lBQ1QsTUFBTSxHQUFHLEdBQUcsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxDQUFBO1lBQzlCLElBQUksSUFBSSxJQUFJLEdBQUcsRUFBRTtnQkFDZixHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQTtnQkFDM0IsS0FBSyxHQUFHLEdBQUcsSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFBO2FBQ3hCO1lBQ0QsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUNqQixJQUFJLEdBQUcsRUFBRTtnQkFDUCxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2FBQ2Q7WUFDRCxHQUFHLENBQUMsSUFBSSxDQUFD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dUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDdEUsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFBO1NBQ2pCO1FBQ0QsS0FBSyxDQUNILHNDQUFzQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQ25FLElBQUksQ0FBQyxPQUFPLENBQ2IsQ0FBQTtRQUNELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDRCQUE0QixDQUFDLENBQUE7UUFDN0QsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUE7UUFDbEMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLHdDQUFrQixDQUNoQyxPQUFPLEVBQ1AsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLENBQUMsRUFDNUMsSUFBSSxDQUFDLE9BQU8sRUFDWixJQUFJLENBQUMsSUFBSSxDQUNWLENBQUE7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQzFCLEtBQUssQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsZUFBZSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1lBQ2xFLElBQUksQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFBO1FBQ3ZCLENBQUMsQ0FBQyxDQUFBO1FBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFBO0lBQ2xCLENBQUM7Q0F5RUY7QUF4UEQsZ0RBd1BDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0b3J5LCBFbWl0dGVyLCBDb21wb3NpdGVEaXNwb3NhYmxlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IEludGVyYWN0aXZlUHJvY2VzcywgR0hDTW9kQ2FwcyB9IGZyb20gJy4vaW50ZXJhY3RpdmUtcHJvY2VzcydcbmltcG9ydCAqIGFzIFV0aWwgZnJvbSAnLi4vdXRpbCdcbmNvbnN0IHsgZGVidWcsIHdpdGhUZW1wRmlsZSwgRU9UIH0gPSBVdGlsXG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcydcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSdcblxuZXhwb3J0IHsgR0hDTW9kQ2FwcyB9XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnVuQXJncyB7XG4gIGludGVyYWN0aXZlPzogYm9vbGVhblxuICBjb21tYW5kOiBzdHJpbmdcbiAgdGV4dD86IHN0cmluZ1xuICB1cmk/OiBzdHJpbmdcbiAgZGFzaEFyZ3M/OiBzdHJpbmdbXVxuICBhcmdzPzogc3RyaW5nW11cbiAgc3VwcHJlc3NFcnJvcnM/OiBib29sZWFuXG4gIGdoY09wdGlvbnM/OiBzdHJpbmdbXVxuICBnaGNNb2RPcHRpb25zPzogc3RyaW5nW11cbiAgYnVpbGRlcjogc3RyaW5nIHwgdW5kZWZpbmVkXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnVuT3B0aW9ucyB7XG4gIGN3ZDogc3RyaW5nXG4gIGVuY29kaW5nOiAndXRmOCdcbiAgZW52OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IHVuZGVmaW5lZCB9XG4gIG1heEJ1ZmZlcjogbnVtYmVyXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUVycm9yQ2FsbGJhY2tBcmdzIHtcbiAgcnVuQXJncz86IFJ1bkFyZ3NcbiAgZXJyOiBFcnJvclxuICBjYXBzOiBHSENNb2RDYXBzXG59XG5cbmV4cG9ydCBjbGFzcyBHaGNNb2RpUHJvY2Vzc1JlYWwge1xuICBwcml2YXRlIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHByaXZhdGUgZW1pdHRlcjogRW1pdHRlcjxcbiAgICB7XG4gICAgICAnZGlkLWRlc3Ryb3knOiB2b2lkXG4gICAgfSxcbiAgICB7XG4gICAgICB3YXJuaW5nOiBzdHJpbmdcbiAgICAgIGVycm9yOiBJRXJyb3JDYWxsYmFja0FyZ3NcbiAgICB9XG4gID5cbiAgcHJpdmF0ZSBnaGNNb2RPcHRpb25zOiBzdHJpbmdbXSB8IHVuZGVmaW5lZFxuICBwcml2YXRlIHByb2M6IEludGVyYWN0aXZlUHJvY2VzcyB8IHVuZGVmaW5lZFxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY2FwczogR0hDTW9kQ2FwcyxcbiAgICBwcml2YXRlIHJvb3REaXI6IERpcmVjdG9yeSxcbiAgICBwcml2YXRlIG9wdGlvbnM6IFJ1bk9wdGlvbnMsXG4gICkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMuZW1pdHRlcilcbiAgfVxuXG4gIHB1YmxpYyBnZXRDYXBzKCk6IEdIQ01vZENhcHMge1xuICAgIHJldHVybiB0aGlzLmNhcHNcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBydW4ocnVuQXJnczogUnVuQXJncykge1xuICAgIGxldCB7XG4gICAgICBpbnRlcmFjdGl2ZSxcbiAgICAgIGRhc2hBcmdzLFxuICAgICAgYXJncyxcbiAgICAgIHN1cHByZXNzRXJyb3JzLFxuICAgICAgZ2hjT3B0aW9ucyxcbiAgICAgIGdoY01vZE9wdGlvbnMsXG4gICAgfSA9IHJ1bkFyZ3NcbiAgICBjb25zdCB7IGNvbW1hbmQsIHRleHQsIHVyaSwgYnVpbGRlciB9ID0gcnVuQXJnc1xuICAgIGlmICghYXJncykge1xuICAgICAgYXJncyA9IFtdXG4gICAgfVxuICAgIGlmICghZGFzaEFyZ3MpIHtcbiAgICAgIGRhc2hBcmdzID0gW11cbiAgICB9XG4gICAgaWYgKCFzdXBwcmVzc0Vycm9ycykge1xuICAgICAgc3VwcHJlc3NFcnJvcnMgPSBmYWxzZVxuICAgIH1cbiAgICBpZiAoIWdoY09wdGlvbnMpIHtcbiAgICAgIGdoY09wdGlvbnMgPSBbXVxuICAgIH1cbiAgICBpZiAoIWdoY01vZE9wdGlvbnMpIHtcbiAgICAgIGdoY01vZE9wdGlvbnMgPSBbXVxuICAgIH1cbiAgICBnaGNNb2RPcHRpb25zID0gZ2hjTW9kT3B0aW9ucy5jb25jYXQoXG4gICAgICAuLi5naGNPcHRpb25zLm1hcCgob3B0KSA9PiBbJy0tZ2hjLW9wdGlvbicsIG9wdF0pLFxuICAgIClcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QubG93TWVtb3J5U3lzdGVtJykpIHtcbiAgICAgIGludGVyYWN0aXZlID0gYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QuZW5hYmxlR2hjTW9kaScpXG4gICAgfVxuICAgIGlmIChidWlsZGVyKSB7XG4gICAgICBzd2l0Y2ggKGJ1aWxkZXIpIHtcbiAgICAgICAgY2FzZSAnY2FiYWwnOlxuICAgICAgICAgIC8vIGluIGNhc2UgdGhpcyBsb29rcyB3cm9uZywgcmVtZW1iZXIsIHdlIHdhbnQgdG8gZGlzYWJsZSBzdGFja1xuICAgICAgICAgIC8vIGFuZCB1c2UgY2FiYWwsIHNvIHdlJ3JlIHNldHRpbmcgc3RhY2sgcGF0aCB0byBlbXB0eXN0cmluZ1xuICAgICAgICAgIGdoY01vZE9wdGlvbnMucHVzaCgnLS13aXRoLXN0YWNrJywgJycpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSAnc3RhY2snOlxuICAgICAgICAgIC8vIHNhbWUsIGlmIHRoaXMgbG9va3Mgc3RyYW5nZSwgaXQncyBub3RcbiAgICAgICAgICBnaGNNb2RPcHRpb25zLnB1c2goJy0td2l0aC1jYWJhbCcsICcnKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ25vbmUnOlxuICAgICAgICAgIC8vIGhlcmUgd2Ugd2FudCB0byB1c2UgbmVpdGhlcj9cbiAgICAgICAgICBnaGNNb2RPcHRpb25zLnB1c2goJy0td2l0aC1zdGFjaycsICcnKVxuICAgICAgICAgIGdoY01vZE9wdGlvbnMucHVzaCgnLS13aXRoLWNhYmFsJywgJycpXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyhcbiAgICAgICAgICAgIGBIYXNrZWxsLWdoYy1tb2Q6IHVua25vd24gYnVpbGRlciAke2J1aWxkZXJ9LCBmYWxsaW5nIGJhY2sgdG8gYXV0b2RldGVjdGlvbmAsXG4gICAgICAgICAgKVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5jYXBzLm9wdHBhcnNlKSB7XG4gICAgICBhcmdzID0gZGFzaEFyZ3MuY29uY2F0KFsnLS0nXSkuY29uY2F0KGFyZ3MpXG4gICAgfSBlbHNlIHtcbiAgICAgIGFyZ3MgPSBkYXNoQXJncy5jb25jYXQoYXJncylcbiAgICB9XG4gICAgY29uc3QgZnVuID0gaW50ZXJhY3RpdmUgPyB0aGlzLnJ1bk1vZGlDbWQgOiB0aGlzLnJ1bk1vZENtZFxuICAgIHRyeSB7XG4gICAgICBsZXQgcmVzXG4gICAgICBpZiAodXJpICYmIHRleHQgJiYgIXRoaXMuY2Fwcy5maWxlTWFwKSB7XG4gICAgICAgIGNvbnN0IG15T3B0cyA9IHsgZ2hjTW9kT3B0aW9ucywgY29tbWFuZCwgYXJncyB9XG4gICAgICAgIHJlcyA9IHdpdGhUZW1wRmlsZSh0ZXh0LCB1cmksIGFzeW5jICh0ZW1wdXJpKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBzdGRvdXQsIHN0ZGVyciB9ID0gYXdhaXQgZnVuKHsgLi4ubXlPcHRzLCB1cmk6IHRlbXB1cmkgfSlcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3Rkb3V0OiBzdGRvdXQubWFwKChsaW5lKSA9PiBsaW5lLnNwbGl0KHRlbXB1cmkpLmpvaW4odXJpKSksXG4gICAgICAgICAgICBzdGRlcnI6IHN0ZGVyci5tYXAoKGxpbmUpID0+IGxpbmUuc3BsaXQodGVtcHVyaSkuam9pbih1cmkpKSxcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMgPSBmdW4oeyBnaGNNb2RPcHRpb25zLCBjb21tYW5kLCB0ZXh0LCB1cmksIGFyZ3MgfSlcbiAgICAgIH1cbiAgICAgIGNvbnN0IHsgc3Rkb3V0LCBzdGRlcnIgfSA9IGF3YWl0IHJlc1xuICAgICAgaWYgKHN0ZGVyci5qb2luKCcnKS5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ3dhcm5pbmcnLCBzdGRlcnIuam9pbignXFxuJykpXG4gICAgICB9XG4gICAgICByZXR1cm4gc3Rkb3V0Lm1hcCgobGluZSkgPT4gbGluZS5yZXBsYWNlKC9cXDAvZywgJ1xcbicpKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgZGVidWcoZXJyKVxuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2Vycm9yJywgeyBydW5BcmdzLCBlcnIsIGNhcHM6IHRoaXMuY2FwcyB9KVxuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGtpbGxQcm9jZXNzKCkge1xuICAgIGRlYnVnKGBLaWxsaW5nIGdoYy1tb2RpIHByb2Nlc3MgZm9yICR7dGhpcy5yb290RGlyLmdldFBhdGgoKX1gKVxuICAgIHRoaXMucHJvYyAmJiB0aGlzLnByb2Mua2lsbCgpXG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICBkZWJ1ZygnR2hjTW9kaVByb2Nlc3NCYXNlIGRlc3Ryb3lpbmcnKVxuICAgIHRoaXMua2lsbFByb2Nlc3MoKVxuICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtZGVzdHJveScpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZERlc3Ryb3koY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtZGVzdHJveScsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIG9uV2FybmluZyhjYWxsYmFjazogKHdhcm5pbmc6IHN0cmluZykgPT4gdm9pZCkge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ3dhcm5pbmcnLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBvbkVycm9yKGNhbGxiYWNrOiAoZXJyb3I6IElFcnJvckNhbGxiYWNrQXJncykgPT4gdm9pZCkge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2Vycm9yJywgY2FsbGJhY2spXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNwYXduUHJvY2VzcyhcbiAgICBnaGNNb2RPcHRpb25zOiBzdHJpbmdbXSxcbiAgKTogUHJvbWlzZTxJbnRlcmFjdGl2ZVByb2Nlc3MgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoIWF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmVuYWJsZUdoY01vZGknKSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cbiAgICBkZWJ1ZyhgQ2hlY2tpbmcgZm9yIGdoYy1tb2RpIGluICR7dGhpcy5yb290RGlyLmdldFBhdGgoKX1gKVxuICAgIGlmICh0aGlzLnByb2MpIHtcbiAgICAgIGlmICghXy5pc0VxdWFsKHRoaXMuZ2hjTW9kT3B0aW9ucywgZ2hjTW9kT3B0aW9ucykpIHtcbiAgICAgICAgZGVidWcoXG4gICAgICAgICAgYEZvdW5kIHJ1bm5pbmcgZ2hjLW1vZGkgaW5zdGFuY2UgZm9yICR7dGhpcy5yb290RGlyLmdldFBhdGgoKX0sIGJ1dCBnaGNNb2RPcHRpb25zIGRvbid0IG1hdGNoLiBPbGQ6IGAsXG4gICAgICAgICAgdGhpcy5naGNNb2RPcHRpb25zLFxuICAgICAgICAgICcgbmV3OiAnLFxuICAgICAgICAgIGdoY01vZE9wdGlvbnMsXG4gICAgICAgIClcbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jLmtpbGwoKVxuICAgICAgICByZXR1cm4gdGhpcy5zcGF3blByb2Nlc3MoZ2hjTW9kT3B0aW9ucylcbiAgICAgIH1cbiAgICAgIGRlYnVnKGBGb3VuZCBydW5uaW5nIGdoYy1tb2RpIGluc3RhbmNlIGZvciAke3RoaXMucm9vdERpci5nZXRQYXRoKCl9YClcbiAgICAgIHJldHVybiB0aGlzLnByb2NcbiAgICB9XG4gICAgZGVidWcoXG4gICAgICBgU3Bhd25pbmcgbmV3IGdoYy1tb2RpIGluc3RhbmNlIGZvciAke3RoaXMucm9vdERpci5nZXRQYXRoKCl9IHdpdGhgLFxuICAgICAgdGhpcy5vcHRpb25zLFxuICAgIClcbiAgICBjb25zdCBtb2RQYXRoID0gYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QuZ2hjTW9kUGF0aCcpXG4gICAgdGhpcy5naGNNb2RPcHRpb25zID0gZ2hjTW9kT3B0aW9uc1xuICAgIHRoaXMucHJvYyA9IG5ldyBJbnRlcmFjdGl2ZVByb2Nlc3MoXG4gICAgICBtb2RQYXRoLFxuICAgICAgZ2hjTW9kT3B0aW9ucy5jb25jYXQoWydsZWdhY3ktaW50ZXJhY3RpdmUnXSksXG4gICAgICB0aGlzLm9wdGlvbnMsXG4gICAgICB0aGlzLmNhcHMsXG4gICAgKVxuICAgIHRoaXMucHJvYy5vbmNlRXhpdCgoY29kZSkgPT4ge1xuICAgICAgZGVidWcoYGdoYy1tb2RpIGZvciAke3RoaXMucm9vdERpci5nZXRQYXRoKCl9IGVuZGVkIHdpdGggJHtjb2RlfWApXG4gICAgICB0aGlzLnByb2MgPSB1bmRlZmluZWRcbiAgICB9KVxuICAgIHJldHVybiB0aGlzLnByb2NcbiAgfVxuXG4gIHByaXZhdGUgcnVuTW9kQ21kID0gYXN5bmMgKHtcbiAgICBnaGNNb2RPcHRpb25zLFxuICAgIGNvbW1hbmQsXG4gICAgdGV4dCxcbiAgICB1cmksXG4gICAgYXJncyxcbiAgfToge1xuICAgIGdoY01vZE9wdGlvbnM6IHN0cmluZ1tdXG4gICAgY29tbWFuZDogc3RyaW5nXG4gICAgdGV4dD86IHN0cmluZ1xuICAgIHVyaT86IHN0cmluZ1xuICAgIGFyZ3M6IHN0cmluZ1tdXG4gIH0pID0+IHtcbiAgICBjb25zdCBtb2RQYXRoID0gYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QuZ2hjTW9kUGF0aCcpXG4gICAgbGV0IHN0ZGluXG4gICAgY29uc3QgY21kID0gWy4uLmdoY01vZE9wdGlvbnNdXG4gICAgaWYgKHRleHQgJiYgdXJpKSB7XG4gICAgICBjbWQucHVzaCgnLS1tYXAtZmlsZScsIHVyaSlcbiAgICAgIHN0ZGluID0gYCR7dGV4dH0ke0VPVH1gXG4gICAgfVxuICAgIGNtZC5wdXNoKGNvbW1hbmQpXG4gICAgaWYgKHVyaSkge1xuICAgICAgY21kLnB1c2godXJpKVxuICAgIH1cbiAgICBjbWQucHVzaCguLi5hcmdzKVxuICAgIGNvbnN0IHsgc3Rkb3V0LCBzdGRlcnIgfSA9IGF3YWl0IFV0aWwuZXhlY1Byb21pc2UoXG4gICAgICBtb2RQYXRoLFxuICAgICAgY21kLFxuICAgICAgdGhpcy5vcHRpb25zLFxuICAgICAgc3RkaW4sXG4gICAgKVxuICAgIHJldHVybiB7XG4gICAgICBzdGRvdXQ6IHN0ZG91dC5zcGxpdChFT0wpLnNsaWNlKDAsIC0xKSxcbiAgICAgIHN0ZGVycjogc3RkZXJyLnNwbGl0KEVPTCksXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBydW5Nb2RpQ21kID0gYXN5bmMgKG86IHtcbiAgICBnaGNNb2RPcHRpb25zOiBzdHJpbmdbXVxuICAgIGNvbW1hbmQ6IHN0cmluZ1xuICAgIHRleHQ/OiBzdHJpbmdcbiAgICB1cmk/OiBzdHJpbmdcbiAgICBhcmdzOiBzdHJpbmdbXVxuICB9KSA9PiB7XG4gICAgY29uc3QgeyBnaGNNb2RPcHRpb25zLCBjb21tYW5kLCB0ZXh0LCBhcmdzIH0gPSBvXG4gICAgbGV0IHsgdXJpIH0gPSBvXG4gICAgZGVidWcoYFRyeWluZyB0byBydW4gZ2hjLW1vZGkgaW4gJHt0aGlzLnJvb3REaXIuZ2V0UGF0aCgpfWApXG4gICAgY29uc3QgcHJvYyA9IGF3YWl0IHRoaXMuc3Bhd25Qcm9jZXNzKGdoY01vZE9wdGlvbnMpXG4gICAgaWYgKCFwcm9jKSB7XG4gICAgICBkZWJ1ZygnRmFpbGVkLiBGYWxsaW5nIGJhY2sgdG8gZ2hjLW1vZCcpXG4gICAgICByZXR1cm4gdGhpcy5ydW5Nb2RDbWQobylcbiAgICB9XG4gICAgZGVidWcoJ1N1Y2Nlc3MuIFJlc3VtaW5nLi4uJylcbiAgICBpZiAodXJpICYmICF0aGlzLmNhcHMucXVvdGVBcmdzKSB7XG4gICAgICB1cmkgPSB0aGlzLnJvb3REaXIucmVsYXRpdml6ZSh1cmkpXG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBpZiAodXJpICYmIHRleHQpIHtcbiAgICAgICAgYXdhaXQgcHJvYy5pbnRlcmFjdCgnbWFwLWZpbGUnLCBbdXJpXSwgdGV4dClcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHByb2MuaW50ZXJhY3QoY29tbWFuZCwgdXJpID8gW3VyaV0uY29uY2F0KGFyZ3MpIDogYXJncylcbiAgICAgIGlmICh1cmkgJiYgdGV4dCkge1xuICAgICAgICBhd2FpdCBwcm9jLmludGVyYWN0KCd1bm1hcC1maWxlJywgW3VyaV0pXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzXG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGlmICh1cmkgJiYgdGV4dCkge1xuICAgICAgICBhd2FpdCBwcm9jLmludGVyYWN0KCd1bm1hcC1maWxlJywgW3VyaV0pXG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=