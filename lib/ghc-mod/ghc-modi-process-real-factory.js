"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Util = require("../util");
const ghc_modi_process_real_1 = require("./ghc-modi-process-real");
async function createGhcModiProcessReal(rootDir, upi) {
    let opts;
    let vers;
    let caps;
    let builder;
    try {
        if (upi) {
            builder = await upi.getOthersConfigParam('ide-haskell-cabal', 'builder');
        }
        const bn = builder && builder.name;
        Util.debug(`Using builder ${bn}`);
        opts = await Util.getProcessOptions(rootDir.getPath());
        const versP = getVersion(opts);
        const bopts = opts;
        checkComp(bopts, versP, bn).catch((e) => {
            atom.notifications.addError('Failed to check compiler versions', {
                detail: e.toString(),
                stack: e.stack,
                dismissable: true,
            });
        });
        vers = await versP;
        caps = getCaps(vers);
        return new ghc_modi_process_real_1.GhcModiProcessReal(caps, rootDir, opts);
    }
    catch (e) {
        const err = e;
        Util.notifySpawnFail({ dir: rootDir.getPath(), err, opts, vers, caps });
        throw e;
    }
}
exports.createGhcModiProcessReal = createGhcModiProcessReal;
function getCaps({ vers }) {
    const caps = {
        version: vers,
        fileMap: false,
        quoteArgs: false,
        optparse: false,
        typeConstraints: false,
        browseParents: false,
        interactiveCaseSplit: false,
        importedFrom: false,
        browseMain: false,
    };
    const atLeast = (b) => {
        for (let i = 0; i < b.length; i++) {
            const v = b[i];
            if (vers[i] > v) {
                return true;
            }
            else if (vers[i] < v) {
                return false;
            }
        }
        return true;
    };
    const exact = (b) => {
        for (let i = 0; i < b.length; i++) {
            const v = b[i];
            if (vers[i] !== v) {
                return false;
            }
        }
        return true;
    };
    if (!atLeast([5, 4])) {
        atom.notifications.addError(`\
Haskell-ghc-mod: ghc-mod < 5.4 is not supported. \
Use at your own risk or update your ghc-mod installation`, { dismissable: true });
    }
    if (exact([5, 4])) {
        atom.notifications.addWarning(`\
Haskell-ghc-mod: ghc-mod 5.4.* is deprecated. \
Use at your own risk or update your ghc-mod installation`, { dismissable: true });
    }
    if (atLeast([5, 4])) {
        caps.fileMap = true;
    }
    if (atLeast([5, 5])) {
        caps.quoteArgs = true;
        caps.optparse = true;
    }
    if (atLeast([5, 6])) {
        caps.typeConstraints = true;
        caps.browseParents = true;
        caps.interactiveCaseSplit = true;
    }
    if (atom.config.get('haskell-ghc-mod.experimental')) {
        caps.importedFrom = true;
    }
    Util.debug(JSON.stringify(caps));
    return caps;
}
async function getVersion(opts) {
    const timeout = atom.config.get('haskell-ghc-mod.initTimeout') * 1000;
    const cmd = atom.config.get('haskell-ghc-mod.ghcModPath');
    const { stdout } = await Util.execPromise(cmd, ['version'], Object.assign({ timeout }, opts));
    const versRaw = /^ghc-mod version (\d+)\.(\d+)\.(\d+)(?:\.(\d+))?/.exec(stdout);
    if (!versRaw) {
        throw new Error("Couldn't get ghc-mod version");
    }
    const vers = versRaw.slice(1, 5).map((i) => parseInt(i, 10));
    const compRaw = /GHC (.+)$/.exec(stdout.trim());
    if (!compRaw) {
        throw new Error("Couldn't get ghc version");
    }
    const comp = compRaw[1];
    Util.debug(`Ghc-mod ${vers} built with ${comp}`);
    return { vers, comp };
}
async function checkComp(opts, versP, builder) {
    const { comp } = await versP;
    const timeout = atom.config.get('haskell-ghc-mod.initTimeout') * 1000;
    const tryWarn = async (cmd, args) => {
        try {
            return (await Util.execPromise(cmd, args, Object.assign({ timeout }, opts))).stdout.trim();
        }
        catch (error) {
            Util.warn(error);
            return undefined;
        }
    };
    const [stackghc, pathghc] = await Promise.all([
        tryWarn('stack', ['ghc', '--', '--numeric-version']),
        tryWarn('ghc', ['--numeric-version']),
    ]);
    Util.debug(`Stack GHC version ${stackghc}`);
    Util.debug(`Path GHC version ${pathghc}`);
    const warnStack = ['stack', undefined].includes(builder);
    const warnCabal = ['cabal', 'none', undefined].includes(builder);
    if (stackghc && (stackghc !== comp) && warnStack) {
        const warn = `\
GHC version in your Stack '${stackghc}' doesn't match with \
GHC version used to build ghc-mod '${comp}'. This can lead to \
problems when using Stack projects`;
        atom.notifications.addWarning(warn, {
            dismissable: builder !== undefined,
        });
        Util.warn(warn);
    }
    if (pathghc && (pathghc !== comp) && warnCabal) {
        const warn = `\
GHC version in your PATH '${pathghc}' doesn't match with \
GHC version used to build ghc-mod '${comp}'. This can lead to \
problems when using Cabal or Plain projects`;
        atom.notifications.addWarning(warn, {
            dismissable: builder !== undefined,
        });
        Util.warn(warn);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2hjLW1vZGktcHJvY2Vzcy1yZWFsLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZ2hjLW1vZC9naGMtbW9kaS1wcm9jZXNzLXJlYWwtZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLGdDQUErQjtBQUMvQixtRUFBd0U7QUFNakUsS0FBSyxtQ0FBbUMsT0FBa0IsRUFBRSxHQUE2QjtJQUM5RixJQUFJLElBQTRCLENBQUE7SUFDaEMsSUFBSSxJQUE0QixDQUFBO0lBQ2hDLElBQUksSUFBNEIsQ0FBQTtJQUNoQyxJQUFJLE9BQXFDLENBQUE7SUFDekMsSUFBSSxDQUFDO1FBQ0gsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUVSLE9BQU8sR0FBRyxNQUFNLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBbUIsbUJBQW1CLEVBQUUsU0FBUyxDQUFDLENBQUE7UUFDNUYsQ0FBQztRQUNELE1BQU0sRUFBRSxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFBO1FBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFFakMsSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFBO1FBQ3RELE1BQU0sS0FBSyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUM5QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUE7UUFFbEIsU0FBUyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBUSxFQUFFLEVBQUU7WUFDN0MsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsbUNBQW1DLEVBQUU7Z0JBQy9ELE1BQU0sRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFO2dCQUNwQixLQUFLLEVBQUUsQ0FBQyxDQUFDLEtBQUs7Z0JB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R0FBRzs2QkFDWSxRQUFRO3FDQUNBLElBQUk7bUNBQ04sQ0FBQTtRQUMvQixJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUU7WUFDbEMsV0FBVyxFQUFFLE9BQU8sS0FBSyxTQUFTO1NBQ25DLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDakIsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sS0FBSyxJQUFJLENBQUMsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sSUFBSSxHQUFHOzRCQUNXLE9BQU87cUNBQ0UsSUFBSTs0Q0FDRyxDQUFBO1FBQ3hDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRTtZQUNsQyxXQUFXLEVBQUUsT0FBTyxLQUFLLFNBQVM7U0FDbkMsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNqQixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdIQ01vZENhcHMgfSBmcm9tICcuL2ludGVyYWN0aXZlLXByb2Nlc3MnXG5pbXBvcnQgKiBhcyBVdGlsIGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgeyBHaGNNb2RpUHJvY2Vzc1JlYWwsIFJ1bk9wdGlvbnMgfSBmcm9tICcuL2doYy1tb2RpLXByb2Nlc3MtcmVhbCdcbmltcG9ydCB7IERpcmVjdG9yeSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBJVVBJSW5zdGFuY2UgfSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuXG5leHBvcnQgdHlwZSBHSENNb2RWZXJzID0geyB2ZXJzOiBudW1iZXJbXSwgY29tcDogc3RyaW5nIH1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUdoY01vZGlQcm9jZXNzUmVhbChyb290RGlyOiBEaXJlY3RvcnksIHVwaTogSVVQSUluc3RhbmNlIHwgdW5kZWZpbmVkKTogUHJvbWlzZTxHaGNNb2RpUHJvY2Vzc1JlYWw+IHtcbiAgbGV0IG9wdHM6IFJ1bk9wdGlvbnMgfCB1bmRlZmluZWRcbiAgbGV0IHZlcnM6IEdIQ01vZFZlcnMgfCB1bmRlZmluZWRcbiAgbGV0IGNhcHM6IEdIQ01vZENhcHMgfCB1bmRlZmluZWRcbiAgbGV0IGJ1aWxkZXI6IHsgbmFtZTogc3RyaW5nIH0gfCB1bmRlZmluZWRcbiAgdHJ5IHtcbiAgICBpZiAodXBpKSB7XG4gICAgICAvLyBUT0RPOiB0aGlzIGlzIHVzZWQgdHdpY2UsIHRoZSBzZWNvbmQgdGltZSBpbiBnaGMtbW9kL2luZGV4LnRzLCBzaG91bGQgcHJvYmFibHkgZml4IHRoYXRcbiAgICAgIGJ1aWxkZXIgPSBhd2FpdCB1cGkuZ2V0T3RoZXJzQ29uZmlnUGFyYW08eyBuYW1lOiBzdHJpbmcgfT4oJ2lkZS1oYXNrZWxsLWNhYmFsJywgJ2J1aWxkZXInKVxuICAgIH1cbiAgICBjb25zdCBibiA9IGJ1aWxkZXIgJiYgYnVpbGRlci5uYW1lXG4gICAgVXRpbC5kZWJ1ZyhgVXNpbmcgYnVpbGRlciAke2JufWApXG4gICAgLy8gVE9ETzogU2hvdWxkIHByZWZlciBzdGFjayBzYW5kYm94IHdoZW4gdXNpbmcgc3RhY2sgYW5kIGNhYmFsIHNhbmJkb3ggd2hlbiB1c2luZyBjYWJhbCFcbiAgICBvcHRzID0gYXdhaXQgVXRpbC5nZXRQcm9jZXNzT3B0aW9ucyhyb290RGlyLmdldFBhdGgoKSlcbiAgICBjb25zdCB2ZXJzUCA9IGdldFZlcnNpb24ob3B0cylcbiAgICBjb25zdCBib3B0cyA9IG9wdHNcbiAgICAvLyBUT0RPOiB0aGlzIGdldHMgY2hlY2tlZCBvbmx5IG9uY2UsIHNob3VsZCBjaGVjayBvbiBnaGMtbW9kIHJlc3RhcnQ/XG4gICAgY2hlY2tDb21wKGJvcHRzLCB2ZXJzUCwgYm4pLmNhdGNoKChlOiBFcnJvcikgPT4ge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdGYWlsZWQgdG8gY2hlY2sgY29tcGlsZXIgdmVyc2lvbnMnLCB7XG4gICAgICAgIGRldGFpbDogZS50b1N0cmluZygpLFxuICAgICAgICBzdGFjazogZS5zdGFjayxcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICB9KVxuICAgIH0pXG4gICAgdmVycyA9IGF3YWl0IHZlcnNQXG4gICAgY2FwcyA9IGdldENhcHModmVycylcbiAgICByZXR1cm4gbmV3IEdoY01vZGlQcm9jZXNzUmVhbChjYXBzLCByb290RGlyLCBvcHRzKVxuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuc2FmZS1hbnlcbiAgICBjb25zdCBlcnI6IEVycm9yICYge2NvZGU6IGFueX0gPSBlXG4gICAgVXRpbC5ub3RpZnlTcGF3bkZhaWwoeyBkaXI6IHJvb3REaXIuZ2V0UGF0aCgpLCBlcnIsIG9wdHMsIHZlcnMsIGNhcHMgfSlcbiAgICB0aHJvdyBlXG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Q2Fwcyh7IHZlcnMgfTogeyB2ZXJzOiBudW1iZXJbXSB9KTogR0hDTW9kQ2FwcyB7XG4gIGNvbnN0IGNhcHM6IEdIQ01vZENhcHMgPSB7XG4gICAgdmVyc2lvbjogdmVycyxcbiAgICBmaWxlTWFwOiBmYWxzZSxcbiAgICBxdW90ZUFyZ3M6IGZhbHNlLFxuICAgIG9wdHBhcnNlOiBmYWxzZSxcbiAgICB0eXBlQ29uc3RyYWludHM6IGZhbHNlLFxuICAgIGJyb3dzZVBhcmVudHM6IGZhbHNlLFxuICAgIGludGVyYWN0aXZlQ2FzZVNwbGl0OiBmYWxzZSxcbiAgICBpbXBvcnRlZEZyb206IGZhbHNlLFxuICAgIGJyb3dzZU1haW46IGZhbHNlLFxuICB9XG5cbiAgY29uc3QgYXRMZWFzdCA9IChiOiBudW1iZXJbXSkgPT4ge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYi5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgdiA9IGJbaV1cbiAgICAgIGlmICh2ZXJzW2ldID4gdikge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfSBlbHNlIGlmICh2ZXJzW2ldIDwgdikge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGNvbnN0IGV4YWN0ID0gKGI6IG51bWJlcltdKSA9PiB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB2ID0gYltpXVxuICAgICAgaWYgKHZlcnNbaV0gIT09IHYpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBpZiAoIWF0TGVhc3QoWzUsIDRdKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgIGBcXFxuSGFza2VsbC1naGMtbW9kOiBnaGMtbW9kIDwgNS40IGlzIG5vdCBzdXBwb3J0ZWQuIFxcXG5Vc2UgYXQgeW91ciBvd24gcmlzayBvciB1cGRhdGUgeW91ciBnaGMtbW9kIGluc3RhbGxhdGlvbmAsXG4gICAgICB7IGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgKVxuICB9XG4gIGlmIChleGFjdChbNSwgNF0pKSB7XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcoXG4gICAgICBgXFxcbkhhc2tlbGwtZ2hjLW1vZDogZ2hjLW1vZCA1LjQuKiBpcyBkZXByZWNhdGVkLiBcXFxuVXNlIGF0IHlvdXIgb3duIHJpc2sgb3IgdXBkYXRlIHlvdXIgZ2hjLW1vZCBpbnN0YWxsYXRpb25gLFxuICAgICAgeyBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgIClcbiAgfVxuICBpZiAoYXRMZWFzdChbNSwgNF0pKSB7XG4gICAgY2Fwcy5maWxlTWFwID0gdHJ1ZVxuICB9XG4gIGlmIChhdExlYXN0KFs1LCA1XSkpIHtcbiAgICBjYXBzLnF1b3RlQXJncyA9IHRydWVcbiAgICBjYXBzLm9wdHBhcnNlID0gdHJ1ZVxuICB9XG4gIGlmIChhdExlYXN0KFs1LCA2XSkpIHtcbiAgICBjYXBzLnR5cGVDb25zdHJhaW50cyA9IHRydWVcbiAgICBjYXBzLmJyb3dzZVBhcmVudHMgPSB0cnVlXG4gICAgY2Fwcy5pbnRlcmFjdGl2ZUNhc2VTcGxpdCA9IHRydWVcbiAgfVxuICBpZiAoYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QuZXhwZXJpbWVudGFsJykpIHtcbiAgICBjYXBzLmltcG9ydGVkRnJvbSA9IHRydWVcbiAgfVxuICBVdGlsLmRlYnVnKEpTT04uc3RyaW5naWZ5KGNhcHMpKVxuICByZXR1cm4gY2Fwc1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRWZXJzaW9uKG9wdHM6IFV0aWwuRXhlY09wdHMpOiBQcm9taXNlPEdIQ01vZFZlcnM+IHtcbiAgY29uc3QgdGltZW91dCA9IGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmluaXRUaW1lb3V0JykgKiAxMDAwXG4gIGNvbnN0IGNtZCA9IGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmdoY01vZFBhdGgnKVxuICBjb25zdCB7IHN0ZG91dCB9ID0gYXdhaXQgVXRpbC5leGVjUHJvbWlzZShjbWQsIFsndmVyc2lvbiddLCB7IHRpbWVvdXQsIC4uLm9wdHMgfSlcbiAgY29uc3QgdmVyc1JhdyA9IC9eZ2hjLW1vZCB2ZXJzaW9uIChcXGQrKVxcLihcXGQrKVxcLihcXGQrKSg/OlxcLihcXGQrKSk/Ly5leGVjKHN0ZG91dClcbiAgaWYgKCF2ZXJzUmF3KSB7IHRocm93IG5ldyBFcnJvcihcIkNvdWxkbid0IGdldCBnaGMtbW9kIHZlcnNpb25cIikgfVxuICBjb25zdCB2ZXJzID0gdmVyc1Jhdy5zbGljZSgxLCA1KS5tYXAoKGkpID0+IHBhcnNlSW50KGksIDEwKSlcbiAgY29uc3QgY29tcFJhdyA9IC9HSEMgKC4rKSQvLmV4ZWMoc3Rkb3V0LnRyaW0oKSlcbiAgaWYgKCFjb21wUmF3KSB7IHRocm93IG5ldyBFcnJvcihcIkNvdWxkbid0IGdldCBnaGMgdmVyc2lvblwiKSB9XG4gIGNvbnN0IGNvbXAgPSBjb21wUmF3WzFdXG4gIFV0aWwuZGVidWcoYEdoYy1tb2QgJHt2ZXJzfSBidWlsdCB3aXRoICR7Y29tcH1gKVxuICByZXR1cm4geyB2ZXJzLCBjb21wIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tDb21wKG9wdHM6IFV0aWwuRXhlY09wdHMsIHZlcnNQOiBQcm9taXNlPEdIQ01vZFZlcnM+LCBidWlsZGVyOiBzdHJpbmcgfCB1bmRlZmluZWQpIHtcbiAgY29uc3QgeyBjb21wIH0gPSBhd2FpdCB2ZXJzUFxuICBjb25zdCB0aW1lb3V0ID0gYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QuaW5pdFRpbWVvdXQnKSAqIDEwMDBcbiAgY29uc3QgdHJ5V2FybiA9IGFzeW5jIChjbWQ6IHN0cmluZywgYXJnczogc3RyaW5nW10pID0+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIChhd2FpdCBVdGlsLmV4ZWNQcm9taXNlKGNtZCwgYXJncywgeyB0aW1lb3V0LCAuLi5vcHRzIH0pKS5zdGRvdXQudHJpbSgpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIFV0aWwud2FybihlcnJvcilcbiAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9XG4gIH1cbiAgY29uc3QgW3N0YWNrZ2hjLCBwYXRoZ2hjXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICB0cnlXYXJuKCdzdGFjaycsIFsnZ2hjJywgJy0tJywgJy0tbnVtZXJpYy12ZXJzaW9uJ10pLFxuICAgIHRyeVdhcm4oJ2doYycsIFsnLS1udW1lcmljLXZlcnNpb24nXSksXG4gIF0pXG4gIFV0aWwuZGVidWcoYFN0YWNrIEdIQyB2ZXJzaW9uICR7c3RhY2tnaGN9YClcbiAgVXRpbC5kZWJ1ZyhgUGF0aCBHSEMgdmVyc2lvbiAke3BhdGhnaGN9YClcbiAgY29uc3Qgd2FyblN0YWNrID0gWydzdGFjaycsIHVuZGVmaW5lZF0uaW5jbHVkZXMoYnVpbGRlcilcbiAgY29uc3Qgd2FybkNhYmFsID0gWydjYWJhbCcsICdub25lJywgdW5kZWZpbmVkXS5pbmNsdWRlcyhidWlsZGVyKVxuICBpZiAoc3RhY2tnaGMgJiYgKHN0YWNrZ2hjICE9PSBjb21wKSAmJiB3YXJuU3RhY2spIHtcbiAgICBjb25zdCB3YXJuID0gYFxcXG5HSEMgdmVyc2lvbiBpbiB5b3VyIFN0YWNrICcke3N0YWNrZ2hjfScgZG9lc24ndCBtYXRjaCB3aXRoIFxcXG5HSEMgdmVyc2lvbiB1c2VkIHRvIGJ1aWxkIGdoYy1tb2QgJyR7Y29tcH0nLiBUaGlzIGNhbiBsZWFkIHRvIFxcXG5wcm9ibGVtcyB3aGVuIHVzaW5nIFN0YWNrIHByb2plY3RzYFxuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKHdhcm4sIHtcbiAgICAgIGRpc21pc3NhYmxlOiBidWlsZGVyICE9PSB1bmRlZmluZWQsXG4gICAgfSlcbiAgICBVdGlsLndhcm4od2FybilcbiAgfVxuICBpZiAocGF0aGdoYyAmJiAocGF0aGdoYyAhPT0gY29tcCkgJiYgd2FybkNhYmFsKSB7XG4gICAgY29uc3Qgd2FybiA9IGBcXFxuR0hDIHZlcnNpb24gaW4geW91ciBQQVRIICcke3BhdGhnaGN9JyBkb2Vzbid0IG1hdGNoIHdpdGggXFxcbkdIQyB2ZXJzaW9uIHVzZWQgdG8gYnVpbGQgZ2hjLW1vZCAnJHtjb21wfScuIFRoaXMgY2FuIGxlYWQgdG8gXFxcbnByb2JsZW1zIHdoZW4gdXNpbmcgQ2FiYWwgb3IgUGxhaW4gcHJvamVjdHNgXG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcod2Fybiwge1xuICAgICAgZGlzbWlzc2FibGU6IGJ1aWxkZXIgIT09IHVuZGVmaW5lZCxcbiAgICB9KVxuICAgIFV0aWwud2Fybih3YXJuKVxuICB9XG59XG4iXX0=