"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const FZ = require("fuzzaldrin");
const atom_1 = require("atom");
const buffer_info_1 = require("./buffer-info");
const module_info_1 = require("./module-info");
const Util = require("../util");
const { handleException } = Util;
class CompletionBackend {
    constructor(process, upi) {
        this.process = process;
        this.upi = upi;
        this.bufferMap = new WeakMap();
        this.dirMap = new WeakMap();
        this.modListMap = new WeakMap();
        this.languagePragmas = new WeakMap();
        this.compilerOptions = new WeakMap();
        this.name = this.name.bind(this);
        this.onDidDestroy = this.onDidDestroy.bind(this);
        this.registerCompletionBuffer = this.registerCompletionBuffer.bind(this);
        this.unregisterCompletionBuffer = this.unregisterCompletionBuffer.bind(this);
        this.getCompletionsForSymbol = this.getCompletionsForSymbol.bind(this);
        this.getCompletionsForType = this.getCompletionsForType.bind(this);
        this.getCompletionsForClass = this.getCompletionsForClass.bind(this);
        this.getCompletionsForModule = this.getCompletionsForModule.bind(this);
        this.getCompletionsForSymbolInModule = this.getCompletionsForSymbolInModule.bind(this);
        this.getCompletionsForLanguagePragmas = this.getCompletionsForLanguagePragmas.bind(this);
        this.getCompletionsForCompilerOptions = this.getCompletionsForCompilerOptions.bind(this);
        this.getCompletionsForHole = this.getCompletionsForHole.bind(this);
        this.process = process;
        this.isActive = true;
        this.process.onDidDestroy(() => {
            this.isActive = false;
        });
    }
    name() {
        return 'haskell-ghc-mod';
    }
    onDidDestroy(callback) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        return this.process.onDidDestroy(callback);
    }
    registerCompletionBuffer(buffer) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        if (this.bufferMap.has(buffer)) {
            return new atom_1.Disposable(() => {
            });
        }
        const { bufferInfo } = this.getBufferInfo({ buffer });
        setImmediate(async () => {
            const { rootDir, moduleMap } = await this.getModuleMap({ bufferInfo });
            this.getModuleInfo({ bufferInfo, rootDir, moduleMap });
            const imports = await bufferInfo.getImports();
            for (const imprt of imports) {
                this.getModuleInfo({
                    moduleName: imprt.name,
                    bufferInfo,
                    rootDir,
                    moduleMap,
                });
            }
        });
        return new atom_1.Disposable(() => this.unregisterCompletionBuffer(buffer));
    }
    unregisterCompletionBuffer(buffer) {
        const x = this.bufferMap.get(buffer);
        if (x) {
            x.destroy();
        }
    }
    async getCompletionsForSymbol(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getSymbolsForBuffer(buffer);
        return this.filter(symbols, prefix, ['qname', 'qparent']);
    }
    async getCompletionsForType(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getSymbolsForBuffer(buffer, ['type', 'class']);
        return FZ.filter(symbols, prefix, { key: 'qname' });
    }
    async getCompletionsForClass(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const symbols = await this.getSymbolsForBuffer(buffer, ['class']);
        return FZ.filter(symbols, prefix, { key: 'qname' });
    }
    async getCompletionsForModule(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const rootDir = await this.process.getRootDir(buffer);
        let modules = this.modListMap.get(rootDir);
        if (!modules) {
            modules = await this.process.runList(buffer);
            this.modListMap.set(rootDir, modules);
            setTimeout(() => this.modListMap.delete(rootDir), 60 * 1000);
        }
        return FZ.filter(modules, prefix);
    }
    async getCompletionsForSymbolInModule(buffer, prefix, position, opts) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        let moduleName = opts ? opts.module : undefined;
        if (!moduleName) {
            const lineRange = new atom_1.Range([0, position.row], position);
            buffer.backwardsScanInRange(/^import\s+([\w.]+)/, lineRange, ({ match }) => (moduleName = match[1]));
        }
        const { bufferInfo } = this.getBufferInfo({ buffer });
        const mis = await this.getModuleInfo({ bufferInfo, moduleName });
        const symbols = await mis.moduleInfo.select({
            qualified: false,
            hiding: false,
            name: moduleName || mis.moduleName,
            importList: null,
            alias: null,
        }, undefined, true);
        return FZ.filter(symbols, prefix, { key: 'name' });
    }
    async getCompletionsForLanguagePragmas(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const dir = await this.process.getRootDir(buffer);
        let ps = this.languagePragmas.get(dir);
        if (!ps) {
            ps = await this.process.runLang(dir);
            ps && this.languagePragmas.set(dir, ps);
        }
        return FZ.filter(ps, prefix);
    }
    async getCompletionsForCompilerOptions(buffer, prefix, _position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const dir = await this.process.getRootDir(buffer);
        let co = this.compilerOptions.get(dir);
        if (!co) {
            co = await this.process.runFlag(dir);
            this.compilerOptions.set(dir, co);
        }
        return FZ.filter(co, prefix);
    }
    async getCompletionsForHole(buffer, prefix, position) {
        if (!this.isActive) {
            throw new Error('Backend inactive');
        }
        const range = new atom_1.Range(position, position);
        if (prefix.startsWith('_')) {
            prefix = prefix.slice(1);
        }
        const { type } = await this.process.getTypeInBuffer(buffer, range);
        const symbols = await this.getSymbolsForBuffer(buffer);
        const ts = symbols.filter((s) => {
            if (!s.typeSignature) {
                return false;
            }
            const tl = s.typeSignature.split(' -> ').slice(-1)[0];
            if (tl.match(/^[a-z]$/)) {
                return false;
            }
            const ts2 = tl.replace(/[.?*+^$[\]\\(){}|-]/g, '\\$&');
            const rx = RegExp(ts2.replace(/\b[a-z]\b/g, '.+'), '');
            return rx.test(type);
        });
        if (prefix.length === 0) {
            return ts.sort((a, b) => FZ.score(b.typeSignature, type) - FZ.score(a.typeSignature, type));
        }
        else {
            return FZ.filter(ts, prefix, { key: 'qname' });
        }
    }
    async getSymbolsForBuffer(buffer, symbolTypes) {
        const { bufferInfo } = this.getBufferInfo({ buffer });
        const { rootDir, moduleMap } = await this.getModuleMap({ bufferInfo });
        if (bufferInfo && moduleMap) {
            const imports = await bufferInfo.getImports();
            const promises = await Promise.all(imports.map(async (imp) => {
                const res = await this.getModuleInfo({
                    bufferInfo,
                    moduleName: imp.name,
                    rootDir,
                    moduleMap,
                });
                if (!res) {
                    return [];
                }
                return res.moduleInfo.select(imp, symbolTypes);
            }));
            return [].concat(...promises);
        }
        else {
            return [];
        }
    }
    getBufferInfo({ buffer, }) {
        let bi = this.bufferMap.get(buffer);
        if (!bi) {
            bi = new buffer_info_1.BufferInfo(buffer);
            this.bufferMap.set(buffer, bi);
        }
        return { bufferInfo: bi };
    }
    async getModuleMap({ bufferInfo, rootDir, }) {
        if (!rootDir) {
            rootDir = await this.process.getRootDir(bufferInfo.buffer);
        }
        let mm = this.dirMap.get(rootDir);
        if (!mm) {
            mm = new Map();
            this.dirMap.set(rootDir, mm);
        }
        return {
            rootDir,
            moduleMap: mm,
        };
    }
    async getModuleInfo(arg) {
        const { bufferInfo } = arg;
        let dat;
        if (arg.rootDir && arg.moduleMap) {
            dat = { rootDir: arg.rootDir, moduleMap: arg.moduleMap };
        }
        else {
            dat = await this.getModuleMap({ bufferInfo });
        }
        const { moduleMap, rootDir } = dat;
        let moduleName = arg.moduleName;
        if (!moduleName) {
            moduleName = await bufferInfo.getModuleName();
        }
        if (!moduleName) {
            throw new Error(`Nameless module in ${bufferInfo.buffer.getUri()}`);
        }
        let moduleInfo = moduleMap.get(moduleName);
        if (!moduleInfo) {
            moduleInfo = new module_info_1.ModuleInfo(moduleName, this.process, rootDir);
            moduleMap.set(moduleName, moduleInfo);
            const mn = moduleName;
            moduleInfo.onDidDestroy(() => {
                moduleMap.delete(mn);
                Util.debug(`${moduleName} removed from map`);
            });
        }
        await moduleInfo.setBuffer(bufferInfo);
        return { bufferInfo, rootDir, moduleMap, moduleInfo, moduleName };
    }
    filter(candidates, prefix, keys) {
        if (!prefix) {
            return candidates;
        }
        const list = [];
        for (const candidate of candidates) {
            const scores = keys.map((key) => {
                const ck = candidate[key];
                if (ck) {
                    return FZ.score(ck.toString(), prefix);
                }
                else {
                    return 0;
                }
            });
            const score = Math.max(...scores);
            if (score > 0) {
                list.push({
                    score,
                    scoreN: scores.indexOf(score),
                    data: candidate,
                });
            }
        }
        return list
            .sort((a, b) => {
            const s = b.score - a.score;
            if (s === 0) {
                return a.scoreN - b.scoreN;
            }
            return s;
        })
            .map(({ data }) => data);
    }
}
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [atom_1.TextBuffer, String, atom_1.Point]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForSymbol", null);
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [atom_1.TextBuffer, String, atom_1.Point]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForType", null);
tslib_1.__decorate([
    handleException,
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [atom_1.TextBuffer, String, atom_1.Point]),
    tslib_1.__metadata("design:returntype", Promise)
], CompletionBackend.prototype, "getCompletionsForHole", null);
exports.CompletionBackend = CompletionBackend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tcGxldGlvbi1iYWNrZW5kL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUFnQztBQUNoQywrQkFBc0U7QUFDdEUsK0NBQTBDO0FBQzFDLCtDQUEwQztBQUUxQyxnQ0FBK0I7QUFJL0IsTUFBTSxFQUFFLGVBQWUsRUFBRSxHQUFHLElBQUksQ0FBQTtBQUVoQztJQVFFLFlBQ1UsT0FBdUIsRUFDeEIsR0FBOEI7UUFEN0IsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFDeEIsUUFBRyxHQUFILEdBQUcsQ0FBMkI7UUFFckMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBQzlCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUMzQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFDL0IsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBQ3BDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUdwQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2hDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDaEQsSUFBSSxDQUFDLHdCQUF3QixHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDeEUsSUFBSSxDQUFDLDBCQUEwQixHQUFHLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUUsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMs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LEdBQUcsTUFBTSxDQUFDLENBQUE7WUFDakMsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQztvQkFDUixLQUFLO29CQUNMLE1BQU0sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztvQkFDN0IsSUFBSSxFQUFFLFNBQVM7aUJBQ2hCLENBQUMsQ0FBQTtZQUNKLENBQUM7UUFDSCxDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQUk7YUFDUixJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDYixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUE7WUFDM0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ1osTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtZQUM1QixDQUFDO1lBQ0QsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUNWLENBQUMsQ0FBQzthQUNELEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzVCLENBQUM7Q0FDRjtBQWpZQztJQURDLGVBQWU7OzZDQUVOLGlCQUFVLFVBRVAsWUFBSzs7Z0VBUWpCO0FBYUQ7SUFEQyxlQUFlOzs2Q0FFTixpQkFBVSxVQUVQLFlBQUs7OzhEQVFqQjtBQWdMRDtJQURDLGVBQWU7OzZDQUVOLGlCQUFVLFVBRVIsWUFBSzs7OERBZ0NoQjtBQXZZSCw4Q0FraEJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgRlogZnJvbSAnZnV6emFsZHJpbidcbmltcG9ydCB7IFRleHRCdWZmZXIsIFBvaW50LCBEaXNwb3NhYmxlLCBSYW5nZSwgRGlyZWN0b3J5IH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IEJ1ZmZlckluZm8gfSBmcm9tICcuL2J1ZmZlci1pbmZvJ1xuaW1wb3J0IHsgTW9kdWxlSW5mbyB9IGZyb20gJy4vbW9kdWxlLWluZm8nXG5pbXBvcnQgeyBHaGNNb2RpUHJvY2VzcyB9IGZyb20gJy4uL2doYy1tb2QnXG5pbXBvcnQgKiBhcyBVdGlsIGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmltcG9ydCAqIGFzIENCIGZyb20gJ2F0b20taGFza2VsbC11cGkvY29tcGxldGlvbi1iYWNrZW5kJ1xuXG5jb25zdCB7IGhhbmRsZUV4Y2VwdGlvbiB9ID0gVXRpbFxuXG5leHBvcnQgY2xhc3MgQ29tcGxldGlvbkJhY2tlbmQgaW1wbGVtZW50cyBDQi5JQ29tcGxldGlvbkJhY2tlbmQge1xuICBwcml2YXRlIGJ1ZmZlck1hcDogV2Vha01hcDxUZXh0QnVmZmVyLCBCdWZmZXJJbmZvPlxuICBwcml2YXRlIGRpck1hcDogV2Vha01hcDxEaXJlY3RvcnksIE1hcDxzdHJpbmcsIE1vZHVsZUluZm8+PlxuICBwcml2YXRlIG1vZExpc3RNYXA6IFdlYWtNYXA8RGlyZWN0b3J5LCBzdHJpbmdbXT5cbiAgcHJpdmF0ZSBsYW5ndWFnZVByYWdtYXM6IFdlYWtNYXA8RGlyZWN0b3J5LCBzdHJpbmdbXT5cbiAgcHJpdmF0ZSBjb21waWxlck9wdGlvbnM6IFdlYWtNYXA8RGlyZWN0b3J5LCBzdHJpbmdbXT5cbiAgcHJpdmF0ZSBpc0FjdGl2ZTogYm9vbGVhblxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcHJvY2VzczogR2hjTW9kaVByb2Nlc3MsXG4gICAgcHVibGljIHVwaTogUHJvbWlzZTxVUEkuSVVQSUluc3RhbmNlPixcbiAgKSB7XG4gICAgdGhpcy5idWZmZXJNYXAgPSBuZXcgV2Vha01hcCgpXG4gICAgdGhpcy5kaXJNYXAgPSBuZXcgV2Vha01hcCgpXG4gICAgdGhpcy5tb2RMaXN0TWFwID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMubGFuZ3VhZ2VQcmFnbWFzID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMuY29tcGlsZXJPcHRpb25zID0gbmV3IFdlYWtNYXAoKVxuXG4gICAgLy8gY29tcGF0aWJpbGl0eSB3aXRoIG9sZCBjbGllbnRzXG4gICAgdGhpcy5uYW1lID0gdGhpcy5uYW1lLmJpbmQodGhpcylcbiAgICB0aGlzLm9uRGlkRGVzdHJveSA9IHRoaXMub25EaWREZXN0cm95LmJpbmQodGhpcylcbiAgICB0aGlzLnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlciA9IHRoaXMucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyLmJpbmQodGhpcylcbiAgICB0aGlzLnVucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyID0gdGhpcy51bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlci5iaW5kKHRoaXMpXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0ZvclN5bWJvbCA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2wuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JUeXBlID0gdGhpcy5nZXRDb21wbGV0aW9uc0ZvclR5cGUuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDbGFzcyA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDbGFzcy5iaW5kKHRoaXMpXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0Zvck1vZHVsZSA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JNb2R1bGUuYmluZCh0aGlzKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZSA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZS5iaW5kKFxuICAgICAgdGhpcyxcbiAgICApXG4gICAgdGhpcy5nZXRDb21wbGV0aW9uc0Zvckxhbmd1YWdlUHJhZ21hcyA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JMYW5ndWFnZVByYWdtYXMuYmluZChcbiAgICAgIHRoaXMsXG4gICAgKVxuICAgIHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JDb21waWxlck9wdGlvbnMgPSB0aGlzLmdldENvbXBsZXRpb25zRm9yQ29tcGlsZXJPcHRpb25zLmJpbmQoXG4gICAgICB0aGlzLFxuICAgIClcbiAgICB0aGlzLmdldENvbXBsZXRpb25zRm9ySG9sZSA9IHRoaXMuZ2V0Q29tcGxldGlvbnNGb3JIb2xlLmJpbmQodGhpcylcblxuICAgIHRoaXMucHJvY2VzcyA9IHByb2Nlc3NcbiAgICB0aGlzLmlzQWN0aXZlID0gdHJ1ZVxuICAgIHRoaXMucHJvY2Vzcy5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgdGhpcy5pc0FjdGl2ZSA9IGZhbHNlXG4gICAgfSlcbiAgfVxuXG4gIC8qIFB1YmxpYyBpbnRlcmZhY2UgYmVsb3cgKi9cblxuICAvKlxuICBuYW1lKClcbiAgR2V0IGJhY2tlbmQgbmFtZVxuXG4gIFJldHVybnMgU3RyaW5nLCB1bmlxdWUgc3RyaW5nIGRlc2NyaWJpbmcgYSBnaXZlbiBiYWNrZW5kXG4gICovXG4gIHB1YmxpYyBuYW1lKCkge1xuICAgIHJldHVybiAnaGFza2VsbC1naGMtbW9kJ1xuICB9XG5cbiAgLypcbiAgb25EaWREZXN0cm95KGNhbGxiYWNrKVxuICBEZXN0cnVjdGlvbiBldmVudCBzdWJzY3JpcHRpb24uIFVzdWFsbHkgc2hvdWxkIGJlIGNhbGxlZCBvbmx5IG9uXG4gIHBhY2thZ2UgZGVhY3RpdmF0aW9uLlxuICBjYWxsYmFjazogKCkgLT5cbiAgKi9cbiAgcHVibGljIG9uRGlkRGVzdHJveShjYWxsYmFjazogKCkgPT4gdm9pZCkge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJylcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJvY2Vzcy5vbkRpZERlc3Ryb3koY2FsbGJhY2spXG4gIH1cblxuICAvKlxuICByZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyKVxuICBFdmVyeSBidWZmZXIgdGhhdCB3b3VsZCBiZSB1c2VkIHdpdGggYXV0b2NvbXBsZXRpb24gZnVuY3Rpb25zIGhhcyB0b1xuICBiZSByZWdpc3RlcmVkIHdpdGggdGhpcyBmdW5jdGlvbi5cblxuICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0byBiZSB1c2VkIGluIGF1dG9jb21wbGV0aW9uXG5cbiAgUmV0dXJuczogRGlzcG9zYWJsZSwgd2hpY2ggd2lsbCByZW1vdmUgYnVmZmVyIGZyb20gYXV0b2NvbXBsZXRpb25cbiAgKi9cbiAgcHVibGljIHJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlcihidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpXG4gICAgfVxuXG4gICAgaWYgKHRoaXMuYnVmZmVyTWFwLmhhcyhidWZmZXIpKSB7XG4gICAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgICAvKiB2b2lkICovXG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbnN0IHsgYnVmZmVySW5mbyB9ID0gdGhpcy5nZXRCdWZmZXJJbmZvKHsgYnVmZmVyIH0pXG5cbiAgICBzZXRJbW1lZGlhdGUoYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgeyByb290RGlyLCBtb2R1bGVNYXAgfSA9IGF3YWl0IHRoaXMuZ2V0TW9kdWxlTWFwKHsgYnVmZmVySW5mbyB9KVxuXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgIHRoaXMuZ2V0TW9kdWxlSW5mbyh7IGJ1ZmZlckluZm8sIHJvb3REaXIsIG1vZHVsZU1hcCB9KVxuXG4gICAgICBjb25zdCBpbXBvcnRzID0gYXdhaXQgYnVmZmVySW5mby5nZXRJbXBvcnRzKClcbiAgICAgIGZvciAoY29uc3QgaW1wcnQgb2YgaW1wb3J0cykge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgdGhpcy5nZXRNb2R1bGVJbmZvKHtcbiAgICAgICAgICBtb2R1bGVOYW1lOiBpbXBydC5uYW1lLFxuICAgICAgICAgIGJ1ZmZlckluZm8sXG4gICAgICAgICAgcm9vdERpcixcbiAgICAgICAgICBtb2R1bGVNYXAsXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcblxuICAgIHJldHVybiBuZXcgRGlzcG9zYWJsZSgoKSA9PiB0aGlzLnVucmVnaXN0ZXJDb21wbGV0aW9uQnVmZmVyKGJ1ZmZlcikpXG4gIH1cblxuICAvKlxuICB1bnJlZ2lzdGVyQ29tcGxldGlvbkJ1ZmZlcihidWZmZXIpXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRvIGJlIHJlbW92ZWQgZnJvbSBhdXRvY29tcGxldGlvblxuICAqL1xuICBwdWJsaWMgdW5yZWdpc3RlckNvbXBsZXRpb25CdWZmZXIoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgY29uc3QgeCA9IHRoaXMuYnVmZmVyTWFwLmdldChidWZmZXIpXG4gICAgaWYgKHgpIHtcbiAgICAgIHguZGVzdHJveSgpXG4gICAgfVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2woYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXG4gIHN5bWJvbDogT2JqZWN0LCBhIGNvbXBsZXRpb24gc3ltYm9sXG4gICAgbmFtZTogU3RyaW5nLCBzeW1ib2wgbmFtZVxuICAgIHFuYW1lOiBTdHJpbmcsIHF1YWxpZmllZCBuYW1lLCBpZiBtb2R1bGUgaXMgcXVhbGlmaWVkLlxuICAgICAgICAgICBPdGhlcndpc2UsIHNhbWUgYXMgbmFtZVxuICAgIHR5cGVTaWduYXR1cmU6IFN0cmluZywgdHlwZSBzaWduYXR1cmVcbiAgICBzeW1ib2xUeXBlOiBTdHJpbmcsIG9uZSBvZiBbJ3R5cGUnLCAnY2xhc3MnLCAnZnVuY3Rpb24nXVxuICAgIG1vZHVsZTogT2JqZWN0LCBzeW1ib2wgbW9kdWxlIGluZm9ybWF0aW9uXG4gICAgICBxdWFsaWZpZWQ6IEJvb2xlYW4sIHRydWUgaWYgbW9kdWxlIGlzIGltcG9ydGVkIGFzIHF1YWxpZmllZFxuICAgICAgbmFtZTogU3RyaW5nLCBtb2R1bGUgbmFtZVxuICAgICAgYWxpYXM6IFN0cmluZywgbW9kdWxlIGFsaWFzXG4gICAgICBoaWRpbmc6IEJvb2xlYW4sIHRydWUgaWYgbW9kdWxlIGlzIGltcG9ydGVkIHdpdGggaGlkaW5nIGNsYXVzZVxuICAgICAgaW1wb3J0TGlzdDogW1N0cmluZ10sIGFycmF5IG9mIGV4cGxpY2l0IGltcG9ydHMvaGlkZGVuIGltcG9ydHNcbiAgKi9cbiAgQGhhbmRsZUV4Y2VwdGlvblxuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2woXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLFxuICAgIHByZWZpeDogc3RyaW5nLFxuICAgIF9wb3NpdGlvbjogUG9pbnQsXG4gICk6IFByb21pc2U8Q0IuSVN5bWJvbFtdPiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKVxuICAgIH1cblxuICAgIGNvbnN0IHN5bWJvbHMgPSBhd2FpdCB0aGlzLmdldFN5bWJvbHNGb3JCdWZmZXIoYnVmZmVyKVxuICAgIHJldHVybiB0aGlzLmZpbHRlcihzeW1ib2xzLCBwcmVmaXgsIFsncW5hbWUnLCAncXBhcmVudCddKVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JUeXBlKGJ1ZmZlcixwcmVmaXgscG9zaXRpb24pXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cblxuICBSZXR1cm5zOiBQcm9taXNlKFtzeW1ib2xdKVxuICBzeW1ib2w6IFNhbWUgYXMgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2wsIGV4Y2VwdFxuICAgICAgICAgIHN5bWJvbFR5cGUgaXMgb25lIG9mIFsndHlwZScsICdjbGFzcyddXG4gICovXG4gIEBoYW5kbGVFeGNlcHRpb25cbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yVHlwZShcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsXG4gICAgcHJlZml4OiBzdHJpbmcsXG4gICAgX3Bvc2l0aW9uOiBQb2ludCxcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpXG4gICAgfVxuXG4gICAgY29uc3Qgc3ltYm9scyA9IGF3YWl0IHRoaXMuZ2V0U3ltYm9sc0ZvckJ1ZmZlcihidWZmZXIsIFsndHlwZScsICdjbGFzcyddKVxuICAgIHJldHVybiBGWi5maWx0ZXIoc3ltYm9scywgcHJlZml4LCB7IGtleTogJ3FuYW1lJyB9KVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JDbGFzcyhidWZmZXIscHJlZml4LHBvc2l0aW9uKVxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXG5cbiAgUmV0dXJuczogUHJvbWlzZShbc3ltYm9sXSlcbiAgc3ltYm9sOiBTYW1lIGFzIGdldENvbXBsZXRpb25zRm9yU3ltYm9sLCBleGNlcHRcbiAgICAgICAgICBzeW1ib2xUeXBlIGlzIG9uZSBvZiBbJ2NsYXNzJ11cbiAgKi9cbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yQ2xhc3MoXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLFxuICAgIHByZWZpeDogc3RyaW5nLFxuICAgIF9wb3NpdGlvbjogUG9pbnQsXG4gICk6IFByb21pc2U8Q0IuSVN5bWJvbFtdPiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKVxuICAgIH1cblxuICAgIGNvbnN0IHN5bWJvbHMgPSBhd2FpdCB0aGlzLmdldFN5bWJvbHNGb3JCdWZmZXIoYnVmZmVyLCBbJ2NsYXNzJ10pXG4gICAgcmV0dXJuIEZaLmZpbHRlcihzeW1ib2xzLCBwcmVmaXgsIHsga2V5OiAncW5hbWUnIH0pXG4gIH1cblxuICAvKlxuICBnZXRDb21wbGV0aW9uc0Zvck1vZHVsZShidWZmZXIscHJlZml4LHBvc2l0aW9uKVxuICBidWZmZXI6IFRleHRCdWZmZXIsIGN1cnJlbnQgYnVmZmVyXG4gIHByZWZpeDogU3RyaW5nLCBjb21wbGV0aW9uIHByZWZpeFxuICBwb3NpdGlvbjogUG9pbnQsIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uXG5cbiAgUmV0dXJuczogUHJvbWlzZShbbW9kdWxlXSlcbiAgbW9kdWxlOiBTdHJpbmcsIG1vZHVsZSBuYW1lXG4gICovXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0Zvck1vZHVsZShcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsXG4gICAgcHJlZml4OiBzdHJpbmcsXG4gICAgX3Bvc2l0aW9uOiBQb2ludCxcbiAgKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJylcbiAgICB9XG4gICAgY29uc3Qgcm9vdERpciA9IGF3YWl0IHRoaXMucHJvY2Vzcy5nZXRSb290RGlyKGJ1ZmZlcilcbiAgICBsZXQgbW9kdWxlcyA9IHRoaXMubW9kTGlzdE1hcC5nZXQocm9vdERpcilcbiAgICBpZiAoIW1vZHVsZXMpIHtcbiAgICAgIG1vZHVsZXMgPSBhd2FpdCB0aGlzLnByb2Nlc3MucnVuTGlzdChidWZmZXIpXG4gICAgICB0aGlzLm1vZExpc3RNYXAuc2V0KHJvb3REaXIsIG1vZHVsZXMpXG4gICAgICAvLyByZWZyZXNoIGV2ZXJ5IG1pbnV0ZVxuICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLm1vZExpc3RNYXAuZGVsZXRlKHJvb3REaXIpLCA2MCAqIDEwMDApXG4gICAgfVxuICAgIHJldHVybiBGWi5maWx0ZXIobW9kdWxlcywgcHJlZml4KVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZShidWZmZXIscHJlZml4LHBvc2l0aW9uLHttb2R1bGV9KVxuICBVc2VkIGluIGltcG9ydCBoaWRpbmcvbGlzdCBjb21wbGV0aW9uc1xuXG4gIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgY3VycmVudCBidWZmZXJcbiAgcHJlZml4OiBTdHJpbmcsIGNvbXBsZXRpb24gcHJlZml4XG4gIHBvc2l0aW9uOiBQb2ludCwgY3VycmVudCBjdXJzb3IgcG9zaXRpb25cbiAgbW9kdWxlOiBTdHJpbmcsIG1vZHVsZSBuYW1lIChvcHRpb25hbCkuIElmIHVuZGVmaW5lZCwgZnVuY3Rpb25cbiAgICAgICAgICB3aWxsIGF0dGVtcHQgdG8gaW5mZXIgbW9kdWxlIG5hbWUgZnJvbSBwb3NpdGlvbiBhbmQgYnVmZmVyLlxuXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXG4gIHN5bWJvbDogT2JqZWN0LCBzeW1ib2wgaW4gZ2l2ZW4gbW9kdWxlXG4gICAgbmFtZTogU3RyaW5nLCBzeW1ib2wgbmFtZVxuICAgIHR5cGVTaWduYXR1cmU6IFN0cmluZywgdHlwZSBzaWduYXR1cmVcbiAgICBzeW1ib2xUeXBlOiBTdHJpbmcsIG9uZSBvZiBbJ3R5cGUnLCAnY2xhc3MnLCAnZnVuY3Rpb24nXVxuICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0Q29tcGxldGlvbnNGb3JTeW1ib2xJbk1vZHVsZShcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsXG4gICAgcHJlZml4OiBzdHJpbmcsXG4gICAgcG9zaXRpb246IFBvaW50LFxuICAgIG9wdHM/OiB7IG1vZHVsZTogc3RyaW5nIH0sXG4gICk6IFByb21pc2U8Q0IuSVN5bWJvbFtdPiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKVxuICAgIH1cbiAgICBsZXQgbW9kdWxlTmFtZSA9IG9wdHMgPyBvcHRzLm1vZHVsZSA6IHVuZGVmaW5lZFxuICAgIGlmICghbW9kdWxlTmFtZSkge1xuICAgICAgY29uc3QgbGluZVJhbmdlID0gbmV3IFJhbmdlKFswLCBwb3NpdGlvbi5yb3ddLCBwb3NpdGlvbilcbiAgICAgIGJ1ZmZlci5iYWNrd2FyZHNTY2FuSW5SYW5nZShcbiAgICAgICAgL15pbXBvcnRcXHMrKFtcXHcuXSspLyxcbiAgICAgICAgbGluZVJhbmdlLFxuICAgICAgICAoeyBtYXRjaCB9KSA9PiAobW9kdWxlTmFtZSA9IG1hdGNoWzFdKSxcbiAgICAgIClcbiAgICB9XG5cbiAgICBjb25zdCB7IGJ1ZmZlckluZm8gfSA9IHRoaXMuZ2V0QnVmZmVySW5mbyh7IGJ1ZmZlciB9KVxuICAgIGNvbnN0IG1pcyA9IGF3YWl0IHRoaXMuZ2V0TW9kdWxlSW5mbyh7IGJ1ZmZlckluZm8sIG1vZHVsZU5hbWUgfSlcblxuICAgIC8vIHRzbGludDpkaXNhYmxlOiBuby1udWxsLWtleXdvcmRcbiAgICBjb25zdCBzeW1ib2xzID0gYXdhaXQgbWlzLm1vZHVsZUluZm8uc2VsZWN0KFxuICAgICAge1xuICAgICAgICBxdWFsaWZpZWQ6IGZhbHNlLFxuICAgICAgICBoaWRpbmc6IGZhbHNlLFxuICAgICAgICBuYW1lOiBtb2R1bGVOYW1lIHx8IG1pcy5tb2R1bGVOYW1lLFxuICAgICAgICBpbXBvcnRMaXN0OiBudWxsLFxuICAgICAgICBhbGlhczogbnVsbCxcbiAgICAgIH0sXG4gICAgICB1bmRlZmluZWQsXG4gICAgICB0cnVlLFxuICAgIClcbiAgICAvLyB0c2xpbnQ6ZW5hYmxlOiBuby1udWxsLWtleXdvcmRcbiAgICByZXR1cm4gRlouZmlsdGVyKHN5bWJvbHMsIHByZWZpeCwgeyBrZXk6ICduYW1lJyB9KVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JMYW5ndWFnZVByYWdtYXMoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuXG4gIFJldHVybnM6IFByb21pc2UoW3ByYWdtYV0pXG4gIHByYWdtYTogU3RyaW5nLCBsYW5ndWFnZSBvcHRpb25cbiAgKi9cbiAgcHVibGljIGFzeW5jIGdldENvbXBsZXRpb25zRm9yTGFuZ3VhZ2VQcmFnbWFzKFxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlcixcbiAgICBwcmVmaXg6IHN0cmluZyxcbiAgICBfcG9zaXRpb246IFBvaW50LFxuICApOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhY2tlbmQgaW5hY3RpdmUnKVxuICAgIH1cblxuICAgIGNvbnN0IGRpciA9IGF3YWl0IHRoaXMucHJvY2Vzcy5nZXRSb290RGlyKGJ1ZmZlcilcblxuICAgIGxldCBwcyA9IHRoaXMubGFuZ3VhZ2VQcmFnbWFzLmdldChkaXIpXG4gICAgaWYgKCFwcykge1xuICAgICAgcHMgPSBhd2FpdCB0aGlzLnByb2Nlc3MucnVuTGFuZyhkaXIpXG4gICAgICBwcyAmJiB0aGlzLmxhbmd1YWdlUHJhZ21hcy5zZXQoZGlyLCBwcylcbiAgICB9XG4gICAgcmV0dXJuIEZaLmZpbHRlcihwcywgcHJlZml4KVxuICB9XG5cbiAgLypcbiAgZ2V0Q29tcGxldGlvbnNGb3JDb21waWxlck9wdGlvbnMoYnVmZmVyLHByZWZpeCxwb3NpdGlvbilcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuXG4gIFJldHVybnM6IFByb21pc2UoW2doY29wdF0pXG4gIGdoY29wdDogU3RyaW5nLCBjb21waWxlciBvcHRpb24gKHN0YXJ0cyB3aXRoICctZicpXG4gICovXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0ZvckNvbXBpbGVyT3B0aW9ucyhcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsXG4gICAgcHJlZml4OiBzdHJpbmcsXG4gICAgX3Bvc2l0aW9uOiBQb2ludCxcbiAgKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdCYWNrZW5kIGluYWN0aXZlJylcbiAgICB9XG5cbiAgICBjb25zdCBkaXIgPSBhd2FpdCB0aGlzLnByb2Nlc3MuZ2V0Um9vdERpcihidWZmZXIpXG5cbiAgICBsZXQgY28gPSB0aGlzLmNvbXBpbGVyT3B0aW9ucy5nZXQoZGlyKVxuICAgIGlmICghY28pIHtcbiAgICAgIGNvID0gYXdhaXQgdGhpcy5wcm9jZXNzLnJ1bkZsYWcoZGlyKVxuICAgICAgdGhpcy5jb21waWxlck9wdGlvbnMuc2V0KGRpciwgY28pXG4gICAgfVxuICAgIHJldHVybiBGWi5maWx0ZXIoY28sIHByZWZpeClcbiAgfVxuXG4gIC8qXG4gIGdldENvbXBsZXRpb25zRm9ySG9sZShidWZmZXIscHJlZml4LHBvc2l0aW9uKVxuICBHZXQgY29tcGxldGlvbnMgYmFzZWQgb24gZXhwcmVzc2lvbiB0eXBlLlxuICBJdCBpcyBhc3N1bWVkIHRoYXQgYHByZWZpeGAgc3RhcnRzIHdpdGggJ18nXG5cbiAgYnVmZmVyOiBUZXh0QnVmZmVyLCBjdXJyZW50IGJ1ZmZlclxuICBwcmVmaXg6IFN0cmluZywgY29tcGxldGlvbiBwcmVmaXhcbiAgcG9zaXRpb246IFBvaW50LCBjdXJyZW50IGN1cnNvciBwb3NpdGlvblxuXG4gIFJldHVybnM6IFByb21pc2UoW3N5bWJvbF0pXG4gIHN5bWJvbDogU2FtZSBhcyBnZXRDb21wbGV0aW9uc0ZvclN5bWJvbFxuICAqL1xuICBAaGFuZGxlRXhjZXB0aW9uXG4gIHB1YmxpYyBhc3luYyBnZXRDb21wbGV0aW9uc0ZvckhvbGUoXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLFxuICAgIHByZWZpeDogc3RyaW5nLFxuICAgIHBvc2l0aW9uOiBQb2ludCxcbiAgKTogUHJvbWlzZTxDQi5JU3ltYm9sW10+IHtcbiAgICBpZiAoIXRoaXMuaXNBY3RpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQmFja2VuZCBpbmFjdGl2ZScpXG4gICAgfVxuICAgIGNvbnN0IHJhbmdlID0gbmV3IFJhbmdlKHBvc2l0aW9uLCBwb3NpdGlvbilcbiAgICBpZiAocHJlZml4LnN0YXJ0c1dpdGgoJ18nKSkge1xuICAgICAgcHJlZml4ID0gcHJlZml4LnNsaWNlKDEpXG4gICAgfVxuICAgIGNvbnN0IHsgdHlwZSB9ID0gYXdhaXQgdGhpcy5wcm9jZXNzLmdldFR5cGVJbkJ1ZmZlcihidWZmZXIsIHJhbmdlKVxuICAgIGNvbnN0IHN5bWJvbHMgPSBhd2FpdCB0aGlzLmdldFN5bWJvbHNGb3JCdWZmZXIoYnVmZmVyKVxuICAgIGNvbnN0IHRzID0gc3ltYm9scy5maWx0ZXIoKHMpID0+IHtcbiAgICAgIGlmICghcy50eXBlU2lnbmF0dXJlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgICAgY29uc3QgdGwgPSBzLnR5cGVTaWduYXR1cmUuc3BsaXQoJyAtPiAnKS5zbGljZSgtMSlbMF1cbiAgICAgIGlmICh0bC5tYXRjaCgvXlthLXpdJC8pKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgICAgY29uc3QgdHMyID0gdGwucmVwbGFjZSgvWy4/KiteJFtcXF1cXFxcKCl7fXwtXS9nLCAnXFxcXCQmJylcbiAgICAgIGNvbnN0IHJ4ID0gUmVnRXhwKHRzMi5yZXBsYWNlKC9cXGJbYS16XVxcYi9nLCAnLisnKSwgJycpXG4gICAgICByZXR1cm4gcngudGVzdCh0eXBlKVxuICAgIH0pXG4gICAgaWYgKHByZWZpeC5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB0cy5zb3J0KFxuICAgICAgICAoYSwgYikgPT5cbiAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICAgIEZaLnNjb3JlKGIudHlwZVNpZ25hdHVyZSEsIHR5cGUpIC0gRlouc2NvcmUoYS50eXBlU2lnbmF0dXJlISwgdHlwZSksXG4gICAgICApXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBGWi5maWx0ZXIodHMsIHByZWZpeCwgeyBrZXk6ICdxbmFtZScgfSlcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFN5bWJvbHNGb3JCdWZmZXIoXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLFxuICAgIHN5bWJvbFR5cGVzPzogQ0IuU3ltYm9sVHlwZVtdLFxuICApOiBQcm9taXNlPENCLklTeW1ib2xbXT4ge1xuICAgIGNvbnN0IHsgYnVmZmVySW5mbyB9ID0gdGhpcy5nZXRCdWZmZXJJbmZvKHsgYnVmZmVyIH0pXG4gICAgY29uc3QgeyByb290RGlyLCBtb2R1bGVNYXAgfSA9IGF3YWl0IHRoaXMuZ2V0TW9kdWxlTWFwKHsgYnVmZmVySW5mbyB9KVxuICAgIGlmIChidWZmZXJJbmZvICYmIG1vZHVsZU1hcCkge1xuICAgICAgY29uc3QgaW1wb3J0cyA9IGF3YWl0IGJ1ZmZlckluZm8uZ2V0SW1wb3J0cygpXG4gICAgICBjb25zdCBwcm9taXNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBpbXBvcnRzLm1hcChhc3luYyAoaW1wKSA9PiB7XG4gICAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5nZXRNb2R1bGVJbmZvKHtcbiAgICAgICAgICAgIGJ1ZmZlckluZm8sXG4gICAgICAgICAgICBtb2R1bGVOYW1lOiBpbXAubmFtZSxcbiAgICAgICAgICAgIHJvb3REaXIsXG4gICAgICAgICAgICBtb2R1bGVNYXAsXG4gICAgICAgICAgfSlcbiAgICAgICAgICBpZiAoIXJlcykge1xuICAgICAgICAgICAgcmV0dXJuIFtdXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiByZXMubW9kdWxlSW5mby5zZWxlY3QoaW1wLCBzeW1ib2xUeXBlcylcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICByZXR1cm4gKFtdIGFzIHR5cGVvZiBwcm9taXNlc1swXSkuY29uY2F0KC4uLnByb21pc2VzKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEJ1ZmZlckluZm8oe1xuICAgIGJ1ZmZlcixcbiAgfToge1xuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlclxuICB9KTogeyBidWZmZXJJbmZvOiBCdWZmZXJJbmZvIH0ge1xuICAgIGxldCBiaSA9IHRoaXMuYnVmZmVyTWFwLmdldChidWZmZXIpXG4gICAgaWYgKCFiaSkge1xuICAgICAgYmkgPSBuZXcgQnVmZmVySW5mbyhidWZmZXIpXG4gICAgICB0aGlzLmJ1ZmZlck1hcC5zZXQoYnVmZmVyLCBiaSlcbiAgICB9XG4gICAgcmV0dXJuIHsgYnVmZmVySW5mbzogYmkgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRNb2R1bGVNYXAoe1xuICAgIGJ1ZmZlckluZm8sXG4gICAgcm9vdERpcixcbiAgfToge1xuICAgIGJ1ZmZlckluZm86IEJ1ZmZlckluZm9cbiAgICByb290RGlyPzogRGlyZWN0b3J5XG4gIH0pOiBQcm9taXNlPHsgcm9vdERpcjogRGlyZWN0b3J5OyBtb2R1bGVNYXA6IE1hcDxzdHJpbmcsIE1vZHVsZUluZm8+IH0+IHtcbiAgICBpZiAoIXJvb3REaXIpIHtcbiAgICAgIHJvb3REaXIgPSBhd2FpdCB0aGlzLnByb2Nlc3MuZ2V0Um9vdERpcihidWZmZXJJbmZvLmJ1ZmZlcilcbiAgICB9XG4gICAgbGV0IG1tID0gdGhpcy5kaXJNYXAuZ2V0KHJvb3REaXIpXG4gICAgaWYgKCFtbSkge1xuICAgICAgbW0gPSBuZXcgTWFwKClcbiAgICAgIHRoaXMuZGlyTWFwLnNldChyb290RGlyLCBtbSlcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcm9vdERpcixcbiAgICAgIG1vZHVsZU1hcDogbW0sXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRNb2R1bGVJbmZvKGFyZzoge1xuICAgIGJ1ZmZlckluZm86IEJ1ZmZlckluZm9cbiAgICBtb2R1bGVOYW1lPzogc3RyaW5nXG4gICAgcm9vdERpcj86IERpcmVjdG9yeVxuICAgIG1vZHVsZU1hcD86IE1hcDxzdHJpbmcsIE1vZHVsZUluZm8+XG4gIH0pIHtcbiAgICBjb25zdCB7IGJ1ZmZlckluZm8gfSA9IGFyZ1xuICAgIGxldCBkYXRcbiAgICBpZiAoYXJnLnJvb3REaXIgJiYgYXJnLm1vZHVsZU1hcCkge1xuICAgICAgZGF0ID0geyByb290RGlyOiBhcmcucm9vdERpciwgbW9kdWxlTWFwOiBhcmcubW9kdWxlTWFwIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZGF0ID0gYXdhaXQgdGhpcy5nZXRNb2R1bGVNYXAoeyBidWZmZXJJbmZvIH0pXG4gICAgfVxuICAgIGNvbnN0IHsgbW9kdWxlTWFwLCByb290RGlyIH0gPSBkYXRcbiAgICBsZXQgbW9kdWxlTmFtZSA9IGFyZy5tb2R1bGVOYW1lXG4gICAgaWYgKCFtb2R1bGVOYW1lKSB7XG4gICAgICBtb2R1bGVOYW1lID0gYXdhaXQgYnVmZmVySW5mby5nZXRNb2R1bGVOYW1lKClcbiAgICB9XG4gICAgaWYgKCFtb2R1bGVOYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5hbWVsZXNzIG1vZHVsZSBpbiAke2J1ZmZlckluZm8uYnVmZmVyLmdldFVyaSgpfWApXG4gICAgfVxuXG4gICAgbGV0IG1vZHVsZUluZm8gPSBtb2R1bGVNYXAuZ2V0KG1vZHVsZU5hbWUpXG4gICAgaWYgKCFtb2R1bGVJbmZvKSB7XG4gICAgICBtb2R1bGVJbmZvID0gbmV3IE1vZHVsZUluZm8obW9kdWxlTmFtZSwgdGhpcy5wcm9jZXNzLCByb290RGlyKVxuICAgICAgbW9kdWxlTWFwLnNldChtb2R1bGVOYW1lLCBtb2R1bGVJbmZvKVxuXG4gICAgICBjb25zdCBtbiA9IG1vZHVsZU5hbWVcbiAgICAgIG1vZHVsZUluZm8ub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgICAgbW9kdWxlTWFwLmRlbGV0ZShtbilcbiAgICAgICAgVXRpbC5kZWJ1ZyhgJHttb2R1bGVOYW1lfSByZW1vdmVkIGZyb20gbWFwYClcbiAgICAgIH0pXG4gICAgfVxuICAgIGF3YWl0IG1vZHVsZUluZm8uc2V0QnVmZmVyKGJ1ZmZlckluZm8pXG4gICAgcmV0dXJuIHsgYnVmZmVySW5mbywgcm9vdERpciwgbW9kdWxlTWFwLCBtb2R1bGVJbmZvLCBtb2R1bGVOYW1lIH1cbiAgfVxuXG4gIHByaXZhdGUgZmlsdGVyPFQsIEsgZXh0ZW5kcyBrZXlvZiBUPihcbiAgICBjYW5kaWRhdGVzOiBUW10sXG4gICAgcHJlZml4OiBzdHJpbmcsXG4gICAga2V5czogS1tdLFxuICApOiBUW10ge1xuICAgIGlmICghcHJlZml4KSB7XG4gICAgICByZXR1cm4gY2FuZGlkYXRlc1xuICAgIH1cbiAgICBjb25zdCBsaXN0ID0gW11cbiAgICBmb3IgKGNvbnN0IGNhbmRpZGF0ZSBvZiBjYW5kaWRhdGVzKSB7XG4gICAgICBjb25zdCBzY29yZXMgPSBrZXlzLm1hcCgoa2V5KSA9PiB7XG4gICAgICAgIGNvbnN0IGNrID0gY2FuZGlkYXRlW2tleV1cbiAgICAgICAgaWYgKGNrKSB7XG4gICAgICAgICAgcmV0dXJuIEZaLnNjb3JlKGNrLnRvU3RyaW5nKCksIHByZWZpeClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gMFxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgY29uc3Qgc2NvcmUgPSBNYXRoLm1heCguLi5zY29yZXMpXG4gICAgICBpZiAoc2NvcmUgPiAwKSB7XG4gICAgICAgIGxpc3QucHVzaCh7XG4gICAgICAgICAgc2NvcmUsXG4gICAgICAgICAgc2NvcmVOOiBzY29yZXMuaW5kZXhPZihzY29yZSksXG4gICAgICAgICAgZGF0YTogY2FuZGlkYXRlLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbGlzdFxuICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgY29uc3QgcyA9IGIuc2NvcmUgLSBhLnNjb3JlXG4gICAgICAgIGlmIChzID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIGEuc2NvcmVOIC0gYi5zY29yZU5cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc1xuICAgICAgfSlcbiAgICAgIC5tYXAoKHsgZGF0YSB9KSA9PiBkYXRhKVxuICB9XG59XG4iXX0=