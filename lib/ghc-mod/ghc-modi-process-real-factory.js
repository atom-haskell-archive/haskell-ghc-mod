"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Util = require("../util");
const ghc_modi_process_real_1 = require("./ghc-modi-process-real");
const build_stack_1 = require("./build-stack");
async function createGhcModiProcessReal(rootDir, upi) {
    let opts;
    let vers;
    let caps;
    let builder;
    try {
        if (upi && atom.config.get('haskell-ghc-mod.builderManagement')) {
            builder = await upi.getOthersConfigParam('ide-haskell-cabal', 'builder');
        }
        const bn = builder && builder.name;
        Util.debug(`Using builder ${bn}`);
        opts = await Util.getProcessOptions(rootDir.getPath());
        const versP = getVersion(opts);
        const bopts = opts;
        const shouldBuild = await checkComp(bopts, versP, bn).catch(async (e) => {
            if (e.code === 'ENOENT') {
                return askBuild(bn, `Atom couldn't find ghc-mod.`);
            }
            else {
                atom.notifications.addError('Failed to check compiler versions', {
                    detail: e.toString(),
                    stack: e.stack,
                    dismissable: true,
                });
                return false;
            }
        });
        if (shouldBuild) {
            const success = await build_stack_1.buildStack(bopts, upi);
            if (success) {
                return createGhcModiProcessReal(rootDir, upi);
            }
            else {
                atom.notifications.addWarning('Building ghc-mod failed, continuing as-is');
            }
        }
        vers = await versP;
        caps = getCaps(vers);
        return new ghc_modi_process_real_1.GhcModiProcessReal(caps, rootDir, opts);
    }
    catch (e) {
        const err = e;
        Util.notifySpawnFail({ dir: rootDir.getPath(), err, opts, vers, caps });
        throw e;
    }
}
exports.createGhcModiProcessReal = createGhcModiProcessReal;
function getCaps({ vers }) {
    const caps = {
        version: vers,
        fileMap: false,
        quoteArgs: false,
        optparse: false,
        typeConstraints: false,
        browseParents: false,
        interactiveCaseSplit: false,
        importedFrom: false,
        browseMain: false,
    };
    const atLeast = (x) => Util.versAtLeast(vers, x);
    const exact = (b) => {
        for (let i = 0; i < b.length; i++) {
            const v = b[i];
            if (vers[i] !== v) {
                return false;
            }
        }
        return true;
    };
    if (!atLeast([5, 4])) {
        atom.notifications.addError(`\
Haskell-ghc-mod: ghc-mod < 5.4 is not supported. \
Use at your own risk or update your ghc-mod installation`, { dismissable: true });
    }
    if (exact([5, 4])) {
        atom.notifications.addWarning(`\
Haskell-ghc-mod: ghc-mod 5.4.* is deprecated. \
Use at your own risk or update your ghc-mod installation`, { dismissable: true });
    }
    if (atLeast([5, 4])) {
        caps.fileMap = true;
    }
    if (atLeast([5, 5])) {
        caps.quoteArgs = true;
        caps.optparse = true;
    }
    if (atLeast([5, 6])) {
        caps.typeConstraints = true;
        caps.browseParents = true;
        caps.interactiveCaseSplit = true;
    }
    if (atom.config.get('haskell-ghc-mod.experimental')) {
        caps.importedFrom = true;
    }
    Util.debug(JSON.stringify(caps));
    return caps;
}
async function getVersion(opts) {
    const timeout = atom.config.get('haskell-ghc-mod.initTimeout') * 1000;
    const cmd = atom.config.get('haskell-ghc-mod.ghcModPath');
    const { stdout } = await Util.execPromise(cmd, ['version'], Object.assign({ timeout }, opts));
    const versRaw = /^ghc-mod version (\d+)\.(\d+)\.(\d+)(?:\.(\d+))?/.exec(stdout);
    if (!versRaw) {
        throw new Error("Couldn't get ghc-mod version");
    }
    const vers = versRaw.slice(1, 5).map((i) => parseInt(i, 10));
    const compRaw = /GHC (.+)$/.exec(stdout.trim());
    if (!compRaw) {
        throw new Error("Couldn't get ghc version");
    }
    const comp = compRaw[1];
    Util.debug(`Ghc-mod ${vers} built with ${comp}`);
    return { vers, comp };
}
async function checkComp(opts, versP, builder) {
    const { comp } = await versP;
    const timeout = atom.config.get('haskell-ghc-mod.initTimeout') * 1000;
    const tryWarn = async (cmd, args) => {
        try {
            return (await Util.execPromise(cmd, args, Object.assign({ timeout }, opts))).stdout.trim();
        }
        catch (error) {
            Util.warn(error);
            return undefined;
        }
    };
    const [stackghc, pathghc] = await Promise.all([
        tryWarn('stack', ['ghc', '--', '--numeric-version']),
        tryWarn('ghc', ['--numeric-version']),
    ]);
    Util.debug(`Stack GHC version ${stackghc}`);
    Util.debug(`Path GHC version ${pathghc}`);
    const warnStack = ['stack', undefined].includes(builder);
    const warnCabal = ['cabal', 'none', undefined].includes(builder);
    let shouldBuild = false;
    if (pathghc && (pathghc !== comp) && warnCabal) {
        shouldBuild = shouldBuild || await askBuild(builder, `\
GHC version in your PATH '${pathghc}' doesn't match with \
GHC version used to build ghc-mod '${comp}'. This can lead to \
problems when using Cabal or Plain projects`);
    }
    if (stackghc && (stackghc !== comp) && warnStack) {
        shouldBuild = shouldBuild || await askBuild(builder, `\
GHC version in your Stack '${stackghc}' doesn't match with \
GHC version used to build ghc-mod '${comp}'. This can lead to \
problems when using Stack projects.`);
    }
    return shouldBuild;
}
async function askBuild(builder, msg) {
    let buttons;
    return new Promise((resolve) => {
        let notif;
        if (builder === 'stack') {
            buttons = [{
                    className: 'icon icon-zap',
                    text: 'Build ghc-mod',
                    onDidClick() {
                        resolve(true);
                        notif && notif.dismiss();
                    },
                }, {
                    className: 'icon icon-x',
                    text: 'No thanks',
                    onDidClick() {
                        resolve(false);
                        notif && notif.dismiss();
                    },
                }];
        }
        const warn = `${msg} ${buttons ? 'Would you like to attempt building ghc-mod?' : ''}`;
        notif = atom.notifications.addWarning(warn, {
            dismissable: builder !== undefined,
            buttons,
        });
        Util.warn(msg);
        if (buttons) {
            const disp = notif.onDidDismiss(() => {
                disp.dispose();
                resolve(false);
            });
        }
        else {
            resolve(false);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2hjLW1vZGktcHJvY2Vzcy1yZWFsLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZ2hjLW1vZC9naGMtbW9kaS1wcm9jZXNzLXJlYWwtZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLGdDQUErQjtBQUMvQixtRUFBd0U7QUFHeEUsK0NBQTBDO0FBSW5DLEtBQUssbUNBQW1DLE9BQWtCLEVBQUUsR0FBNkI7SUFDOUYsSUFBSSxJQUE0QixDQUFBO0lBQ2hDLElBQUksSUFBNEIsQ0FBQTtJQUNoQyxJQUFJLElBQTRCLENBQUE7SUFDaEMsSUFBSSxPQUFxQyxDQUFBO0lBQ3pDLElBQUksQ0FBQztRQUNILEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVoRSxPQUFPLEdBQUcsTUFBTSxHQUFHLENBQUMsb0JBQW9CLENBQW1CLG1CQUFtQixFQUFFLFNBQVMsQ0FBQyxDQUFBO1FBQzVGLENBQUM7UUFDRCxNQUFNLEVBQUUsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQTtRQUNsQyxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBRWpDLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTtRQUN0RCxNQUFNLEtBQUssR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDOUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFBO1FBRWxCLE1BQU0sV0FBVyxHQUFHLE1BQU0sU0FBUyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFNLEVBQUUsRUFBRTtZQUMzRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFB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QSxTQUFTLEVBQUUsYUFBYTtvQkFDeEIsSUFBSSxFQUFFLFdBQVc7b0JBQ2pCLFVBQVU7d0JBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO3dCQUNkLEtBQUssSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUE7b0JBQzFCLENBQUM7aUJBQ0YsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUNELE1BQU0sSUFBSSxHQUFHLEdBQUcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsNkNBQTZDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFBO1FBQ3JGLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUU7WUFDMUMsV0FBVyxFQUFFLE9BQU8sS0FBSyxTQUFTO1lBQ2xDLE9BQU87U0FDUixDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ2QsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNaLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFO2dCQUNuQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7Z0JBQ2QsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ2hCLENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ2hCLENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBHSENNb2RDYXBzIH0gZnJvbSAnLi9pbnRlcmFjdGl2ZS1wcm9jZXNzJ1xuaW1wb3J0ICogYXMgVXRpbCBmcm9tICcuLi91dGlsJ1xuaW1wb3J0IHsgR2hjTW9kaVByb2Nlc3NSZWFsLCBSdW5PcHRpb25zIH0gZnJvbSAnLi9naGMtbW9kaS1wcm9jZXNzLXJlYWwnXG5pbXBvcnQgeyBEaXJlY3RvcnksIE5vdGlmaWNhdGlvbiB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBJVVBJSW5zdGFuY2UgfSBmcm9tICdhdG9tLWhhc2tlbGwtdXBpJ1xuaW1wb3J0IHsgYnVpbGRTdGFjayB9IGZyb20gJy4vYnVpbGQtc3RhY2snXG5cbmV4cG9ydCB0eXBlIEdIQ01vZFZlcnMgPSB7IHZlcnM6IG51bWJlcltdLCBjb21wOiBzdHJpbmcgfVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlR2hjTW9kaVByb2Nlc3NSZWFsKHJvb3REaXI6IERpcmVjdG9yeSwgdXBpOiBJVVBJSW5zdGFuY2UgfCB1bmRlZmluZWQpOiBQcm9taXNlPEdoY01vZGlQcm9jZXNzUmVhbD4ge1xuICBsZXQgb3B0czogUnVuT3B0aW9ucyB8IHVuZGVmaW5lZFxuICBsZXQgdmVyczogR0hDTW9kVmVycyB8IHVuZGVmaW5lZFxuICBsZXQgY2FwczogR0hDTW9kQ2FwcyB8IHVuZGVmaW5lZFxuICBsZXQgYnVpbGRlcjogeyBuYW1lOiBzdHJpbmcgfSB8IHVuZGVmaW5lZFxuICB0cnkge1xuICAgIGlmICh1cGkgJiYgYXRvbS5jb25maWcuZ2V0KCdoYXNrZWxsLWdoYy1tb2QuYnVpbGRlck1hbmFnZW1lbnQnKSkge1xuICAgICAgLy8gVE9ETzogdGhpcyBpcyB1c2VkIHR3aWNlLCB0aGUgc2Vjb25kIHRpbWUgaW4gZ2hjLW1vZC9pbmRleC50cywgc2hvdWxkIHByb2JhYmx5IGZpeCB0aGF0XG4gICAgICBidWlsZGVyID0gYXdhaXQgdXBpLmdldE90aGVyc0NvbmZpZ1BhcmFtPHsgbmFtZTogc3RyaW5nIH0+KCdpZGUtaGFza2VsbC1jYWJhbCcsICdidWlsZGVyJylcbiAgICB9XG4gICAgY29uc3QgYm4gPSBidWlsZGVyICYmIGJ1aWxkZXIubmFtZVxuICAgIFV0aWwuZGVidWcoYFVzaW5nIGJ1aWxkZXIgJHtibn1gKVxuICAgIC8vIFRPRE86IFNob3VsZCBwcmVmZXIgc3RhY2sgc2FuZGJveCB3aGVuIHVzaW5nIHN0YWNrIGFuZCBjYWJhbCBzYW5iZG94IHdoZW4gdXNpbmcgY2FiYWwhXG4gICAgb3B0cyA9IGF3YWl0IFV0aWwuZ2V0UHJvY2Vzc09wdGlvbnMocm9vdERpci5nZXRQYXRoKCkpXG4gICAgY29uc3QgdmVyc1AgPSBnZXRWZXJzaW9uKG9wdHMpXG4gICAgY29uc3QgYm9wdHMgPSBvcHRzXG4gICAgLy8gVE9ETzogdGhpcyBnZXRzIGNoZWNrZWQgb25seSBvbmNlLCBzaG91bGQgY2hlY2sgb24gZ2hjLW1vZCByZXN0YXJ0P1xuICAgIGNvbnN0IHNob3VsZEJ1aWxkID0gYXdhaXQgY2hlY2tDb21wKGJvcHRzLCB2ZXJzUCwgYm4pLmNhdGNoKGFzeW5jIChlOiBhbnkpID0+IHtcbiAgICAgIGlmIChlLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICAgIHJldHVybiBhc2tCdWlsZChibiwgYEF0b20gY291bGRuJ3QgZmluZCBnaGMtbW9kLmApXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoJ0ZhaWxlZCB0byBjaGVjayBjb21waWxlciB2ZXJzaW9ucycsIHtcbiAgICAgICAgICBkZXRhaWw6IGUudG9TdHJpbmcoKSxcbiAgICAgICAgICBzdGFjazogZS5zdGFjayxcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgfSlcbiAgICBpZiAoc2hvdWxkQnVpbGQpIHtcbiAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBidWlsZFN0YWNrKGJvcHRzLCB1cGkpXG4gICAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gY3JlYXRlR2hjTW9kaVByb2Nlc3NSZWFsKHJvb3REaXIsIHVwaSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKCdCdWlsZGluZyBnaGMtbW9kIGZhaWxlZCwgY29udGludWluZyBhcy1pcycpXG4gICAgICB9XG4gICAgfVxuICAgIHZlcnMgPSBhd2FpdCB2ZXJzUFxuICAgIGNhcHMgPSBnZXRDYXBzKHZlcnMpXG4gICAgcmV0dXJuIG5ldyBHaGNNb2RpUHJvY2Vzc1JlYWwoY2Fwcywgcm9vdERpciwgb3B0cylcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bnNhZmUtYW55XG4gICAgY29uc3QgZXJyOiBFcnJvciAmIHtjb2RlOiBhbnl9ID0gZVxuICAgIFV0aWwubm90aWZ5U3Bhd25GYWlsKHsgZGlyOiByb290RGlyLmdldFBhdGgoKSwgZXJyLCBvcHRzLCB2ZXJzLCBjYXBzIH0pXG4gICAgdGhyb3cgZVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldENhcHMoeyB2ZXJzIH06IHsgdmVyczogbnVtYmVyW10gfSk6IEdIQ01vZENhcHMge1xuICBjb25zdCBjYXBzOiBHSENNb2RDYXBzID0ge1xuICAgIHZlcnNpb246IHZlcnMsXG4gICAgZmlsZU1hcDogZmFsc2UsXG4gICAgcXVvdGVBcmdzOiBmYWxzZSxcbiAgICBvcHRwYXJzZTogZmFsc2UsXG4gICAgdHlwZUNvbnN0cmFpbnRzOiBmYWxzZSxcbiAgICBicm93c2VQYXJlbnRzOiBmYWxzZSxcbiAgICBpbnRlcmFjdGl2ZUNhc2VTcGxpdDogZmFsc2UsXG4gICAgaW1wb3J0ZWRGcm9tOiBmYWxzZSxcbiAgICBicm93c2VNYWluOiBmYWxzZSxcbiAgfVxuXG4gIGNvbnN0IGF0TGVhc3QgPSAoeDogbnVtYmVyW10pID0+IFV0aWwudmVyc0F0TGVhc3QodmVycywgeClcblxuICBjb25zdCBleGFjdCA9IChiOiBudW1iZXJbXSkgPT4ge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYi5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgdiA9IGJbaV1cbiAgICAgIGlmICh2ZXJzW2ldICE9PSB2KSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgaWYgKCFhdExlYXN0KFs1LCA0XSkpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXG4gICAgICBgXFxcbkhhc2tlbGwtZ2hjLW1vZDogZ2hjLW1vZCA8IDUuNCBpcyBub3Qgc3VwcG9ydGVkLiBcXFxuVXNlIGF0IHlvdXIgb3duIHJpc2sgb3IgdXBkYXRlIHlvdXIgZ2hjLW1vZCBpbnN0YWxsYXRpb25gLFxuICAgICAgeyBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgIClcbiAgfVxuICBpZiAoZXhhY3QoWzUsIDRdKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKFxuICAgICAgYFxcXG5IYXNrZWxsLWdoYy1tb2Q6IGdoYy1tb2QgNS40LiogaXMgZGVwcmVjYXRlZC4gXFxcblVzZSBhdCB5b3VyIG93biByaXNrIG9yIHVwZGF0ZSB5b3VyIGdoYy1tb2QgaW5zdGFsbGF0aW9uYCxcbiAgICAgIHsgZGlzbWlzc2FibGU6IHRydWUgfSxcbiAgICApXG4gIH1cbiAgaWYgKGF0TGVhc3QoWzUsIDRdKSkge1xuICAgIGNhcHMuZmlsZU1hcCA9IHRydWVcbiAgfVxuICBpZiAoYXRMZWFzdChbNSwgNV0pKSB7XG4gICAgY2Fwcy5xdW90ZUFyZ3MgPSB0cnVlXG4gICAgY2Fwcy5vcHRwYXJzZSA9IHRydWVcbiAgfVxuICBpZiAoYXRMZWFzdChbNSwgNl0pKSB7XG4gICAgY2Fwcy50eXBlQ29uc3RyYWludHMgPSB0cnVlXG4gICAgY2Fwcy5icm93c2VQYXJlbnRzID0gdHJ1ZVxuICAgIGNhcHMuaW50ZXJhY3RpdmVDYXNlU3BsaXQgPSB0cnVlXG4gIH1cbiAgaWYgKGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmV4cGVyaW1lbnRhbCcpKSB7XG4gICAgY2Fwcy5pbXBvcnRlZEZyb20gPSB0cnVlXG4gIH1cbiAgVXRpbC5kZWJ1ZyhKU09OLnN0cmluZ2lmeShjYXBzKSlcbiAgcmV0dXJuIGNhcHNcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VmVyc2lvbihvcHRzOiBVdGlsLkV4ZWNPcHRzKTogUHJvbWlzZTxHSENNb2RWZXJzPiB7XG4gIGNvbnN0IHRpbWVvdXQgPSBhdG9tLmNvbmZpZy5nZXQoJ2hhc2tlbGwtZ2hjLW1vZC5pbml0VGltZW91dCcpICogMTAwMFxuICBjb25zdCBjbWQgPSBhdG9tLmNvbmZpZy5nZXQoJ2hhc2tlbGwtZ2hjLW1vZC5naGNNb2RQYXRoJylcbiAgY29uc3QgeyBzdGRvdXQgfSA9IGF3YWl0IFV0aWwuZXhlY1Byb21pc2UoY21kLCBbJ3ZlcnNpb24nXSwgeyB0aW1lb3V0LCAuLi5vcHRzIH0pXG4gIGNvbnN0IHZlcnNSYXcgPSAvXmdoYy1tb2QgdmVyc2lvbiAoXFxkKylcXC4oXFxkKylcXC4oXFxkKykoPzpcXC4oXFxkKykpPy8uZXhlYyhzdGRvdXQpXG4gIGlmICghdmVyc1JhdykgeyB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZG4ndCBnZXQgZ2hjLW1vZCB2ZXJzaW9uXCIpIH1cbiAgY29uc3QgdmVycyA9IHZlcnNSYXcuc2xpY2UoMSwgNSkubWFwKChpKSA9PiBwYXJzZUludChpLCAxMCkpXG4gIGNvbnN0IGNvbXBSYXcgPSAvR0hDICguKykkLy5leGVjKHN0ZG91dC50cmltKCkpXG4gIGlmICghY29tcFJhdykgeyB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZG4ndCBnZXQgZ2hjIHZlcnNpb25cIikgfVxuICBjb25zdCBjb21wID0gY29tcFJhd1sxXVxuICBVdGlsLmRlYnVnKGBHaGMtbW9kICR7dmVyc30gYnVpbHQgd2l0aCAke2NvbXB9YClcbiAgcmV0dXJuIHsgdmVycywgY29tcCB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrQ29tcChvcHRzOiBVdGlsLkV4ZWNPcHRzLCB2ZXJzUDogUHJvbWlzZTxHSENNb2RWZXJzPiwgYnVpbGRlcjogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gIGNvbnN0IHsgY29tcCB9ID0gYXdhaXQgdmVyc1BcbiAgY29uc3QgdGltZW91dCA9IGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1naGMtbW9kLmluaXRUaW1lb3V0JykgKiAxMDAwXG4gIGNvbnN0IHRyeVdhcm4gPSBhc3luYyAoY21kOiBzdHJpbmcsIGFyZ3M6IHN0cmluZ1tdKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiAoYXdhaXQgVXRpbC5leGVjUHJvbWlzZShjbWQsIGFyZ3MsIHsgdGltZW91dCwgLi4ub3B0cyB9KSkuc3Rkb3V0LnRyaW0oKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBVdGlsLndhcm4oZXJyb3IpXG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgfVxuICB9XG4gIGNvbnN0IFtzdGFja2doYywgcGF0aGdoY10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgdHJ5V2Fybignc3RhY2snLCBbJ2doYycsICctLScsICctLW51bWVyaWMtdmVyc2lvbiddKSxcbiAgICB0cnlXYXJuKCdnaGMnLCBbJy0tbnVtZXJpYy12ZXJzaW9uJ10pLFxuICBdKVxuICBVdGlsLmRlYnVnKGBTdGFjayBHSEMgdmVyc2lvbiAke3N0YWNrZ2hjfWApXG4gIFV0aWwuZGVidWcoYFBhdGggR0hDIHZlcnNpb24gJHtwYXRoZ2hjfWApXG4gIGNvbnN0IHdhcm5TdGFjayA9IFsnc3RhY2snLCB1bmRlZmluZWRdLmluY2x1ZGVzKGJ1aWxkZXIpXG4gIGNvbnN0IHdhcm5DYWJhbCA9IFsnY2FiYWwnLCAnbm9uZScsIHVuZGVmaW5lZF0uaW5jbHVkZXMoYnVpbGRlcilcbiAgbGV0IHNob3VsZEJ1aWxkID0gZmFsc2VcbiAgaWYgKHBhdGhnaGMgJiYgKHBhdGhnaGMgIT09IGNvbXApICYmIHdhcm5DYWJhbCkge1xuICAgIHNob3VsZEJ1aWxkID0gc2hvdWxkQnVpbGQgfHwgYXdhaXQgYXNrQnVpbGQoYnVpbGRlciwgYFxcXG5HSEMgdmVyc2lvbiBpbiB5b3VyIFBBVEggJyR7cGF0aGdoY30nIGRvZXNuJ3QgbWF0Y2ggd2l0aCBcXFxuR0hDIHZlcnNpb24gdXNlZCB0byBidWlsZCBnaGMtbW9kICcke2NvbXB9Jy4gVGhpcyBjYW4gbGVhZCB0byBcXFxucHJvYmxlbXMgd2hlbiB1c2luZyBDYWJhbCBvciBQbGFpbiBwcm9qZWN0c2ApXG4gIH1cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8gc3RhY2sgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIGlmIChzdGFja2doYyAmJiAoc3RhY2tnaGMgIT09IGNvbXApICYmIHdhcm5TdGFjaykge1xuICAgIHNob3VsZEJ1aWxkID0gc2hvdWxkQnVpbGQgfHwgYXdhaXQgYXNrQnVpbGQoYnVpbGRlciwgYFxcXG5HSEMgdmVyc2lvbiBpbiB5b3VyIFN0YWNrICcke3N0YWNrZ2hjfScgZG9lc24ndCBtYXRjaCB3aXRoIFxcXG5HSEMgdmVyc2lvbiB1c2VkIHRvIGJ1aWxkIGdoYy1tb2QgJyR7Y29tcH0nLiBUaGlzIGNhbiBsZWFkIHRvIFxcXG5wcm9ibGVtcyB3aGVuIHVzaW5nIFN0YWNrIHByb2plY3RzLmApXG4gIH1cbiAgcmV0dXJuIHNob3VsZEJ1aWxkXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGFza0J1aWxkKGJ1aWxkZXI6IHN0cmluZyB8IHVuZGVmaW5lZCwgbXNnOiBzdHJpbmcpIHtcbiAgbGV0IGJ1dHRvbnM6IEFycmF5PHtcbiAgICBjbGFzc05hbWU/OiBzdHJpbmdcbiAgICB0ZXh0Pzogc3RyaW5nXG4gICAgb25EaWRDbGljaz8oZXZlbnQ6IE1vdXNlRXZlbnQpOiB2b2lkXG4gIH0+IHwgdW5kZWZpbmVkXG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlKSA9PiB7XG4gICAgbGV0IG5vdGlmOiBOb3RpZmljYXRpb25cbiAgICBpZiAoYnVpbGRlciA9PT0gJ3N0YWNrJykge1xuICAgICAgLy8gb2ZmZXIgdG8gYnVpbGQgZ2hjLW1vZFxuICAgICAgYnV0dG9ucyA9IFt7XG4gICAgICAgIGNsYXNzTmFtZTogJ2ljb24gaWNvbi16YXAnLFxuICAgICAgICB0ZXh0OiAnQnVpbGQgZ2hjLW1vZCcsXG4gICAgICAgIG9uRGlkQ2xpY2soKSB7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgICAgICAgIG5vdGlmICYmIG5vdGlmLmRpc21pc3MoKVxuICAgICAgICB9LFxuICAgICAgfSx7XG4gICAgICAgIGNsYXNzTmFtZTogJ2ljb24gaWNvbi14JyxcbiAgICAgICAgdGV4dDogJ05vIHRoYW5rcycsXG4gICAgICAgIG9uRGlkQ2xpY2soKSB7XG4gICAgICAgICAgcmVzb2x2ZShmYWxzZSlcbiAgICAgICAgICBub3RpZiAmJiBub3RpZi5kaXNtaXNzKClcbiAgICAgICAgfSxcbiAgICAgIH1dXG4gICAgfVxuICAgIGNvbnN0IHdhcm4gPSBgJHttc2d9ICR7YnV0dG9ucyA/ICdXb3VsZCB5b3UgbGlrZSB0byBhdHRlbXB0IGJ1aWxkaW5nIGdoYy1tb2Q/JyA6ICcnfWBcbiAgICBub3RpZiA9IGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKHdhcm4sIHtcbiAgICAgIGRpc21pc3NhYmxlOiBidWlsZGVyICE9PSB1bmRlZmluZWQsXG4gICAgICBidXR0b25zLFxuICAgIH0pXG4gICAgVXRpbC53YXJuKG1zZylcbiAgICBpZiAoYnV0dG9ucykge1xuICAgICAgY29uc3QgZGlzcCA9IG5vdGlmLm9uRGlkRGlzbWlzcygoKSA9PiB7XG4gICAgICAgIGRpc3AuZGlzcG9zZSgpXG4gICAgICAgIHJlc29sdmUoZmFsc2UpXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXNvbHZlKGZhbHNlKVxuICAgIH1cbiAgfSlcbn1cbiJdfQ==